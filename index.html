<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>BuildFlow Pro v4 ULTIMATE</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}

:root{
--blue:#007AFF;
--blue-dark:#0051D5;
--green:#34C759;
--green-dark:#248A3D;
--orange:#FF9500;
--orange-dark:#C93400;
--red:#FF3B30;
--red-dark:#D70015;
--purple:#5856D6;
--teal:#5AC8FA;
--pink:#FF2D55;
--yellow:#FFCC00;
--gray1:#F2F2F7;
--gray2:#E5E5EA;
--gray3:#D1D1D6;
--gray6:#8E8E93;
--dark:#1C1C1E;

/* Subtle gradients */
--gradient-blue:linear-gradient(135deg,#007AFF 0%,#0051D5 100%);
--gradient-green:linear-gradient(135deg,#34C759 0%,#248A3D 100%);
--gradient-orange:linear-gradient(135deg,#FF9500 0%,#C93400 100%);
--gradient-red:linear-gradient(135deg,#FF3B30 0%,#D70015 100%);

/* Professional shadows */
--shadow-sm:0 1px 3px rgba(0,0,0,0.06),0 1px 2px rgba(0,0,0,0.04);
--shadow-md:0 4px 6px rgba(0,0,0,0.07),0 2px 4px rgba(0,0,0,0.05);
--shadow-lg:0 10px 15px rgba(0,0,0,0.08),0 4px 6px rgba(0,0,0,0.05);
--shadow-button:0 4px 12px rgba(0,122,255,0.25);
}

body{
font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
background:#E8E8EA;
padding-bottom:75px;
-webkit-font-smoothing:antialiased;
-moz-osx-font-smoothing:grayscale;
color:#1C1C1E;
overflow-x:hidden;
line-height:1.5;
}

/* HEADER - Clean white background */
.header{
background:white;
border-bottom:1px solid rgba(0,0,0,0.08);
padding:12px 16px;
position:sticky;
top:0;
z-index:100;
display:flex;
justify-content:space-between;
align-items:center;
box-shadow:var(--shadow-sm);
}

.header-title{
font-size:20px;
font-weight:700;
letter-spacing:-0.5px;
color:#1C1C1E;
}

.header-subtitle{
font-size:13px;
color:#8E8E93;
margin-top:2px;
font-weight:500;
}

.header-btn{
background:#007AFF;
color:white;
border:none;
padding:8px 16px;
border-radius:10px;
font-size:14px;
font-weight:600;
cursor:pointer;
box-shadow:0 2px 6px rgba(0,122,255,0.25);
transition:all 0.2s ease;
}

.header-btn:active{
transform:scale(0.96);
opacity:0.9;
}

/* CONTAINER */
.container{
padding:14px 16px;
max-width:800px;
margin:0 auto;
}

/* TRIAL CARD - Blue gradient */
.trial{
background:linear-gradient(135deg,#007AFF,#5AC8FA);
border-radius:16px;
padding:24px 20px;
color:white;
text-align:center;
margin-bottom:14px;
box-shadow:0 4px 12px rgba(0,122,255,0.25);
}

.trial-days{
font-size:52px;
font-weight:700;
letter-spacing:-1.5px;
line-height:1;
}

.trial-text{
font-size:15px;
font-weight:500;
opacity:0.95;
margin-top:6px;
}

/* STATS - Clean cards */
.stats{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:10px;
margin-bottom:14px;
}

.stat{
background:white;
border-radius:14px;
padding:14px 8px;
text-align:center;
box-shadow:var(--shadow-sm);
cursor:pointer;
transition:all 0.2s ease;
border:1px solid rgba(0,0,0,0.04);
}

.stat:active{
transform:scale(0.96);
}

.stat-icon{
font-size:28px;
margin-bottom:6px;
}

.stat-value{
font-size:26px;
font-weight:700;
letter-spacing:-0.5px;
color:var(--blue);
}

.stat-label{
font-size:10px;
color:var(--gray6);
font-weight:600;
margin-top:4px;
text-transform:uppercase;
letter-spacing:0.3px;
}

/* SECTION - Lighter gray on dark background */
.section{
background:#F2F2F5;
border-radius:16px;
padding:16px;
margin-bottom:14px;
box-shadow:var(--shadow-sm);
border:1px solid rgba(0,0,0,0.08);
}

.section-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:12px;
}

.section-title{
font-size:17px;
font-weight:700;
letter-spacing:-0.3px;
color:#1C1C1E;
}

.add-btn{
background:var(--blue);
color:white;
border:none;
padding:7px 14px;
border-radius:8px;
font-size:13px;
font-weight:600;
cursor:pointer;
transition:all 0.2s ease;
}

.add-btn:active{
transform:scale(0.96);
}

/* MENU ITEMS - Clean white buttons */
.menu{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:8px;
}

.menu-item{
background:white;
border-radius:11px;
padding:10px 4px;
text-align:center;
cursor:pointer;
transition:all 0.2s ease;
min-height:68px;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
border:1px solid rgba(0,0,0,0.1);
box-shadow:0 1px 3px rgba(0,0,0,0.08);
}

.menu-item:active{
transform:scale(0.96);
background:#F5F5F5;
}

.menu-icon{
font-size:24px;
margin-bottom:4px;
line-height:1;
}

.menu-label{
font-size:10px;
font-weight:600;
letter-spacing:-0.2px;
line-height:1.2;
color:#1C1C1E;
}

/* SEARCH */
.search-box{
margin-bottom:12px;
}

.search-input{
width:100%;
padding:11px 14px;
border:1px solid var(--gray3);
border-radius:10px;
font-size:15px;
background:white;
transition:border-color 0.2s ease;
font-weight:400;
}

.search-input:focus{
outline:none;
border-color:var(--blue);
}

/* FILTERS */
.filters{
display:flex;
gap:8px;
margin-bottom:12px;
overflow-x:auto;
-webkit-overflow-scrolling:touch;
padding-bottom:4px;
}

.filter-btn{
background:white;
border:1px solid var(--gray3);
padding:7px 14px;
border-radius:10px;
font-size:13px;
font-weight:600;
white-space:nowrap;
cursor:pointer;
transition:all 0.2s ease;
color:#1C1C1E;
}

.filter-btn.active{
background:var(--blue);
color:white;
border-color:var(--blue);
}

.filter-btn:active{
transform:scale(0.96);
}

/* CARDS - Professional */
.card{
background:white;
border:1px solid rgba(0,0,0,0.08);
border-radius:12px;
padding:13px;
margin-bottom:9px;
cursor:pointer;
transition:all 0.2s ease;
box-shadow:var(--shadow-sm);
}

.card:active{
transform:scale(0.98);
}

.card-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:9px;
}

.card-title{
font-size:14px;
font-weight:700;
letter-spacing:-0.2px;
color:#1C1C1E;
}

.card-body{
font-size:13px;
line-height:1.5;
color:var(--gray6);
font-weight:500;
}

.card-body strong{
color:#1C1C1E;
font-weight:600;
}

/* BADGES - Clear colors */
.badge{
display:inline-block;
padding:4px 9px;
border-radius:7px;
font-size:10px;
font-weight:700;
text-transform:uppercase;
letter-spacing:0.3px;
}

.badge-pending{background:rgba(255,149,0,0.15);color:#CC7A00}
.badge-active{background:rgba(0,122,255,0.15);color:#0051D5}
.badge-delivered{background:rgba(52,199,89,0.15);color:#248A3D}
.badge-cancelled{background:rgba(255,59,48,0.15);color:#D70015}
.badge-expired{background:rgba(255,59,48,0.15);color:#D70015}
.badge-valid{background:rgba(52,199,89,0.15);color:#248A3D}
.badge-warning{background:rgba(255,149,0,0.15);color:#CC7A00}
.badge-vip{background:#FFD700;color:#1C1C1E;font-weight:700}

/* NAVIGATION - White background */
.nav{
position:fixed;
bottom:0;
left:0;
right:0;
background:white;
border-top:1px solid rgba(0,0,0,0.08);
display:grid;
grid-template-columns:repeat(5,1fr);
padding:8px 0 22px;
z-index:100;
box-shadow:0 -2px 10px rgba(0,0,0,0.05);
}

.nav-item{
text-align:center;
padding:6px 4px;
cursor:pointer;
color:#8E8E93;
transition:color 0.2s ease;
}

.nav-item.active{
color:#007AFF;
}

.nav-item:active{
opacity:0.6;
}

.nav-icon{
font-size:24px;
margin-bottom:3px;
}

.nav-label{
font-size:10px;
font-weight:600;
letter-spacing:0;
}

/* MODAL - Clean */
.modal{
position:fixed;
inset:0;
background:rgba(0,0,0,0.5);
display:flex;
align-items:flex-end;
z-index:999;
animation:fadeIn 0.2s ease;
}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.modal-content{
background:white;
border-radius:20px 20px 0 0;
width:100%;
max-height:90vh;
overflow-y:auto;
animation:slideUp 0.3s ease;
box-shadow:var(--shadow-lg);
}

@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

.modal-header{
padding:18px 20px;
border-bottom:1px solid rgba(0,0,0,0.08);
display:flex;
justify-content:space-between;
align-items:center;
position:sticky;
top:0;
background:white;
z-index:1;
}

.modal-title{
font-size:18px;
font-weight:700;
letter-spacing:-0.3px;
color:#1C1C1E;
}

.modal-close{
background:var(--gray1);
border:none;
font-size:19px;
color:var(--gray6);
cursor:pointer;
padding:0;
width:32px;
height:32px;
line-height:32px;
border-radius:50%;
transition:all 0.2s ease;
}

.modal-close:active{
transform:scale(0.9);
}

.modal-body{
padding:20px;
}

/* FORMS - Professional */
.form-group{
margin-bottom:18px;
}

label{
display:block;
font-size:14px;
font-weight:600;
margin-bottom:7px;
color:#1C1C1E;
}

input,select,textarea{
width:100%;
padding:12px 14px;
border:1px solid var(--gray3);
border-radius:10px;
font-size:15px;
font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
background:white;
transition:border-color 0.2s ease;
font-weight:400;
color:#1C1C1E;
}

input:focus,select:focus,textarea:focus{
outline:none;
border-color:var(--blue);
}

textarea{
min-height:90px;
resize:vertical;
}

/* BUTTONS - Clean gradients */
.btn{
width:100%;
background:var(--blue);
color:white;
border:none;
padding:14px;
border-radius:11px;
font-size:16px;
font-weight:600;
cursor:pointer;
margin-top:8px;
box-shadow:var(--shadow-button);
transition:all 0.2s ease;
}

.btn:active{
transform:scale(0.97);
opacity:0.9;
}

.btn-secondary{
background:var(--gray1);
color:#1C1C1E;
box-shadow:var(--shadow-sm);
}

.btn-danger{
background:var(--red);
box-shadow:0 4px 12px rgba(255,59,48,0.25);
}

.btn-success{
background:var(--green);
box-shadow:0 4px 12px rgba(52,199,89,0.25);
}

/* DETAIL SECTIONS */
.detail-section{
margin-bottom:22px;
}

.detail-title{
font-size:13px;
font-weight:700;
text-transform:uppercase;
color:var(--gray6);
margin-bottom:11px;
letter-spacing:0.5px;
}

.detail-row{
display:flex;
justify-content:space-between;
padding:11px 0;
border-bottom:1px solid rgba(0,0,0,0.05);
}

.detail-label{
font-size:14px;
color:var(--gray6);
font-weight:500;
}

.detail-value{
font-size:14px;
font-weight:600;
text-align:right;
max-width:60%;
word-break:break-word;
color:#1C1C1E;
}

/* AUTH - Professional */
.auth{
min-height:100vh;
background:linear-gradient(135deg,#000 0%,#1C1C1E 100%);
display:flex;
align-items:center;
justify-content:center;
padding:20px;
}

.auth-box{
background:white;
border-radius:24px;
padding:44px 30px;
max-width:360px;
width:100%;
box-shadow:var(--shadow-lg);
}

.auth-logo{
font-size:68px;
text-align:center;
margin-bottom:22px;
}

.auth-title{
font-size:30px;
font-weight:700;
text-align:center;
margin-bottom:8px;
letter-spacing:-0.8px;
color:var(--blue);
}

.auth-subtitle{
text-align:center;
color:var(--gray6);
margin-bottom:30px;
font-size:15px;
font-weight:500;
}

.link{
text-align:center;
margin-top:18px;
color:var(--blue);
font-size:15px;
cursor:pointer;
font-weight:600;
}

.link:active{
opacity:0.7;
}

/* UTILITIES */
.hidden{display:none!important}

.empty{
text-align:center;
padding:44px 22px;
color:var(--gray6);
}

.empty-icon{
font-size:60px;
margin-bottom:14px;
opacity:0.35;
}

.empty-text{
font-size:16px;
font-weight:600;
}

.toast{
position:fixed;
top:65px;
left:50%;
transform:translateX(-50%);
background:rgba(0,0,0,0.92);
color:white;
padding:13px 22px;
border-radius:12px;
font-size:14px;
font-weight:600;
z-index:9999;
animation:fadeIn 0.25s ease;
max-width:90%;
box-shadow:var(--shadow-lg);
}

.category-section{
margin-bottom:22px;
}

.category-title{
font-size:13px;
font-weight:700;
color:var(--gray6);
margin-bottom:9px;
text-transform:uppercase;
letter-spacing:0.5px;
}

.tabs{
display:flex;
gap:8px;
margin-bottom:12px;
overflow-x:auto;
-webkit-overflow-scrolling:touch;
}

.tab{
background:white;
border:1px solid var(--gray3);
padding:9px 18px;
border-radius:10px;
font-size:14px;
font-weight:600;
cursor:pointer;
white-space:nowrap;
transition:all 0.2s ease;
color:#1C1C1E;
}

.tab.active{
background:var(--blue);
color:white;
border-color:var(--blue);
}

.tab:active{
transform:scale(0.96);
}

/* ALERTS - Clear colors */
.alert{
padding:13px 16px;
border-radius:11px;
margin-bottom:12px;
font-size:14px;
font-weight:600;
border-left:3px solid;
}

.alert-warning{
background:rgba(255,149,0,0.12);
border-color:#CC7A00;
color:#CC7A00;
}

.alert-danger{
background:rgba(255,59,48,0.12);
border-color:#D70015;
color:#D70015;
}

.alert-success{
background:rgba(52,199,89,0.12);
border-color:#248A3D;
color:#248A3D;
}

.alert-info{
background:rgba(0,122,255,0.12);
border-color:#0051D5;
color:#0051D5;
}

/* GPS MAP STYLES */
#gpsMap{
height:400px;
width:100%;
border-radius:12px;
margin-bottom:16px;
z-index:1;
}

.vehicle-marker{
background:white;
border:2px solid var(--blue);
border-radius:50%;
width:32px;
height:32px;
display:flex;
align-items:center;
justify-content:center;
font-size:16px;
box-shadow:0 2px 8px rgba(0,0,0,0.15);
}

.vehicle-popup{
min-width:200px;
}

.vehicle-popup h4{
margin:0 0 8px;
font-size:14px;
font-weight:700;
}

.vehicle-popup p{
margin:4px 0;
font-size:12px;
}

.route-controls{
display:flex;
gap:8px;
margin-bottom:12px;
flex-wrap:wrap;
}

.route-btn{
background:white;
border:1px solid var(--gray3);
padding:8px 14px;
border-radius:8px;
font-size:13px;
font-weight:600;
cursor:pointer;
transition:all 0.2s ease;
}

.route-btn:active{
transform:scale(0.96);
}

.route-btn.active{
background:var(--blue);
color:white;
border-color:var(--blue);
}

.waybill-card{
background:white;
border:2px solid var(--blue);
border-radius:12px;
padding:16px;
margin-bottom:12px;
}

.waybill-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:12px;
padding-bottom:12px;
border-bottom:2px dashed var(--gray3);
}

.waybill-title{
font-size:16px;
font-weight:700;
color:var(--blue);
}

.waybill-number{
font-size:12px;
color:var(--gray6);
font-weight:600;
}

.waybill-row{
display:flex;
justify-content:space-between;
padding:8px 0;
border-bottom:1px solid var(--gray2);
}

.waybill-row:last-child{
border-bottom:none;
font-weight:700;
background:rgba(0,122,255,0.05);
margin:8px -16px -16px;
padding:12px 16px;
}

.waybill-label{
font-size:13px;
color:var(--gray6);
}

.waybill-value{
font-size:13px;
font-weight:600;
color:var(--dark);
}
</style>
</head>
<body>
<div id="app"></div>
<script>

// ========== AUTH MODULE ==========
const Auth={
user:null,company:null,trial:null,
version:'4.0.0-production',
init(){
// Set version if not present, but don't clear data
const savedVersion=localStorage.getItem('bfv4_version');
if(!savedVersion){
localStorage.setItem('bfv4_version',this.version);
}else if(savedVersion!==this.version){
localStorage.setItem('bfv4_version',this.version);
}

const u=localStorage.getItem('bfv4_user');
if(u){try{
this.user=JSON.parse(u);
this.company=JSON.parse(localStorage.getItem('bfv4_company')||'{}');
this.trial=JSON.parse(localStorage.getItem('bfv4_trial')||'{}');
}catch(e){console.error('Auth load error:',e)}}
},
clearAllData(){
// Clear ALL localStorage
const keys=Object.keys(localStorage);
keys.forEach(key=>{
if(key.startsWith('bfv4_')||key==='company'){
localStorage.removeItem(key);
}
});
// Reset auth
this.user=null;
this.company=null;
this.trial=null;
},
register(email,password,companyName){
this.user={id:'U'+Date.now(),email,password,name:email.split('@')[0],role:'OWNER',created:new Date().toISOString()};
this.company={
id:'C'+Date.now(),
name:companyName,
eik:'',
vat:'',
mol:'',
address:'',
phone:'',
email:email,
logo:'',
currency:'BGN',
language:'bg',
theme:'light',
vatEnabled:true,
invoicePrefix:'INV',
invoiceStart:1,
created:new Date().toISOString()
};
this.trial={start:new Date().toISOString(),days:7,active:true};
localStorage.setItem('bfv4_user',JSON.stringify(this.user));
localStorage.setItem('bfv4_company',JSON.stringify(this.company));
localStorage.setItem('bfv4_trial',JSON.stringify(this.trial));
return true;
},
login(email,password){
// Owner login - BACKWARDS COMPATIBLE
const u=localStorage.getItem('bfv4_user');
if(u){
const user=JSON.parse(u);
// Check email first
if(user.email===email){
// If user has password (new accounts), check it
if(user.password){
if(user.password===password){
this.user=user;
this.company=JSON.parse(localStorage.getItem('bfv4_company')||'{}');
this.trial=JSON.parse(localStorage.getItem('bfv4_trial')||'{}');
return {success:true,role:'OWNER'};
}
} else {
// Old account without password - allow login with email only
this.user=user;
// Save password for future logins
this.user.password=password;
localStorage.setItem('bfv4_user',JSON.stringify(this.user));
this.company=JSON.parse(localStorage.getItem('bfv4_company')||'{}');
this.trial=JSON.parse(localStorage.getItem('bfv4_trial')||'{}');
return {success:true,role:'OWNER'};
}
}
}

// Driver login
const staffData=localStorage.getItem('bfv4_staff');
if(staffData){
const staff=JSON.parse(staffData);
// Try to find driver with email and password
let driver=staff.find(s=>
s.driverEmail===email&&
s.driverPassword===password&&
s.position==='–®–æ—Ñ—å–æ—Ä'
);
// If not found, try without password (old drivers)
if(!driver){
driver=staff.find(s=>
s.driverEmail===email&&
s.position==='–®–æ—Ñ—å–æ—Ä'
);
// If found, save password for next time
if(driver){
driver.driverPassword=password;
localStorage.setItem('bfv4_staff',JSON.stringify(staff));
}
}
if(driver){
this.user={
id:driver.id,
email:driver.driverEmail,
name:driver.name,
role:'DRIVER',
staffId:driver.id
};
this.company=JSON.parse(localStorage.getItem('bfv4_company')||'{}');
return {success:true,role:'DRIVER'};
}
}

return {success:false};
},
logout(){
if(confirm('–ò–∑–ª–µ–∑ –æ—Ç –ø—Ä–æ—Ñ–∏–ª–∞?')){
this.user=null;this.company=null;this.trial=null;
return true;
}
return false;
},
trialDays(){
if(!this.trial||!this.trial.start)return 7;
const start=new Date(this.trial.start);
const now=new Date();
const daysPassed=Math.floor((now-start)/86400000);
return Math.max(0,this.trial.days-daysPassed);
}
};

// ========== DATA STORAGE MODULE ==========
const DS={
d:{
orders:[],clients:[],suppliers:[],staff:[],vehicles:[],deliveries:[],
warehouses:[],inventory:[],materials:[],
invoices:[],payments:[],expenses:[],revenues:[],receivables:[],
insurances:[],technicalInspections:[],services:[],vignettes:[],gpsLocations:[],
contracts:[],payrolls:[],leaves:[],documents:[],
notifications:[],activityLog:[],settings:{}
},
init(){
this.load();
this.checkExpiring();
},
load(){
Object.keys(this.d).forEach(k=>{
const s=localStorage.getItem('bfv4_'+k);
if(s)try{this.d[k]=JSON.parse(s)}catch(e){console.error('Load error:',k,e)}
});
},
save(key){
localStorage.setItem('bfv4_'+key,JSON.stringify(this.d[key]));
},
saveAll(){
Object.keys(this.d).forEach(k=>this.save(k));
},
find(type,id){
return this.d[type]?.find(x=>x.id===id);
},
add(type,item){
const prefixes={
orders:'ORD',clients:'CLI',suppliers:'SUP',staff:'STF',vehicles:'VEH',
deliveries:'DEL',warehouses:'WH',inventory:'INV',materials:'MAT',
invoices:'INV',payments:'PAY',expenses:'EXP',revenues:'REV',receivables:'REC',
insurances:'INS',technicalInspections:'TI',services:'SRV',vignettes:'VIG',
gpsLocations:'GPS',contracts:'CON',payrolls:'SAL',leaves:'LEV',documents:'DOC'
};
const prefix=prefixes[type]||'ITM';

// Generate unique ID using timestamp + random + counter
if(!item.id){
const timestamp=Date.now();
const random=Math.floor(Math.random()*1000);
const counter=this.d[type].length;
item.id=`${prefix}-${timestamp}-${random}-${counter}`;
}

item.created=new Date().toISOString();
this.d[type].push(item);
this.save(type);
this.log('add',type,item.id);
return item;
},
update(type,id,updates){
const idx=this.d[type].findIndex(x=>x.id===id);
if(idx>-1){
this.d[type][idx]={...this.d[type][idx],...updates,updated:new Date().toISOString()};
this.save(type);
this.log('update',type,id);
return this.d[type][idx];
}
return null;
},
delete(type,id){
const beforeLength=this.d[type].length;
this.d[type]=this.d[type].filter(x=>x.id!==id);
const afterLength=this.d[type].length;

// Verify deletion occurred
if(beforeLength===afterLength){
return false;
}

// Save to localStorage
this.save(type);

// Force reload from localStorage to ensure consistency
const saved=localStorage.getItem('bfv4_'+type);
if(saved){
try{
this.d[type]=JSON.parse(saved);
}catch(e){
console.error('Reload error after delete:',type,e);
}
}

this.log('delete',type,id);
return true;
},
log(action,type,id){
if(!this.d.activityLog)this.d.activityLog=[];
this.d.activityLog.push({
id:'LOG-'+Date.now(),
action,type,itemId:id,
user:Auth.user?.email||'system',
timestamp:new Date().toISOString()
});
if(this.d.activityLog.length>100)this.d.activityLog=this.d.activityLog.slice(-100);
this.save('activityLog');
},
checkExpiring(){
const now=new Date();
const newNotifications=[];

// Check insurances
this.d.insurances.forEach(ins=>{
const end=new Date(ins.endDate);
const days=Math.floor((end-now)/86400000);

// EXPIRED (already passed)
if(days<0){
const msg=`${ins.vehicle} - –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∏–∑—Ç–µ–∫–ª–∞ –ø—Ä–µ–¥–∏ ${Math.abs(days)} –¥–Ω–∏`;
const exists=this.d.notifications.some(n=>n.message===msg&&!n.read);
if(!exists){
newNotifications.push({
type:'danger',
title:'üî¥ –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ò–ó–¢–ï–ö–õ–ê!',
message:msg,
date:new Date().toISOString(),
read:false
});
}
}
// EXPIRING SOON (within 30 days)
else if(days>=0&&days<30){
const msg=`${ins.vehicle} - –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∏–∑—Ç–∏—á–∞ —Å–ª–µ–¥ ${days} –¥–Ω–∏`;
const exists=this.d.notifications.some(n=>n.message===msg&&!n.read);
if(!exists){
newNotifications.push({
type:'warning',
title:'‚ö†Ô∏è –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∏–∑—Ç–∏—á–∞ —Å–∫–æ—Ä–æ',
message:msg,
date:new Date().toISOString(),
read:false
});
}
}
});

// Check technical inspections
this.d.technicalInspections.forEach(ti=>{
const end=new Date(ti.nextInspectionDate);
const days=Math.floor((end-now)/86400000);

if(days<0){
const msg=`${ti.vehicle} - –¢–ü –∏–∑—Ç–µ–∫—ä–ª –ø—Ä–µ–¥–∏ ${Math.abs(days)} –¥–Ω–∏`;
const exists=this.d.notifications.some(n=>n.message===msg&&!n.read);
if(!exists){
newNotifications.push({
type:'danger',
title:'üî¥ –¢–ü –ò–ó–¢–ï–ö–™–õ!',
message:msg,
date:new Date().toISOString(),
read:false
});
}
}
else if(days>=0&&days<60){
const msg=`${ti.vehicle} - –¢–ü –∏–∑—Ç–∏—á–∞ —Å–ª–µ–¥ ${days} –¥–Ω–∏`;
const exists=this.d.notifications.some(n=>n.message===msg&&!n.read);
if(!exists){
newNotifications.push({
type:'warning',
title:'‚ö†Ô∏è –¢–ü –∏–∑—Ç–∏—á–∞ —Å–∫–æ—Ä–æ',
message:msg,
date:new Date().toISOString(),
read:false
});
}
}
});

// Check vignettes
this.d.vignettes.forEach(vig=>{
const end=new Date(vig.endDate);
const days=Math.floor((end-now)/86400000);

if(days<0){
const msg=`${vig.vehicle} - ${vig.country} –≤–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–µ–∫–ª–∞ –ø—Ä–µ–¥–∏ ${Math.abs(days)} –¥–Ω–∏`;
const exists=this.d.notifications.some(n=>n.message===msg&&!n.read);
if(!exists){
newNotifications.push({
type:'danger',
title:'üî¥ –í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–µ–∫–ª–∞!',
message:msg,
date:new Date().toISOString(),
read:false
});
}
}
else if(days>=0&&days<30){
const msg=`${vig.vehicle} - ${vig.country} –≤–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞ —Å–ª–µ–¥ ${days} –¥–Ω–∏`;
const exists=this.d.notifications.some(n=>n.message===msg&&!n.read);
if(!exists){
newNotifications.push({
type:'warning',
title:'‚ö†Ô∏è –í–∏–Ω–µ—Ç–∫–∞ –∏–∑—Ç–∏—á–∞ —Å–∫–æ—Ä–æ',
message:msg,
date:new Date().toISOString(),
read:false
});
}
}
});

// Check driver licenses
this.d.staff.filter(s=>s.position==='–®–æ—Ñ—å–æ—Ä'&&s.status==='active'&&s.licenseExpiry).forEach(driver=>{
const expiry=new Date(driver.licenseExpiry);
const days=Math.floor((expiry-now)/86400000);

if(days<0){
const msg=`${driver.name} - —à–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞ –∏–∑—Ç–µ–∫–ª–∞ –ø—Ä–µ–¥–∏ ${Math.abs(days)} –¥–Ω–∏`;
const exists=this.d.notifications.some(n=>n.message===msg&&!n.read);
if(!exists){
newNotifications.push({
type:'danger',
title:'üî¥ –®–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞ –ò–ó–¢–ï–ö–õ–ê!',
message:msg,
date:new Date().toISOString(),
read:false
});
}
}
else if(days>=0&&days<30){
const msg=`${driver.name} - —à–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞ –∏–∑—Ç–∏—á–∞ —Å–ª–µ–¥ ${days} –¥–Ω–∏`;
const exists=this.d.notifications.some(n=>n.message===msg&&!n.read);
if(!exists){
newNotifications.push({
type:'warning',
title:'‚ö†Ô∏è –®–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞ –∏–∑—Ç–∏—á–∞ —Å–∫–æ—Ä–æ',
message:msg,
date:new Date().toISOString(),
read:false
});
}
}
});

// Add all new notifications
newNotifications.forEach(n=>this.add('notifications',n));
},
demo(){
// Demo data removed for production use
// Start with clean database
console.log("‚úÖ BuildFlow Pro v4 - Clean database ready");
}
};

// ========== GPS TRACKER MODULE (REAL GPS FROM DRIVER PHONES) ==========
const GPSTracker={
currentDriver:null,
trackingInterval:null,
isTracking:false,
updateFrequency:30000, // 30 seconds
positions:[],

init(){
console.log('üõ∞Ô∏è GPS Tracker initialized');
// Check if driver is logged in
this.checkDriverMode();
// Load saved positions
this.loadPositions();
},

checkDriverMode(){
// Check if current user is a driver
const user=Auth.user;
if(user&&user.role==='driver'){
this.currentDriver=user;
this.showTrackingPrompt();
}
},

showTrackingPrompt(){
// Ask driver to enable tracking
if(confirm('–ò—Å–∫–∞—à –ª–∏ –¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–∞—à GPS tracking? –ü–æ–∑–∏—Ü–∏—è—Ç–∞ —Ç–∏ —â–µ —Å–µ —Å–ø–æ–¥–µ–ª—è —Å –¥–∏—Å–ø–µ—á–µ—Ä–∞.')){
this.startTracking();
}
},

startTracking(){
if(!navigator.geolocation){
UI.toast('‚ùå GPS –Ω–µ –µ –Ω–∞–ª–∏—á–µ–Ω –Ω–∞ —Ç–æ–≤–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ');
return;
}

this.isTracking=true;
console.log('üü¢ GPS Tracking started');
UI.toast('üõ∞Ô∏è GPS tracking –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω');

// Enable background mode if available
if(window.cordova&&cordova.plugins&&cordova.plugins.backgroundMode){
cordova.plugins.backgroundMode.enable();
cordova.plugins.backgroundMode.on('activate',()=>{
cordova.plugins.backgroundMode.disableWebViewOptimizations();
});
console.log('üì± Background mode enabled');
}

// Start tracking immediately
this.trackPosition();

// Set interval for continuous tracking
this.trackingInterval=setInterval(()=>{
this.trackPosition();
},this.updateFrequency);

// Save tracking state
localStorage.setItem('gps_tracking_active','true');
},

stopTracking(){
this.isTracking=false;
if(this.trackingInterval){
clearInterval(this.trackingInterval);
this.trackingInterval=null;
}

// Disable background mode
if(window.cordova&&cordova.plugins&&cordova.plugins.backgroundMode){
cordova.plugins.backgroundMode.disable();
}

localStorage.removeItem('gps_tracking_active');
console.log('üî¥ GPS Tracking stopped');
UI.toast('üõ∞Ô∏è GPS tracking –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–∞–Ω');
},

trackPosition(){
const options={
enableHighAccuracy:true,
timeout:10000,
maximumAge:0
};

navigator.geolocation.getCurrentPosition(
(position)=>this.onPositionSuccess(position),
(error)=>this.onPositionError(error),
options
);
},

onPositionSuccess(position){
const data={
id:'GPS-'+Date.now(),
timestamp:new Date().toISOString(),
latitude:position.coords.latitude,
longitude:position.coords.longitude,
accuracy:position.coords.accuracy,
altitude:position.coords.altitude,
speed:position.coords.speed,
heading:position.coords.heading,
driver:this.currentDriver?.email||Auth.user?.email||'unknown',
driverId:this.currentDriver?.id||Auth.user?.id||'unknown',
deviceId:this.getDeviceId()
};

// Add to local storage
this.positions.push(data);
this.savePositions();

// Try to sync to server/other devices
this.syncPosition(data);

console.log('üìç Position recorded:',data.latitude,data.longitude);
},

onPositionError(error){
console.error('GPS Error:',error.message);
// Continue tracking despite errors
},

getDeviceId(){
if(window.device&&window.device.uuid){
return window.device.uuid;
}
// Fallback: generate and save persistent ID
let id=localStorage.getItem('device_id');
if(!id){
id='DEV-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);
localStorage.setItem('device_id',id);
}
return id;
},

savePositions(){
// Keep only last 1000 positions to avoid storage limits
if(this.positions.length>1000){
this.positions=this.positions.slice(-1000);
}
localStorage.setItem('gps_positions',JSON.stringify(this.positions));
},

loadPositions(){
const saved=localStorage.getItem('gps_positions');
if(saved){
try{
this.positions=JSON.parse(saved);
console.log('üìç Loaded',this.positions.length,'GPS positions');
}catch(e){
console.error('GPS load error:',e);
this.positions=[];
}
}
},

syncPosition(data){
// OPTION 1: Simple sync via localStorage (same device, multiple users)
// Already handled by savePositions()

// OPTION 2: Sync to cloud (Firebase, your backend, etc)
// Uncomment and configure when you have backend:
/*
fetch('https://your-backend.com/api/gps/position', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify(data)
}).then(r=>console.log('‚úÖ Synced to server'))
.catch(e=>console.error('‚ùå Sync failed:',e));
*/

// OPTION 3: P2P sync via Bluetooth/WiFi Direct
// Requires additional Cordova plugins

// For now, just broadcast to other app instances via localStorage events
try{
localStorage.setItem('gps_latest_position',JSON.stringify(data));
window.dispatchEvent(new Event('gps_position_update'));
}catch(e){
console.error('Broadcast error:',e);
}
},

getAllPositions(){
return this.positions;
},

getPositionsByDriver(driverId){
return this.positions.filter(p=>p.driverId===driverId);
},

getRecentPositions(minutes=60){
const cutoff=new Date(Date.now()-minutes*60*1000).toISOString();
return this.positions.filter(p=>p.timestamp>=cutoff);
},

calculateDistance(lat1,lon1,lat2,lon2){
// Haversine formula
const R=6371; // Earth radius in km
const dLat=(lat2-lat1)*Math.PI/180;
const dLon=(lon2-lon1)*Math.PI/180;
const a=Math.sin(dLat/2)*Math.sin(dLat/2)+
        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
        Math.sin(dLon/2)*Math.sin(dLon/2);
const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
return R*c;
},

calculateTotalDistance(positions){
if(positions.length<2)return 0;

let total=0;
for(let i=1;i<positions.length;i++){
const prev=positions[i-1];
const curr=positions[i];
total+=this.calculateDistance(
prev.latitude,prev.longitude,
curr.latitude,curr.longitude
);
}
return total;
},

getTodayDistance(driverId){
const today=new Date().toISOString().split('T')[0];
const todayPositions=this.positions.filter(p=>
p.driverId===driverId&&
p.timestamp.startsWith(today)
);
return this.calculateTotalDistance(todayPositions);
},

// Listen for position updates from other devices/drivers
listenForUpdates(callback){
window.addEventListener('storage',(e)=>{
if(e.key==='gps_latest_position'&&e.newValue){
try{
const position=JSON.parse(e.newValue);
callback(position);
}catch(err){
console.error('Position parse error:',err);
}
}
});

// Also listen to custom event
window.addEventListener('gps_position_update',()=>{
const latest=localStorage.getItem('gps_latest_position');
if(latest){
try{
callback(JSON.parse(latest));
}catch(err){
console.error('Position parse error:',err);
}
}
});
}
};

// ========== UI HELPERS ==========
const UI={
toast(msg,duration=3000){
const t=document.createElement('div');
t.className='toast';
t.textContent=msg;
document.body.appendChild(t);
setTimeout(()=>t.remove(),duration);
},
modal(html){
const existing=document.getElementById('modal');
if(existing)existing.remove();
const m=document.createElement('div');
m.id='modal';
m.className='modal';
m.innerHTML=html;
m.onclick=e=>{if(e.target===m)this.closeModal()};
document.body.appendChild(m);
},
closeModal(){
const m=document.getElementById('modal');
if(m)m.remove();
},
confirm(msg,onYes){
window._confirmCallback=onYes;
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<p style="font-size:15px;margin-bottom:20px;color:var(--gray6);white-space:pre-line">${msg}</p>
<button class="btn btn-danger" onclick="UI.closeModal();if(window._confirmCallback){window._confirmCallback();delete window._confirmCallback;}">–î–∞, –∏–∑—Ç—Ä–∏–π</button>
<button class="btn btn-secondary" onclick="UI.closeModal();delete window._confirmCallback">–û—Ç–∫–∞–∂–∏</button>
</div>
</div>`;
this.modal(html);
},
empty(icon,title,subtitle){
return `<div class="empty"><div class="empty-icon">${icon}</div><div class="empty-text">${title}</div>${subtitle?'<div style="font-size:13px;margin-top:8px;color:var(--gray6)">'+subtitle+'</div>':''}</div>`;
}
};

// ========== APP MODULE ==========
const App={
page:'login',
searchQuery:'',
filterStatus:'all',
activeTab:'all',

init(){
Auth.init();
DS.init();
setTimeout(()=>{
Auth.user?this.navigate('dashboard'):this.navigate('login');
},500);
},

navigate(page,param){
this.page=page;
this.param=param;
this.searchQuery='';
this.filterStatus='all';
this.activeTab='all';
this.render();
window.scrollTo(0,0);
},

// Cyrillic to Latin transliteration
transliterate(text){
const map={
'–∞':'a','–±':'b','–≤':'v','–≥':'g','–¥':'d','–µ':'e','—ë':'e','–∂':'zh','–∑':'z','–∏':'i','–π':'y',
'–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u',
'—Ñ':'f','—Ö':'h','—Ü':'ts','—á':'ch','—à':'sh','—â':'sht','—ä':'a','—ã':'y','—å':'','—ç':'e','—é':'yu','—è':'ya',
'–ê':'A','–ë':'B','–í':'V','–ì':'G','–î':'D','–ï':'E','–Å':'E','–ñ':'Zh','–ó':'Z','–ò':'I','–ô':'Y',
'–ö':'K','–õ':'L','–ú':'M','–ù':'N','–û':'O','–ü':'P','–†':'R','–°':'S','–¢':'T','–£':'U',
'–§':'F','–•':'H','–¶':'Ts','–ß':'Ch','–®':'Sh','–©':'Sht','–™':'A','–´':'Y','–¨':'','–≠':'E','–Æ':'Yu','–Ø':'Ya'
};
return text.split('').map(char=>map[char]||char).join('');
},

// Payment status helpers
getOrderPaymentStatus(orderId){
const order=DS.find('orders',orderId);
if(!order)return {paid:true,overdueDays:0};

// No invoice = no payment required yet = PAID
const invoice=DS.d.invoices.find(inv=>inv.orderId===orderId);
if(!invoice)return {paid:true,overdueDays:0};

// Has invoice but no receivable = paid in cash or data error = PAID
const receivable=DS.d.receivables.find(r=>r.invoiceId===invoice.id);
if(!receivable)return {paid:true,overdueDays:0};

// Has receivable - check remaining amount
const paid=receivable.remainingAmount===0;
return {paid,overdueDays:paid?0:this.getOverdueDays(invoice.issueDate)};
},

getOverdueDays(orderDate){
const now=new Date();
const date=new Date(orderDate);
const days=Math.floor((now-date)/86400000);
return Math.max(0,days);
},

getUnpaidOrders(){
return DS.d.orders
.filter(o=>o.status==='delivered')
.map(o=>{
const invoice=DS.d.invoices.find(inv=>inv.orderId===o.id);
if(!invoice)return null; // No invoice = not unpaid

const receivable=DS.d.receivables.find(r=>r.invoiceId===invoice.id);
if(!receivable)return null; // No receivable = not unpaid

// Only include if there's ACTUALLY remaining amount
if(receivable.remainingAmount<=0)return null;

return {
...o,
paymentStatus:{
paid:false,
overdueDays:this.getOverdueDays(invoice.issueDate),
remainingAmount:receivable.remainingAmount
}
};
})
.filter(o=>o!==null)
.sort((a,b)=>b.paymentStatus.overdueDays-a.paymentStatus.overdueDays);
},

getUninvoicedOrders(){
return DS.d.orders
.filter(o=>o.status==='delivered')
.filter(o=>!DS.d.invoices.find(inv=>inv.orderId===o.id))
.sort((a,b)=>new Date(a.date)-new Date(b.date));
},

render(){
const app=document.getElementById('app');
const pages={
login:()=>this.renderLogin(),
register:()=>this.renderRegister(),
dashboard:()=>this.renderDashboard(),
'driver-dashboard':()=>this.renderDriverDashboard(),
orders:()=>this.renderOrders(),
clients:()=>this.renderClients(),
suppliers:()=>this.renderSuppliers(),
staff:()=>this.renderStaff(),
vehicles:()=>this.renderVehicles(),
deliveries:()=>this.renderDeliveries(),
warehouses:()=>this.renderWarehouses(),
inventory:()=>this.renderInventory(),
materials:()=>this.renderMaterials(),
invoices:()=>this.renderInvoices(),
payments:()=>this.renderPayments(),
expenses:()=>this.renderExpenses(),
revenues:()=>this.renderRevenues(),
receivables:()=>this.renderReceivables(),
insurances:()=>this.renderInsurances(),
technicalInspections:()=>this.renderTechnicalInspections(),
services:()=>this.renderServices(),
vignettes:()=>this.renderVignettes(),
gps:()=>this.renderGPS(),
contracts:()=>this.renderContracts(),
payrolls:()=>this.renderPayrolls(),
leaves:()=>this.renderLeaves(),
documents:()=>this.renderDocuments(),
reports:()=>this.renderReports(),
notifications:()=>this.renderNotifications(),
company:()=>this.renderCompany(),
settings:()=>this.renderSettings(),
more:()=>this.renderMore()
};
const fn=pages[this.page];
if(fn)app.innerHTML=fn();
},

// ========== AUTH PAGES ==========
renderLogin(){
return `<div class="auth">
<div class="auth-box">
<div class="auth-logo">üöõ</div>
<div class="auth-title">BuildFlow Pro v4</div>
<p class="auth-subtitle">ULTIMATE Edition - Full Sync</p>
<form onsubmit="App.handleLogin(event)">
<div class="form-group">
<label>Email</label>
<input type="email" id="email" required placeholder="your@email.com" autocomplete="email">
</div>
<div class="form-group">
<label>Password</label>
<input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
</div>
<button type="submit" class="btn">–í–ª–µ–∑</button>
</form>
<div class="link" onclick="App.navigate('register')">
–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ –±–µ–∑–ø–ª–∞—Ç–Ω–æ ¬∑ 7 –¥–Ω–∏ trial
</div>
</div>
</div>`;
},

renderRegister(){
return `<div class="auth">
<div class="auth-box">
<div class="auth-logo">üöõ</div>
<div class="auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
<p class="auth-subtitle">7 –¥–Ω–∏ –±–µ–∑–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–∞—Ä—Ç–∞</p>
<form onsubmit="App.handleRegister(event)">
<div class="form-group">
<label>Email</label>
<input type="email" id="email" required placeholder="your@email.com">
</div>
<div class="form-group">
<label>Password</label>
<input type="password" id="password" minlength="6" required placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–∞">
</div>
<div class="form-group">
<label>–ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞</label>
<input type="text" id="company" required placeholder="–ú–æ—è—Ç–∞ –§–∏—Ä–º–∞ –û–û–î">
</div>
<button type="submit" class="btn">–°—ä–∑–¥–∞–π –∞–∫–∞—É–Ω—Ç</button>
</form>
<div class="link" onclick="App.navigate('login')">
–ò–º–∞—à –∞–∫–∞—É–Ω—Ç? –í–ª–µ–∑
</div>
</div>
</div>`;
},

// ========== DASHBOARD ==========
renderDashboard(){
// Force reload financial data to ensure accuracy
DS.load();


const d=Auth.trialDays();
const o=DS.d.orders;
const pending=o.filter(x=>x.status==='pending').length;
const active=o.filter(x=>x.status==='active').length;
const delivered=o.filter(x=>x.status==='delivered').length;
const unread=DS.d.notifications.filter(n=>!n.read).length;

const totalRevenue=DS.d.revenues.reduce((s,r)=>s+r.amount,0);
const totalExpenses=DS.d.expenses.reduce((s,e)=>s+e.amount,0);
const profit=totalRevenue-totalExpenses;
const unpaidInvoices=DS.d.receivables.reduce((s,r)=>s+r.remainingAmount,0);


return `<div class="header">
<div>
<div class="header-title">${Auth.company?.name||'BuildFlow Pro'}</div>
<div class="header-subtitle">${Auth.user?.email||''}</div>
</div>
<button class="header-btn" onclick="if(Auth.logout()){localStorage.removeItem('bfv4_user');localStorage.removeItem('bfv4_company');localStorage.removeItem('bfv4_trial');App.navigate('login')}">–ò–∑–ª–µ–∑</button>
</div>

<div class="container">
<div class="trial">
<div class="trial-days">${d}</div>
<div class="trial-text">–¥–Ω–∏ –æ—Å—Ç–∞–≤–∞—Ç –æ—Ç trial –ø–µ—Ä–∏–æ–¥</div>
</div>

<div class="stats">
<div class="stat" onclick="App.navigate('orders')">
<div class="stat-icon">‚è≥</div>
<div class="stat-value">${pending}</div>
<div class="stat-label">–ß–∞–∫–∞—â–∏</div>
</div>
<div class="stat" onclick="App.navigate('orders')">
<div class="stat-icon">üöÄ</div>
<div class="stat-value">${active}</div>
<div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏</div>
</div>
<div class="stat" onclick="App.navigate('orders')">
<div class="stat-icon">‚úÖ</div>
<div class="stat-value">${delivered}</div>
<div class="stat-label">–î–æ—Å—Ç–∞–≤–µ–Ω–∏</div>
</div>
<div class="stat" onclick="App.navigate('notifications')">
<div class="stat-icon">üîî</div>
<div class="stat-value">${unread}</div>
<div class="stat-label">–ò–∑–≤–µ—Å—Ç–∏—è</div>
</div>
</div>

${unread>0?`<div class="alert alert-warning">
‚ö†Ô∏è –ò–º–∞—Ç–µ ${unread} –Ω–µ–ø—Ä–æ—á–µ—Ç–µ–Ω–∏ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
</div>`:''}

<div class="section">
<div class="section-title">–§–∏–Ω–∞–Ω—Å–æ–≤ –ø—Ä–µ–≥–ª–µ–¥</div>
<div style="display:flex;flex-direction:column;gap:8px">
<div class="stat" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:12px;background:linear-gradient(135deg,rgba(52,199,89,0.08),rgba(52,199,89,0.12));border:1px solid rgba(52,199,89,0.2)">
<div style="display:flex;align-items:center;gap:8px">
<div class="stat-icon" style="font-size:26px">üí∞</div>
<div class="stat-label" style="font-size:13px;margin:0">–ü—Ä–∏—Ö–æ–¥–∏</div>
</div>
<div class="stat-value" style="color:var(--green-dark);font-size:19px">${totalRevenue.toLocaleString()}</div>
</div>
<div class="stat" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:12px;background:linear-gradient(135deg,rgba(255,59,48,0.08),rgba(255,59,48,0.12));border:1px solid rgba(255,59,48,0.2)">
<div style="display:flex;align-items:center;gap:8px">
<div class="stat-icon" style="font-size:26px">üí∏</div>
<div class="stat-label" style="font-size:13px;margin:0">–†–∞–∑—Ö–æ–¥–∏</div>
</div>
<div class="stat-value" style="color:var(--red-dark);font-size:19px">${totalExpenses.toLocaleString()}</div>
</div>
<div class="stat" style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:12px;background:linear-gradient(135deg,${profit>=0?'rgba(52,199,89,0.08),rgba(52,199,89,0.12)':'rgba(255,59,48,0.08),rgba(255,59,48,0.12)'});border:2px solid ${profit>=0?'rgba(52,199,89,0.2)':'rgba(255,59,48,0.2)'}">
<div style="display:flex;align-items:center;gap:8px">
<div class="stat-icon" style="font-size:26px">üìà</div>
<div class="stat-label" style="font-size:13px;margin:0">–ü–µ—á–∞–ª–±–∞</div>
</div>
<div class="stat-value" style="color:${profit>=0?'var(--green-dark)':'var(--red-dark)'};font-size:19px">${profit.toLocaleString()}</div>
</div>
</div>
${unpaidInvoices>0?`<div style="margin-top:8px;padding:10px;background:rgba(255,149,0,0.1);border-radius:8px;font-size:13px;color:var(--orange)">
üíµ –í–∑–µ–º–∞–Ω–∏—è: <strong>${unpaidInvoices.toLocaleString()} –ª–≤</strong>
</div>`:' '}
</div>

${(()=>{
const unpaidOrders=this.getUnpaidOrders();
if(unpaidOrders.length===0)return '';

// Total is already calculated in getUnpaidOrders with remainingAmount
const totalUnpaid=unpaidOrders.reduce((s,o)=>s+(o.paymentStatus.remainingAmount||0),0);

return `<div class="section">
<div class="section-title" style="color:var(--red)">üî¥ –ù–µ–ø–ª–∞—Ç–µ–Ω–∏ –ø–æ—Ä—ä—á–∫–∏ (${unpaidOrders.length})</div>
<div style="padding:10px;background:rgba(255,59,48,0.1);border-radius:8px;margin-bottom:12px">
<strong style="color:var(--red)">${totalUnpaid.toLocaleString()} –ª–≤</strong> –æ—Å—Ç–∞–≤–∞—Ç –∑–∞ –ø–ª–∞—â–∞–Ω–µ
</div>
${unpaidOrders.slice(0,5).map(o=>`
<div class="card" onclick="App.viewOrder('${o.id}')" style="border-left:3px solid var(--red)">
<div class="card-header">
<div class="card-title">${o.client}</div>
<div style="text-align:right">
<div style="font-size:14px;font-weight:600;color:var(--red)">${o.paymentStatus.remainingAmount.toLocaleString()} –ª–≤</div>
<div style="font-size:11px;color:var(--gray6)">–æ—Ç ${o.finalValue.toLocaleString()} –ª–≤</div>
<div style="font-size:11px;color:var(--red)">üî¥ ${o.paymentStatus.overdueDays} –¥–Ω–∏ –ø—Ä–æ—Å—Ä–æ—á–∏–µ</div>
</div>
</div>
<div class="card-body" style="font-size:12px">
üì¶ ${o.materials} ¬∑ üìÖ ${o.date}
</div>
</div>
`).join('')}
${unpaidOrders.length>5?`<div style="text-align:center;padding:10px">
<button class="btn" onclick="App.navigate('orders');App.filterStatus='unpaid'" style="background:var(--red)">
–í–∏–∂ –≤—Å–∏—á–∫–∏ ${unpaidOrders.length} –Ω–µ–ø–ª–∞—Ç–µ–Ω–∏
</button>
</div>`:''}
</div>`;
})()}

${(()=>{
const uninvoicedOrders=this.getUninvoicedOrders();
if(uninvoicedOrders.length===0)return '';

const totalUninvoiced=uninvoicedOrders.reduce((s,o)=>s+o.finalValue,0);

return `<div class="section">
<div class="section-title" style="color:var(--orange)">‚ö†Ô∏è –ù–µ—Ñ–∞–∫—Ç—É—Ä–∏—Ä–∞–Ω–∏ –ø–æ—Ä—ä—á–∫–∏ (${uninvoicedOrders.length})</div>
<div style="padding:10px;background:rgba(255,149,0,0.1);border-radius:8px;margin-bottom:12px">
<strong style="color:var(--orange)">${totalUninvoiced.toLocaleString()} –ª–≤</strong> –∑–∞ —Ñ–∞–∫—Ç—É—Ä–∏—Ä–∞–Ω–µ
</div>
${uninvoicedOrders.slice(0,5).map(o=>{
const days=Math.floor((new Date()-new Date(o.date))/86400000);
return `<div class="card" onclick="App.viewOrder('${o.id}')" style="border-left:3px solid var(--orange)">
<div class="card-header">
<div class="card-title">${o.client}</div>
<div style="text-align:right">
<div style="font-size:14px;font-weight:600;color:var(--orange)">${o.finalValue.toLocaleString()} –ª–≤</div>
<div style="font-size:11px;color:var(--orange)">‚ö†Ô∏è ${days} –¥–Ω–∏ –±–µ–∑ —Ñ–∞–∫—Ç—É—Ä–∞</div>
</div>
</div>
<div class="card-body" style="font-size:12px">
üì¶ ${o.materials} ¬∑ üìÖ ${o.date}
</div>
</div>`;
}).join('')}
${uninvoicedOrders.length>5?`<div style="text-align:center;padding:10px">
<button class="btn" onclick="App.navigate('orders');App.filterStatus='uninvoiced'" style="background:var(--orange)">
–í–∏–∂ –≤—Å–∏—á–∫–∏ ${uninvoicedOrders.length} –Ω–µ—Ñ–∞–∫—Ç—É—Ä–∏—Ä–∞–Ω–∏
</button>
</div>`:''}
</div>`;
})()}

<div class="section">
<div class="category-title">–û—Å–Ω–æ–≤–Ω–∏</div>
<div class="menu" style="grid-template-columns:repeat(3,1fr);gap:8px">
<div class="menu-item" onclick="App.navigate('orders')">
<div class="menu-icon">üì¶</div>
<div class="menu-label">–ü–æ—Ä—ä—á–∫–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('deliveries')">
<div class="menu-icon">üöö</div>
<div class="menu-label">–î–æ—Å—Ç–∞–≤–∫–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('suppliers')">
<div class="menu-icon">üè™</div>
<div class="menu-label">–î–æ—Å—Ç–∞–≤—á–∏—Ü–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('clients')">
<div class="menu-icon">üë•</div>
<div class="menu-label">–ö–ª–∏–µ–Ω—Ç–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('staff')">
<div class="menu-icon">üë∑</div>
<div class="menu-label">–ü–µ—Ä—Å–æ–Ω–∞–ª</div>
</div>
<div class="menu-item" onclick="App.navigate('vehicles')">
<div class="menu-icon">üöõ</div>
<div class="menu-label">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>
</div>
</div>
</div>

<div class="section">
<div class="category-title">–§–∏–Ω–∞–Ω—Å–∏</div>
<div class="menu" style="gap:8px">
<div class="menu-item" onclick="App.navigate('revenues')">
<div class="menu-icon">üí∞</div>
<div class="menu-label">–ü—Ä–∏—Ö–æ–¥–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('expenses')">
<div class="menu-icon">üí∏</div>
<div class="menu-label">–†–∞–∑—Ö–æ–¥–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('payments')">
<div class="menu-icon">üí≥</div>
<div class="menu-label">–ü–ª–∞—â–∞–Ω–∏—è</div>
</div>
<div class="menu-item" onclick="App.navigate('receivables')">
<div class="menu-icon">üíµ</div>
<div class="menu-label">–í–∑–µ–º–∞–Ω–∏—è</div>
</div>
</div>
</div>

<div class="section">
<div class="category-title">HR & Vehicle Tracking</div>
<div class="menu" style="grid-template-columns:repeat(3,1fr);gap:8px">
<div class="menu-item" onclick="App.navigate('contracts')">
<div class="menu-icon">üìù</div>
<div class="menu-label">–î–æ–≥–æ–≤–æ—Ä–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('payrolls')">
<div class="menu-icon">üíµ</div>
<div class="menu-label">–ó–∞–ø–ª–∞—Ç–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('leaves')">
<div class="menu-icon">üèñÔ∏è</div>
<div class="menu-label">–û—Ç–ø—É—Å–∫–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('insurances')">
<div class="menu-icon">üõ°Ô∏è</div>
<div class="menu-label">–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('technicalInspections')">
<div class="menu-icon">üîß</div>
<div class="menu-label">–¢–µ—Ö–Ω. –ø—Ä–µ–≥–ª–µ–¥–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('services')">
<div class="menu-icon">‚öôÔ∏è</div>
<div class="menu-label">–û–±—Å–ª—É–∂–≤–∞–Ω–µ</div>
</div>
<div class="menu-item" onclick="App.navigate('vignettes')">
<div class="menu-icon">üé´</div>
<div class="menu-label">–í–∏–Ω–µ—Ç–∫–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('gps')">
<div class="menu-icon">üó∫Ô∏è</div>
<div class="menu-label">GPS</div>
</div>
</div>
</div>

${pending>0?`<div class="section">
<div class="section-header">
<div class="section-title">–ß–∞–∫–∞—â–∏ –ø–æ—Ä—ä—á–∫–∏</div>
<button class="add-btn" onclick="App.navigate('orders')">–í—Å–∏—á–∫–∏</button>
</div>
${o.filter(x=>x.status==='pending').slice(0,3).map(order=>`
<div class="card" onclick="App.viewOrder('${order.id}')">
<div class="card-header">
<div class="card-title">${order.id}</div>
<span class="badge badge-pending">pending</span>
</div>
<div class="card-body">
<strong>${order.client}</strong><br>
${order.materials}<br>
üí∞ ${order.finalValue} –ª–≤ ¬∑ ${order.time}
</div>
</div>
`).join('')}
</div>`:''}
</div>

${this.renderNav()}`;
},

// ========== DRIVER DASHBOARD ==========
renderDriverDashboard(){
const driverId=Auth.user?.staffId;
if(!driverId)return this.renderLogin();

const myDeliveries=DS.d.deliveries.filter(d=>d.driverId===driverId);
const activeDeliveries=myDeliveries.filter(d=>d.status==='in-progress');
const today=new Date().toISOString().split('T')[0];
const completedToday=myDeliveries.filter(d=>d.completedDate===today&&d.status==='delivered');
const todayKm=GPSTracker.getTodayDistance?.(driverId)||0;

return `<div class="header">
<div>
<div class="header-title">üöó –ú–æ—è—Ç Dashboard</div>
<div class="header-subtitle">${Auth.user?.name||''}</div>
</div>
<button class="header-btn" onclick="if(Auth.logout()){localStorage.removeItem('bfv4_current_user');App.navigate('login')}">–ò–∑–ª–µ–∑</button>
</div>

<div class="container">
<div class="stats">
<div class="stat">
<div class="stat-icon">üöÄ</div>
<div class="stat-value">${activeDeliveries.length}</div>
<div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏</div>
</div>
<div class="stat">
<div class="stat-icon">‚úÖ</div>
<div class="stat-value">${completedToday.length}</div>
<div class="stat-label">–î–Ω–µ—Å</div>
</div>
<div class="stat">
<div class="stat-icon">üìè</div>
<div class="stat-value">${Math.round(todayKm)}</div>
<div class="stat-label">–∫–º –¥–Ω–µ—Å</div>
</div>
</div>

<div class="section">
<div class="section-title">üõ∞Ô∏è GPS Tracking</div>
<div style="display:flex;gap:12px;margin-bottom:12px;align-items:center">
<div style="flex:1">
<strong>–°—Ç–∞—Ç—É—Å:</strong> ${GPSTracker.isTracking?'üü¢ –ê–∫—Ç–∏–≤–µ–Ω':'üî¥ –ò–∑–∫–ª—é—á–µ–Ω'}<br>
<small style="color:var(--gray6)">${GPSTracker.isTracking?'GPS tracking –µ –∞–∫—Ç–∏–≤–µ–Ω':'–ù–∞—Ç–∏—Å–Ω–∏ Start –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—à'}</small>
</div>
<button class="btn ${GPSTracker.isTracking?'btn-danger':''}" 
onclick="${GPSTracker.isTracking?'GPSTracker.stopTracking();App.render()':'GPSTracker.startTracking();App.render()'}">
${GPSTracker.isTracking?'üî¥ –°—Ç–æ–ø':'üü¢ –°—Ç–∞—Ä—Ç'}
</button>
</div>
</div>

<div class="section">
<div class="section-title">–ú–æ–∏—Ç–µ –¥–æ—Å—Ç–∞–≤–∫–∏ (${myDeliveries.length})</div>
${myDeliveries.length===0?UI.empty('üöö','–ù—è–º–∞ –¥–æ—Å—Ç–∞–≤–∫–∏',''):myDeliveries.slice(0,10).map(d=>`
<div class="card">
<div class="card-header">
<div class="card-title">${d.vehicle}</div>
<span class="badge badge-${d.status==='delivered'?'delivered':d.status==='in-progress'?'active':'pending'}">${d.status}</span>
</div>
<div class="card-body">
üìç ${d.route}<br>
üì¶ –ü–æ—Ä—ä—á–∫–∞: ${d.orderId}<br>
${d.status==='in-progress'?`üìè <strong>${d.distanceTraveled||0} –∫–º</strong><br>`:''}
${d.status==='delivered'?`‚úÖ –ó–∞–≤—ä—Ä—à–µ–Ω–∞: ${d.completedDate}<br>`:''} 
üë§ ${d.client}
</div>
</div>
`).join('')}
</div>
</div>

<div class="bottom-nav">
<div class="nav-item active">
<div class="nav-icon">üè†</div>
<div class="nav-text">–ù–∞—á–∞–ª–æ</div>
</div>
<div class="nav-item" onclick="GPSTracker.isTracking?GPSTracker.stopTracking():GPSTracker.startTracking();App.render()">
<div class="nav-icon">${GPSTracker.isTracking?'üî¥':'üü¢'}</div>
<div class="nav-text">GPS</div>
</div>
<div class="nav-item" onclick="if(Auth.logout()){localStorage.removeItem('bfv4_current_user');App.navigate('login')}">
<div class="nav-icon">üö™</div>
<div class="nav-text">–ò–∑—Ö–æ–¥</div>
</div>
</div>`;
},

// ========== SUPPLIERS MODULE ==========
renderSuppliers(){
let suppliers=DS.d.suppliers;
if(this.searchQuery){
suppliers=suppliers.filter(s=>
s.name.toLowerCase().includes(this.searchQuery.toLowerCase())||
s.eik.includes(this.searchQuery)||
s.phone.includes(this.searchQuery)
);
}

return `<div class="header">
<div>
<div class="header-title">üè™ –î–æ—Å—Ç–∞–≤—á–∏—Ü–∏</div>
<div class="header-subtitle">${suppliers.length} –¥–æ—Å—Ç–∞–≤—á–∏—Ü–∏</div>
</div>
<button class="header-btn" onclick="App.addSupplier()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –¥–æ—Å—Ç–∞–≤—á–∏–∫..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${suppliers.length===0?UI.empty('üè™','–ù—è–º–∞ –¥–æ—Å—Ç–∞–≤—á–∏—Ü–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è –¥–æ—Å—Ç–∞–≤—á–∏–∫'):suppliers.map(s=>`
<div class="card" onclick="App.viewSupplier('${s.id}')">
<div class="card-header">
<div class="card-title">${s.name}</div>
${s.status==='vip'?'<span class="badge badge-vip">‚≠ê VIP</span>':''}
</div>
<div class="card-body">
<strong>–ï–ò–ö:</strong> ${s.eik} ¬∑ <strong>–ú–û–õ:</strong> ${s.mol}<br>
üìû ${s.phone} ¬∑ üìß ${s.email}<br>
üì¶ ${s.orders} –ø–æ—Ä—ä—á–∫–∏ ¬∑ üí∞ ${s.turnover?.toLocaleString()||0} –ª–≤ –æ–±–æ—Ä–æ—Ç<br>
% –û—Ç—Å—Ç—ä–ø–∫–∞: <strong>${s.discount}%</strong>
${s.notes?'<br><em style="font-size:11px">'+s.notes+'</em>':''}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addSupplier(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –¥–æ—Å—Ç–∞–≤—á–∏–∫</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddSupplier(event)">
<div class="form-group">
<label>–ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞ *</label>
<input type="text" id="name" required placeholder="–ë–µ—Ç–æ–Ω–°–Ω–∞–± –û–û–î">
</div>
<div class="form-group">
<label>–ï–ò–ö / –ë—É–ª—Å—Ç–∞—Ç *</label>
<input type="text" id="eik" required placeholder="123456789">
</div>
<div class="form-group">
<label>–ú–û–õ *</label>
<input type="text" id="mol" required placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
</div>
<div class="form-group">
<label>–ê–¥—Ä–µ—Å</label>
<input type="text" id="address" placeholder="–°–æ—Ñ–∏—è, –ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª–Ω–∞ –∑–æ–Ω–∞">
</div>
<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
<input type="tel" id="phone" required placeholder="+359 888 111 222">
</div>
<div class="form-group">
<label>Email *</label>
<input type="email" id="email" required placeholder="office@company.bg">
</div>
<div class="form-group">
<label>% –û—Ç—Å—Ç—ä–ø–∫–∞</label>
<input type="number" id="discount" min="0" max="100" placeholder="5" value="0">
</div>
<div class="form-group">
<label>–°—Ç–∞—Ç—É—Å</label>
<select id="status">
<option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
<option value="vip">VIP</option>
<option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
</select>
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes" placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
</div>
<button type="submit" class="btn">–°—ä–∑–¥–∞–π –¥–æ—Å—Ç–∞–≤—á–∏–∫</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleAddSupplier(e){
e.preventDefault();
const supplier={
name:document.getElementById('name').value,
eik:document.getElementById('eik').value,
mol:document.getElementById('mol').value,
address:document.getElementById('address').value,
phone:document.getElementById('phone').value,
email:document.getElementById('email').value,
discount:Number(document.getElementById('discount').value)||0,
status:document.getElementById('status').value,
notes:document.getElementById('notes').value,
orders:0,
turnover:0
};

DS.add('suppliers',supplier);
UI.closeModal();
UI.toast('‚úÖ –î–æ—Å—Ç–∞–≤—á–∏–∫ –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

viewSupplier(id){
const s=DS.find('suppliers',id);
if(!s)return;

// Calculate real turnover from expenses
const supplierExpenses=DS.d.expenses.filter(e=>e.supplierId===id);
const totalExpenses=supplierExpenses.reduce((sum,e)=>sum+e.amount,0);
const expenseCount=supplierExpenses.length;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìÅ –î–æ—Å–∏–µ: ${s.name}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ñ–∏—Ä–º–∞—Ç–∞</div>
<div class="detail-row">
<div class="detail-label">–ï–ò–ö</div>
<div class="detail-value">${s.eik}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–û–õ</div>
<div class="detail-value">${s.mol}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ê–¥—Ä–µ—Å</div>
<div class="detail-value">${s.address||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
<div class="detail-value">${s.phone}</div>
</div>
<div class="detail-row">
<div class="detail-label">Email</div>
<div class="detail-value">${s.email}</div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–¢—ä—Ä–≥–æ–≤—Å–∫–∏ —É—Å–ª–æ–≤–∏—è</div>
<div class="detail-row">
<div class="detail-label">% –û—Ç—Å—Ç—ä–ø–∫–∞</div>
<div class="detail-value">${s.discount}%</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value">${s.status==='vip'?'‚≠ê VIP':s.status}</div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–§–∏–Ω–∞–Ω—Å–æ–≤ –æ–±–æ—Ä–æ—Ç</div>
<div class="detail-row">
<div class="detail-label">–ë—Ä–æ–π —Ä–∞–∑—Ö–æ–¥–∏</div>
<div class="detail-value" style="font-weight:600">${expenseCount}</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–æ –∏–∑—Ö–∞—Ä—á–µ–Ω–æ</div>
<div class="detail-value" style="font-weight:600;color:var(--red)">${totalExpenses.toLocaleString()} –ª–≤</div>
</div>
</div>

${s.notes?`<div class="detail-section">
<div class="detail-title">–ó–∞–±–µ–ª–µ–∂–∫–∏</div>
<p style="font-size:14px;color:var(--gray6)">${s.notes}</p>
</div>`:''}

<button class="btn" onclick="App.editSupplier('${s.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-danger" onclick="App.deleteSupplier('${s.id}')">–ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editSupplier(id){
const s=DS.find('suppliers',id);
if(!s)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –¥–æ—Å—Ç–∞–≤—á–∏–∫</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditSupplier(event,'${id}')">
<div class="form-group">
<label>–ò–º–µ</label>
<input type="text" id="name" value="${s.name}" required>
</div>
<div class="form-group">
<label>–ï–ò–ö</label>
<input type="text" id="eik" value="${s.eik}" required>
</div>
<div class="form-group">
<label>–ú–û–õ</label>
<input type="text" id="mol" value="${s.mol}" required>
</div>
<div class="form-group">
<label>–ê–¥—Ä–µ—Å</label>
<input type="text" id="address" value="${s.address||''}">
</div>
<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
<input type="tel" id="phone" value="${s.phone}" required>
</div>
<div class="form-group">
<label>Email</label>
<input type="email" id="email" value="${s.email}" required>
</div>
<div class="form-group">
<label>% –û—Ç—Å—Ç—ä–ø–∫–∞</label>
<input type="number" id="discount" value="${s.discount}" min="0" max="100">
</div>
<div class="form-group">
<label>–°—Ç–∞—Ç—É—Å</label>
<select id="status">
<option value="active" ${s.status==='active'?'selected':''}>–ê–∫—Ç–∏–≤–µ–Ω</option>
<option value="vip" ${s.status==='vip'?'selected':''}>VIP</option>
<option value="inactive" ${s.status==='inactive'?'selected':''}>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
</select>
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes">${s.notes||''}</textarea>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditSupplier(e,id){
e.preventDefault();
const updates={
name:document.getElementById('name').value,
eik:document.getElementById('eik').value,
mol:document.getElementById('mol').value,
address:document.getElementById('address').value,
phone:document.getElementById('phone').value,
email:document.getElementById('email').value,
discount:Number(document.getElementById('discount').value),
status:document.getElementById('status').value,
notes:document.getElementById('notes').value
};

DS.update('suppliers',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.render();
},

deleteSupplier(id){
UI.confirm('–ò–∑—Ç—Ä–∏–π –¥–æ—Å—Ç–∞–≤—á–∏–∫?',()=>{
DS.delete('suppliers',id);
UI.closeModal();
UI.toast('‚úÖ –î–æ—Å—Ç–∞–≤—á–∏–∫ –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
},

// Continue with other modules implementation...
// Due to size constraints, I'll include key modules and summarize others

renderClients(){
// Similar to suppliers with extended fields
let clients=DS.d.clients;
if(this.searchQuery){
clients=clients.filter(c=>
c.name.toLowerCase().includes(this.searchQuery.toLowerCase())||
c.eik.includes(this.searchQuery)||
c.phone.includes(this.searchQuery)
);
}

return `<div class="header">
<div>
<div class="header-title">üë• –ö–ª–∏–µ–Ω—Ç–∏</div>
<div class="header-subtitle">${clients.length} –∫–ª–∏–µ–Ω—Ç–∏</div>
</div>
<button class="header-btn" onclick="App.addClient()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –∫–ª–∏–µ–Ω—Ç..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${clients.length===0?UI.empty('üë•','–ù—è–º–∞ –∫–ª–∏–µ–Ω—Ç–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è –∫–ª–∏–µ–Ω—Ç'):clients.map(c=>`
<div class="card" onclick="App.viewClient('${c.id}')">
<div class="card-header">
<div class="card-title">${c.name}</div>
${c.status==='vip'?'<span class="badge badge-vip">‚≠ê VIP</span>':''}
</div>
<div class="card-body">
<strong>–ï–ò–ö:</strong> ${c.eik} ¬∑ <strong>–ú–û–õ:</strong> ${c.mol}<br>
üìû ${c.phone} ¬∑ üìß ${c.email}<br>
üì¶ ${c.orders} –ø–æ—Ä—ä—á–∫–∏ ¬∑ üí∞ ${c.turnover?.toLocaleString()||0} –ª–≤ –æ–±–æ—Ä–æ—Ç<br>
% –û—Ç—Å—Ç—ä–ø–∫–∞: <strong>${c.discount}%</strong>
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addClient(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –∫–ª–∏–µ–Ω—Ç</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddClient(event)">
<div class="form-group">
<label>–ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞ *</label>
<input type="text" id="name" required placeholder="–°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä –û–û–î">
</div>
<div class="form-group">
<label>–ï–ò–ö / –ë—É–ª—Å—Ç–∞—Ç *</label>
<input type="text" id="eik" required placeholder="123456789">
</div>
<div class="form-group">
<label>–ú–û–õ *</label>
<input type="text" id="mol" required placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
</div>
<div class="form-group">
<label>–ê–¥—Ä–µ—Å</label>
<input type="text" id="address" placeholder="–°–æ—Ñ–∏—è, —É–ª. –°—Ç—Ä–æ–∏—Ç–µ–ª 42">
</div>
<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
<input type="tel" id="phone" required placeholder="+359 888 123 456">
</div>
<div class="form-group">
<label>Email *</label>
<input type="email" id="email" required placeholder="info@company.bg">
</div>
<div class="form-group">
<label>% –û—Ç—Å—Ç—ä–ø–∫–∞</label>
<input type="number" id="discount" min="0" max="100" placeholder="5" value="0">
</div>
<div class="form-group">
<label>–°—Ç–∞—Ç—É—Å</label>
<select id="status">
<option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
<option value="vip">VIP</option>
<option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
</select>
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes" placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
</div>
<button type="submit" class="btn">–°—ä–∑–¥–∞–π –∫–ª–∏–µ–Ω—Ç</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddClient(e){
e.preventDefault();
const client={
name:document.getElementById('name').value,
eik:document.getElementById('eik').value,
mol:document.getElementById('mol').value,
address:document.getElementById('address').value,
phone:document.getElementById('phone').value,
email:document.getElementById('email').value,
discount:Number(document.getElementById('discount').value)||0,
status:document.getElementById('status').value,
notes:document.getElementById('notes').value,
orders:0,
turnover:0
};
DS.add('clients',client);
UI.closeModal();
UI.toast('‚úÖ –ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

viewClient(id){
const c=DS.find('clients',id);
if(!c)return;

const orders=DS.d.orders.filter(o=>o.clientId===id);
const invoices=DS.d.invoices.filter(i=>i.clientId===id);
const payments=DS.d.payments.filter(p=>invoices.some(inv=>inv.id===p.invoiceId));
const totalOrdered=orders.reduce((s,o)=>s+o.finalValue,0);
const totalPaid=payments.reduce((s,p)=>s+p.amount,0);
const unpaid=invoices.reduce((s,i)=>i.status==='pending'?s+i.total:s,0);

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìÅ –î–æ—Å–∏–µ: ${c.name}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">

<div class="tabs">
<div class="tab active" onclick="App.switchTab(event,'info')">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
<div class="tab" onclick="App.switchTab(event,'orders')">–ü–æ—Ä—ä—á–∫–∏ (${orders.length})</div>
<div class="tab" onclick="App.switchTab(event,'invoices')">–§–∞–∫—Ç—É—Ä–∏ (${invoices.length})</div>
<div class="tab" onclick="App.switchTab(event,'stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
</div>

<div id="tab-info" class="tab-content">
<div class="detail-section">
<div class="detail-title">–§–∏—Ä–º–µ–Ω–∏ –¥–∞–Ω–Ω–∏</div>
<div class="detail-row">
<div class="detail-label">–ï–ò–ö</div>
<div class="detail-value">${c.eik}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–û–õ</div>
<div class="detail-value">${c.mol}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ê–¥—Ä–µ—Å</div>
<div class="detail-value">${c.address||'N/A'}</div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–ö–æ–Ω—Ç–∞–∫—Ç–∏</div>
<div class="detail-row">
<div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
<div class="detail-value"><a href="tel:${c.phone}">${c.phone}</a></div>
</div>
<div class="detail-row">
<div class="detail-label">Email</div>
<div class="detail-value"><a href="mailto:${c.email}">${c.email}</a></div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–¢—ä—Ä–≥–æ–≤—Å–∫–∏ —É—Å–ª–æ–≤–∏—è</div>
<div class="detail-row">
<div class="detail-label">% –û—Ç—Å—Ç—ä–ø–∫–∞</div>
<div class="detail-value">${c.discount}%</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value">${c.status==='vip'?'‚≠ê VIP':c.status}</div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–§–∏–Ω–∞–Ω—Å–æ–≤ –æ–±–æ—Ä–æ—Ç</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–æ –ø–æ—Ä—ä—á–∞–Ω–æ</div>
<div class="detail-value" style="font-weight:600">${totalOrdered.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–æ –ø–ª–∞—Ç–µ–Ω–æ</div>
<div class="detail-value" style="font-weight:600;color:var(--green)">${totalPaid.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</div>
<div class="detail-value" style="font-weight:600;color:var(--red)">${unpaid.toLocaleString()} –ª–≤</div>
</div>
</div>

${c.notes?`<div class="detail-section">
<div class="detail-title">–ó–∞–±–µ–ª–µ–∂–∫–∏</div>
<p style="font-size:13px;color:var(--gray6)">${c.notes}</p>
</div>`:''}
</div>

<div id="tab-orders" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –ø–æ—Ä—ä—á–∫–∏</div>
${orders.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ –ø–æ—Ä—ä—á–∫–∏</p>':orders.map(o=>`
<div style="padding:10px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${o.id}</strong> - ${o.date}<br>
${o.materials}<br>
<span class="badge badge-${o.status}">${o.status}</span> ¬∑ üí∞ ${o.finalValue} –ª–≤
</div>
`).join('')}
</div>
</div>

<div id="tab-invoices" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–§–∞–∫—Ç—É—Ä–∏</div>
${invoices.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ —Ñ–∞–∫—Ç—É—Ä–∏</p>':invoices.map(inv=>`
<div style="padding:10px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${inv.id}</strong> - ${inv.issueDate}<br>
–°—É–º–∞: ${inv.total} –ª–≤ (–î–î–°: ${inv.vat} –ª–≤)<br>
<span class="badge badge-${inv.status==='paid'?'delivered':'pending'}">${inv.status}</span>
${inv.status==='pending'?'<br>–ü–∞–¥–µ–∂: '+inv.dueDate:''}
</div>
`).join('')}
</div>
</div>

<div id="tab-stats" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
<div class="detail-row">
<div class="detail-label">–ü–æ—Ä—ä—á–∫–∏</div>
<div class="detail-value">${orders.length}</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç</div>
<div class="detail-value">${totalOrdered.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü–ª–∞—Ç–µ–Ω–æ</div>
<div class="detail-value" style="color:var(--green)">${totalPaid.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ù–µ–ø–ª–∞—Ç–µ–Ω–æ</div>
<div class="detail-value" style="color:var(--red)">${unpaid.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ä–µ–¥–Ω–∞ –ø–æ—Ä—ä—á–∫–∞</div>
<div class="detail-value">${orders.length>0?(totalOrdered/orders.length).toFixed(0):0} –ª–≤</div>
</div>
</div>
</div>

<button class="btn" onclick="App.editClient('${c.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-secondary" onclick="UI.closeModal();App.navigate('orders')">‚ûï –ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</button>
<button class="btn btn-danger" onclick="App.deleteClient('${c.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editClient(id){
const c=DS.find('clients',id);
if(!c)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –∫–ª–∏–µ–Ω—Ç</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditClient(event,'${id}')">
<div class="form-group">
<label>–ò–º–µ</label>
<input type="text" id="name" value="${c.name}" required>
</div>
<div class="form-group">
<label>–ï–ò–ö</label>
<input type="text" id="eik" value="${c.eik}" required>
</div>
<div class="form-group">
<label>–ú–û–õ</label>
<input type="text" id="mol" value="${c.mol}" required>
</div>
<div class="form-group">
<label>–ê–¥—Ä–µ—Å</label>
<input type="text" id="address" value="${c.address||''}">
</div>
<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
<input type="tel" id="phone" value="${c.phone}" required>
</div>
<div class="form-group">
<label>Email</label>
<input type="email" id="email" value="${c.email}" required>
</div>
<div class="form-group">
<label>% –û—Ç—Å—Ç—ä–ø–∫–∞</label>
<input type="number" id="discount" value="${c.discount}" min="0" max="100">
</div>
<div class="form-group">
<label>–°—Ç–∞—Ç—É—Å</label>
<select id="status">
<option value="active" ${c.status==='active'?'selected':''}>–ê–∫—Ç–∏–≤–µ–Ω</option>
<option value="vip" ${c.status==='vip'?'selected':''}>VIP</option>
<option value="inactive" ${c.status==='inactive'?'selected':''}>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
</select>
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes">${c.notes||''}</textarea>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditClient(e,id){
e.preventDefault();
const updates={
name:document.getElementById('name').value,
eik:document.getElementById('eik').value,
mol:document.getElementById('mol').value,
address:document.getElementById('address').value,
phone:document.getElementById('phone').value,
email:document.getElementById('email').value,
discount:Number(document.getElementById('discount').value),
status:document.getElementById('status').value,
notes:document.getElementById('notes').value
};

DS.update('clients',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.render();
},

deleteClient(id){
const client=DS.find('clients',id);
const orders=DS.d.orders.filter(o=>o.clientId===id);
const invoices=DS.d.invoices.filter(i=>i.clientId===id);
const unpaidInvoices=invoices.filter(i=>i.status==='pending');

if(orders.length>0||invoices.length>0){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="alert alert-warning">
<strong>–ö–ª–∏–µ–Ω—Ç—ä—Ç –∏–º–∞ —Å–≤—ä—Ä–∑–∞–Ω–∏ –¥–∞–Ω–Ω–∏:</strong>
${orders.length>0?`<br>‚Ä¢ ${orders.length} –ø–æ—Ä—ä—á–∫–∏`:''}
${invoices.length>0?`<br>‚Ä¢ ${invoices.length} —Ñ–∞–∫—Ç—É—Ä–∏`:''}
${unpaidInvoices.length>0?`<br>‚Ä¢ ${unpaidInvoices.length} –Ω–µ–ø–ª–∞—Ç–µ–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏ (${unpaidInvoices.reduce((s,i)=>s+i.total,0).toFixed(2)} –ª–≤)`:''}
</div>
<p>–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –∏ –≤—Å–∏—á–∫–∏ —Å–≤—ä—Ä–∑–∞–Ω–∏ –¥–∞–Ω–Ω–∏!</p>
<button class="btn btn-danger" onclick="App.confirmDeleteClient('${id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π –≤—Å–∏—á–∫–æ</button>
<button class="btn btn-secondary" onclick="UI.closeModal()">‚ùå –û—Ç–∫–∞–∂–∏</button>
</div>
</div>`;
UI.modal(html);
}else{
UI.confirm(`–ò–∑—Ç—Ä–∏–π –∫–ª–∏–µ–Ω—Ç "${client.name}"?`,()=>{
DS.delete('clients',id);
UI.closeModal();
UI.toast('‚úÖ –ö–ª–∏–µ–Ω—Ç –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
}
},

confirmDeleteClient(id){
const client=DS.find('clients',id);
const orders=DS.d.orders.filter(o=>o.clientId===id);
const invoices=DS.d.invoices.filter(i=>i.clientId===id);
const payments=DS.d.payments.filter(p=>p.clientId===id);
const receivables=DS.d.receivables.filter(r=>r.clientId===id);

// Find all related revenues
const revenues=[];
payments.forEach(p=>{
const rev=DS.d.revenues.find(r=>r.source.includes(p.reference));
if(rev)revenues.push(rev);
});
invoices.forEach(inv=>{
const invRevs=DS.d.revenues.filter(r=>r.invoiceId===inv.id);
invRevs.forEach(r=>{if(!revenues.includes(r))revenues.push(r)});
});

// Find all related deliveries and documents
const deliveries=[];
const documents=[];
orders.forEach(o=>{
const del=DS.d.deliveries.find(d=>d.orderId===o.id);
if(del)deliveries.push(del);
const docs=DS.d.documents.filter(d=>d.relatedType==='Order'&&d.relatedId===o.id);
docs.forEach(doc=>documents.push(doc));
});

let deletedCount=0;

// Delete in correct order (dependencies first)
revenues.forEach(r=>{DS.delete('revenues',r.id);deletedCount++});
payments.forEach(p=>{DS.delete('payments',p.id);deletedCount++});
receivables.forEach(r=>{DS.delete('receivables',r.id);deletedCount++});
invoices.forEach(i=>{DS.delete('invoices',i.id);deletedCount++});
deliveries.forEach(d=>{DS.delete('deliveries',d.id);deletedCount++});
documents.forEach(d=>{DS.delete('documents',d.id);deletedCount++});
orders.forEach(o=>{DS.delete('orders',o.id);deletedCount++});

// Finally delete client
DS.delete('clients',id);
deletedCount++;

UI.closeModal();
UI.toast(`‚úÖ ${client.name} –∏ ${deletedCount} —Å–≤—ä—Ä–∑–∞–Ω–∏ –∑–∞–ø–∏—Å–∞ –∏–∑—Ç—Ä–∏—Ç–∏!`);
App.render();
},

switchTab(event,tabName){
const tabs=document.querySelectorAll('.tab');
const contents=document.querySelectorAll('.tab-content');
tabs.forEach(t=>t.classList.remove('active'));
contents.forEach(c=>c.classList.add('hidden'));
event.target.classList.add('active');
document.getElementById('tab-'+tabName).classList.remove('hidden');
},

renderOrders(){
let orders=DS.d.orders;
if(this.searchQuery){
orders=orders.filter(o=>
o.id.toLowerCase().includes(this.searchQuery.toLowerCase())||
o.client.toLowerCase().includes(this.searchQuery.toLowerCase())||
o.materials.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus==='unpaid'){
const unpaidIds=this.getUnpaidOrders().map(o=>o.id);
orders=orders.filter(o=>unpaidIds.includes(o.id));
}
else if(this.filterStatus==='uninvoiced'){
const uninvoicedIds=this.getUninvoicedOrders().map(o=>o.id);
orders=orders.filter(o=>uninvoicedIds.includes(o.id));
}
else if(this.filterStatus!=='all'){
orders=orders.filter(o=>o.status===this.filterStatus);
}

return `<div class="header">
<div>
<div class="header-title">üì¶ –ü–æ—Ä—ä—á–∫–∏</div>
<div class="header-subtitle">${orders.length} –æ—Ç ${DS.d.orders.length}</div>
</div>
<button class="header-btn" onclick="App.addOrder()">+ –ù–æ–≤–∞</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –ø–æ—Ä—ä—á–∫–∞..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='pending'?'active':''}" 
onclick="App.filterStatus='pending';App.render()">–ß–∞–∫–∞—â–∏</button>
<button class="filter-btn ${this.filterStatus==='active'?'active':''}" 
onclick="App.filterStatus='active';App.render()">–ê–∫—Ç–∏–≤–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='delivered'?'active':''}" 
onclick="App.filterStatus='delivered';App.render()">–î–æ—Å—Ç–∞–≤–µ–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='unpaid'?'active':''}" 
onclick="App.filterStatus='unpaid';App.render()" style="background:${this.filterStatus==='unpaid'?'var(--red)':''}">üî¥ –ù–µ–ø–ª–∞—Ç–µ–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='uninvoiced'?'active':''}" 
onclick="App.filterStatus='uninvoiced';App.render()" style="background:${this.filterStatus==='uninvoiced'?'var(--orange)':''}">‚ö†Ô∏è –ù–µ—Ñ–∞–∫—Ç—É—Ä–∏—Ä–∞–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='cancelled'?'active':''}" 
onclick="App.filterStatus='cancelled';App.render()">–û—Ç–∫–∞–∑–∞–Ω–∏</button>
</div>

<div class="section">
${orders.length===0?UI.empty('üì¶','–ù—è–º–∞ –ø–æ—Ä—ä—á–∫–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∞—Ç–∞ –ø–æ—Ä—ä—á–∫–∞'):orders.map(o=>{
const paymentStatus=this.getOrderPaymentStatus(o.id);
const hasInvoice=DS.d.invoices.find(inv=>inv.orderId===o.id);
const isUninvoiced=o.status==='delivered'&&!hasInvoice;

// Get remaining amount for unpaid orders
let remainingAmount=0;
if(!paymentStatus.paid&&o.status==='delivered'&&hasInvoice){
const receivable=DS.d.receivables.find(r=>r.invoiceId===hasInvoice.id);
if(receivable&&receivable.remainingAmount>0)remainingAmount=receivable.remainingAmount;
}

// Determine border color
let borderStyle='';
if(isUninvoiced){
borderStyle='border-left:3px solid var(--orange)';
}else if(!paymentStatus.paid&&o.status==='delivered'&&remainingAmount>0){
borderStyle='border-left:3px solid var(--red)';
}

return `<div class="card" onclick="App.viewOrder('${o.id}')" style="${borderStyle}">
<div class="card-header">
<div class="card-title">${o.id}</div>
<div style="display:flex;gap:4px;align-items:center">
${isUninvoiced?`<span class="badge" style="background:var(--orange);font-size:10px">‚ö†Ô∏è –ë–ï–ó –§–ê–ö–¢–£–†–ê</span>`:''}
${o.status==='delivered'&&!paymentStatus.paid&&remainingAmount>0?`<span class="badge" style="background:var(--red);font-size:10px">üí≥ ${remainingAmount.toLocaleString()} –ª–≤</span>`:''}
<span class="badge badge-${o.status}">${o.status}</span>
</div>
</div>
<div class="card-body">
<strong>${o.client}</strong><br>
${o.materials}<br>
üí∞ ${o.finalValue} –ª–≤ ${o.discount>0?'(-'+o.discount+'%)':''} ¬∑ ‚öñÔ∏è ${o.weight}—Ç<br>
üìÖ ${o.date} ${o.time}
${o.priority==='urgent'?'<br><span style="color:var(--red);font-weight:700">üî¥ –°–ü–ï–®–ù–ê</span>':''}
${isUninvoiced?`<br><span style="color:var(--orange);font-weight:600">‚ö†Ô∏è ${Math.floor((new Date()-new Date(o.date))/86400000)} –¥–Ω–∏ –±–µ–∑ —Ñ–∞–∫—Ç—É—Ä–∞</span>`:''}
${o.status==='delivered'&&!paymentStatus.paid&&paymentStatus.overdueDays>0&&remainingAmount>0?`<br><span style="color:var(--red);font-weight:600">‚è∞ ${paymentStatus.overdueDays} –¥–Ω–∏ –ø—Ä–æ—Å—Ä–æ—á–∏–µ</span>`:''}
</div>
</div>`;
}).join('')}
</div>
</div>

${this.renderNav()}`;
},

addOrder(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–∞ –ø–æ—Ä—ä—á–∫–∞</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddOrder(event)">
<div class="form-group">
<label>–ö–ª–∏–µ–Ω—Ç *</label>
<select id="clientId" required onchange="App.updateClientDiscount()">
<option value="">–ò–∑–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç</option>
${DS.d.clients.map(c=>`<option value="${c.id}" data-discount="${c.discount}">${c.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–ú–∞—Ç–µ—Ä–∏–∞–ª *</label>
<select id="materialId" required onchange="App.updateMaterialPrice()">
<option value="">–ò–∑–±–µ—Ä–∏ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
${DS.d.materials.map(m=>`<option value="${m.id}" data-price="${m.price}" data-name="${m.name}">${m.name} - ${m.price} –ª–≤/${m.unit}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
<input type="number" id="quantity" required placeholder="100" oninput="App.calculateOrderTotal()">
</div>
<div class="form-group">
<label>–¢–µ–≥–ª–æ (—Ç–æ–Ω–∞) *</label>
<input type="number" id="weight" step="0.1" required placeholder="5.5">
</div>
<div class="form-group">
<label>–ï–¥–∏–Ω–∏—á–Ω–∞ —Ü–µ–Ω–∞ (–ª–≤) *</label>
<input type="number" id="value" step="0.01" required placeholder="–¶–µ–Ω–∞ –∑–∞ 1 –µ–¥–∏–Ω–∏—Ü–∞" oninput="App.calculateOrderTotal()">
<small style="color:var(--gray6);font-size:11px">–¶–µ–Ω–∞ –∑–∞ 1 –µ–¥–∏–Ω–∏—Ü–∞ - –æ–±—â–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç —â–µ —Å–µ –∏–∑—á–∏—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</small>
</div>
<div class="form-group">
<label>% –û—Ç—Å—Ç—ä–ø–∫–∞</label>
<input type="number" id="discount" value="0" min="0" max="100" oninput="App.calculateOrderTotal()">
<small style="color:var(--gray6);font-size:11px">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ –≤—ä–≤–µ–¥–∏ —Ä—ä—á–Ω–æ</small>
</div>
<div class="form-group">
<label>–ö—Ä–∞–π–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç (–ª–≤)</label>
<input type="number" id="finalValue" required readonly style="background:var(--gray1);font-weight:700">
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ *</label>
<input type="date" id="date" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–ß–∞—Å *</label>
<input type="time" id="time" required value="09:00">
</div>
<div class="form-group">
<label>–ê–¥—Ä–µ—Å –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ *</label>
<input type="text" id="address" required placeholder="–°–æ—Ñ–∏—è, —É–ª. –°—Ç—Ä–æ–∏—Ç–µ–ª 42">
</div>
<div class="form-group">
<label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
<select id="priority">
<option value="normal">–ù–æ—Ä–º–∞–ª–µ–Ω</option>
<option value="urgent">–°–ø–µ—à–µ–Ω</option>
</select>
</div>
<div class="form-group">
<label>–ë–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes" placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
</div>
<button type="submit" class="btn">–°—ä–∑–¥–∞–π –ø–æ—Ä—ä—á–∫–∞</button>
</form>
</div>
</div>`;

UI.modal(html);
},

updateClientDiscount(){
const select=document.getElementById('clientId');
const option=select.options[select.selectedIndex];
const discount=option.dataset.discount||0;
document.getElementById('discount').value=discount;
this.calculateOrderTotal();
},

updateMaterialPrice(){
const select=document.getElementById('materialId');
const option=select.options[select.selectedIndex];
const unitPrice=parseFloat(option.dataset.price)||0;
const quantity=parseFloat(document.getElementById('quantity').value)||0;

// Set the UNIT PRICE (not total)
document.getElementById('value').value=unitPrice.toFixed(2);

// Show calculation info
const materialName=option.dataset.name||'';
if(unitPrice>0&&materialName&&quantity>0){
const totalValue=unitPrice*quantity;
UI.toast(`‚ÑπÔ∏è ${materialName}: ${unitPrice} –ª–≤ √ó ${quantity} = ${totalValue.toFixed(2)} –ª–≤`);
}

// Recalculate final value (will multiply by quantity)
this.calculateOrderTotal();
},

calculateOrderTotal(){
const quantity=parseFloat(document.getElementById('quantity')?.value)||1;
const unitPrice=parseFloat(document.getElementById('value')?.value)||0;
const discount=parseFloat(document.getElementById('discount')?.value)||0;

// Calculate total: quantity √ó unit price
const totalValue=quantity*unitPrice;

// Apply discount
const finalValue=totalValue*(1-discount/100);

document.getElementById('finalValue').value=finalValue.toFixed(2);
},

calculateEditOrderTotal(){
const quantity=parseFloat(document.getElementById('quantity')?.value)||1;
const unitPrice=parseFloat(document.getElementById('value')?.value)||0;
const discount=parseFloat(document.getElementById('discount')?.value)||0;

// Calculate total: quantity √ó unit price
const totalValue=quantity*unitPrice;

// Apply discount
const finalValue=totalValue*(1-discount/100);

document.getElementById('finalValue').value=finalValue.toFixed(2);
},

handleAddOrder(e){
e.preventDefault();
const clientId=document.getElementById('clientId').value;
const materialId=document.getElementById('materialId').value;
const client=DS.find('clients',clientId);
const material=DS.find('materials',materialId);

const order={
clientId,
client:client.name,
materialId,
materials:material.name+' '+document.getElementById('quantity').value+' '+material.unit,
quantity:Number(document.getElementById('quantity').value),
weight:Number(document.getElementById('weight').value),
value:Number(document.getElementById('value').value),
discount:Number(document.getElementById('discount').value),
finalValue:Number(document.getElementById('finalValue').value),
date:document.getElementById('date').value,
time:document.getElementById('time').value,
address:document.getElementById('address').value,
priority:document.getElementById('priority').value,
notes:document.getElementById('notes').value,
status:'pending'
};

DS.add('orders',order);

DS.update('clients',clientId,{
orders:client.orders+1,
turnover:(client.turnover||0)+order.finalValue
});

UI.closeModal();
UI.toast('‚úÖ –ü–æ—Ä—ä—á–∫–∞ —Å—ä–∑–¥–∞–¥–µ–Ω–∞!');
this.render();
},

viewOrder(id){
const o=DS.find('orders',id);
if(!o)return;
const driver=DS.find('staff',o.staffId);
const vehicle=DS.find('vehicles',o.vehicleId);
const client=DS.find('clients',o.clientId);
const delivery=DS.d.deliveries.find(d=>d.orderId===id);
const invoice=DS.d.invoices.find(inv=>inv.orderId===id);

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìÅ –ü–æ—Ä—ä—á–∫–∞ ${o.id}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">

<div class="detail-section">
<div class="detail-title">–°—Ç–∞—Ç—É—Å</div>
<div style="text-align:center;padding:10px">
<span class="badge badge-${o.status}" style="font-size:16px;padding:8px 16px">${o.status.toUpperCase()}</span>
${o.priority==='urgent'?'<br><br><span style="color:var(--red);font-weight:700">üî¥ –°–ü–ï–®–ù–ê –ü–û–†–™–ß–ö–ê</span>':''}
</div>
</div>

<div class="detail-section">
<div class="detail-title">–ö–ª–∏–µ–Ω—Ç</div>
<div class="detail-row">
<div class="detail-label">–§–∏—Ä–º–∞</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();UI.closeModal();App.viewClient('${o.clientId}')">${o.client}</a></div>
</div>
${client?`<div class="detail-row">
<div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
<div class="detail-value"><a href="tel:${client.phone}">${client.phone}</a></div>
</div>`:''}
</div>

<div class="detail-section">
<div class="detail-title">–ú–∞—Ç–µ—Ä–∏–∞–ª–∏ & –¶–µ–Ω–∞</div>
<div class="detail-row">
<div class="detail-label">–ú–∞—Ç–µ—Ä–∏–∞–ª–∏</div>
<div class="detail-value">${o.materials}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
<div class="detail-value">${o.quantity}</div>
</div>
<div class="detail-row">
<div class="detail-label">–¢–µ–≥–ª–æ</div>
<div class="detail-value">${o.weight} —Ç–æ–Ω–∞</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–æ–π–Ω–æ—Å—Ç</div>
<div class="detail-value">${o.value} –ª–≤</div>
</div>
${o.discount>0?`<div class="detail-row">
<div class="detail-label">–û—Ç—Å—Ç—ä–ø–∫–∞</div>
<div class="detail-value" style="color:var(--green)">${o.discount}%</div>
</div>`:''}
<div class="detail-row">
<div class="detail-label">–ö—Ä–∞–π–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç</div>
<div class="detail-value" style="font-size:18px;color:var(--blue)">${o.finalValue} –ª–≤</div>
</div>
</div>

${(()=>{
const paymentStatus=this.getOrderPaymentStatus(o.id);
if(o.status!=='delivered')return '';
return `<div class="detail-section">
<div class="detail-title">üí≥ –ü–ª–∞—â–∞–Ω–µ</div>
<div style="text-align:center;padding:15px;background:${paymentStatus.paid?'rgba(52,199,89,0.1)':'rgba(255,59,48,0.1)'};border-radius:8px">
${paymentStatus.paid?
`<div style="font-size:40px">‚úÖ</div>
<div style="font-size:16px;font-weight:600;color:var(--green);margin-top:8px">–ü–õ–ê–¢–ï–ù–ê</div>`:
`<div style="font-size:40px">‚ùå</div>
<div style="font-size:16px;font-weight:600;color:var(--red);margin-top:8px">–ù–ï–ü–õ–ê–¢–ï–ù–ê</div>
${paymentStatus.overdueDays>0?`<div style="font-size:13px;color:var(--red);margin-top:4px">‚è∞ ${paymentStatus.overdueDays} –¥–Ω–∏ –ø—Ä–æ—Å—Ä–æ—á–∏–µ</div>`:''}`
}
</div>
${!paymentStatus.paid&&!invoice?`<div style="margin-top:8px;font-size:12px;color:var(--gray6);text-align:center">
üí° –°—ä–∑–¥–∞–π—Ç–µ —Ñ–∞–∫—Ç—É—Ä–∞ –∑–∞ –¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞—Ç–µ –ø–ª–∞—â–∞–Ω–µ
</div>`:''}
</div>`;
})()}

<div class="detail-section">
<div class="detail-title">–î–æ—Å—Ç–∞–≤–∫–∞</div>
<div class="detail-row">
<div class="detail-label">–î–∞—Ç–∞</div>
<div class="detail-value">${o.date}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ß–∞—Å</div>
<div class="detail-value">${o.time}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ê–¥—Ä–µ—Å</div>
<div class="detail-value">${o.address}</div>
</div>
${driver?`<div class="detail-row">
<div class="detail-label">–®–æ—Ñ—å–æ—Ä</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();UI.closeModal();App.viewStaff('${o.staffId}')">${driver.name}</a></div>
</div>`:''}
${vehicle?`<div class="detail-row">
<div class="detail-label">–ê–≤—Ç–æ–º–æ–±–∏–ª</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();UI.closeModal();App.viewVehicle('${o.vehicleId}')">${vehicle.model} (${vehicle.reg})</a></div>
</div>`:''}
${delivery?`<div class="detail-row">
<div class="detail-label">–î–æ—Å—Ç–∞–≤–∫–∞</div>
<div class="detail-value"><span class="badge badge-${delivery.status}">${delivery.status}</span></div>
</div>`:''}
</div>

${invoice?`<div class="detail-section">
<div class="detail-title">–§–∞–∫—Ç—É—Ä–∞</div>
<div class="detail-row">
<div class="detail-label">–ù–æ–º–µ—Ä</div>
<div class="detail-value">${invoice.id}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—É–º–∞</div>
<div class="detail-value">${invoice.total} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${invoice.status==='paid'?'delivered':'pending'}">${invoice.status}</span></div>
</div>
</div>`:''}

${o.notes?`<div class="detail-section">
<div class="detail-title">–ë–µ–ª–µ–∂–∫–∏</div>
<p style="font-size:14px;color:var(--gray6)">${o.notes}</p>
</div>`:''}

<button class="btn" onclick="App.editOrder('${o.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
${o.status==='pending'?`<button class="btn btn-success" onclick="App.assignOrder('${o.id}')">üöÄ –ù–∞–∑–Ω–∞—á–∏ —Ä–µ—Å—É—Ä—Å–∏</button>`:''}
${o.status==='active'?`<button class="btn btn-success" onclick="App.completeOrder('${o.id}')">‚úÖ –ü—Ä–∏–∫–ª—é—á–∏</button>`:''}
<button class="btn btn-secondary" onclick="App.changeOrderStatus('${o.id}')">üîÑ –ü—Ä–æ–º–µ–Ω–∏ —Å—Ç–∞—Ç—É—Å</button>
${!invoice&&o.status==='delivered'?`<button class="btn btn-secondary" onclick="App.createInvoice('${o.id}')">üßæ –°—ä–∑–¥–∞–π —Ñ–∞–∫—Ç—É—Ä–∞</button>`:''}
<button class="btn btn-danger" onclick="App.deleteOrder('${o.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editOrder(id){
const o=DS.find('orders',id);
if(!o)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π ${o.id}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditOrder(event,'${id}')">
<div class="form-group">
<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
<input type="number" id="quantity" value="${o.quantity}" required oninput="App.calculateEditOrderTotal()">
</div>
<div class="form-group">
<label>–¢–µ–≥–ª–æ</label>
<input type="number" id="weight" step="0.1" value="${o.weight}" required>
</div>
<div class="form-group">
<label>–ï–¥–∏–Ω–∏—á–Ω–∞ —Ü–µ–Ω–∞ (–ª–≤)</label>
<input type="number" id="value" step="0.01" value="${o.value}" required oninput="App.calculateEditOrderTotal()">
<small style="color:var(--gray6);font-size:11px">–û–±—â–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç: ${o.quantity} √ó —Ü–µ–Ω–∞</small>
</div>
<div class="form-group">
<label>% –û—Ç—Å—Ç—ä–ø–∫–∞</label>
<input type="number" id="discount" value="${o.discount||0}" min="0" max="100" oninput="App.calculateEditOrderTotal()">
</div>
<div class="form-group">
<label>–ö—Ä–∞–π–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç (–ª–≤)</label>
<input type="number" id="finalValue" value="${o.finalValue}" readonly style="background:var(--gray1);font-weight:700">
</div>
<div class="form-group">
<label>–î–∞—Ç–∞</label>
<input type="date" id="date" value="${o.date}" required>
</div>
<div class="form-group">
<label>–ß–∞—Å</label>
<input type="time" id="time" value="${o.time}" required>
</div>
<div class="form-group">
<label>–ê–¥—Ä–µ—Å</label>
<input type="text" id="address" value="${o.address}" required>
</div>
<div class="form-group">
<label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
<select id="priority">
<option value="normal" ${o.priority==='normal'?'selected':''}>–ù–æ—Ä–º–∞–ª–µ–Ω</option>
<option value="urgent" ${o.priority==='urgent'?'selected':''}>–°–ø–µ—à–µ–Ω</option>
</select>
</div>
<div class="form-group">
<label>–ë–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes">${o.notes||''}</textarea>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditOrder(e,id){
e.preventDefault();
const updates={
quantity:Number(document.getElementById('quantity').value),
weight:Number(document.getElementById('weight').value),
value:Number(document.getElementById('value').value),
discount:Number(document.getElementById('discount').value)||0,
finalValue:Number(document.getElementById('finalValue').value),
date:document.getElementById('date').value,
time:document.getElementById('time').value,
address:document.getElementById('address').value,
priority:document.getElementById('priority').value,
notes:document.getElementById('notes').value
};

DS.update('orders',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.viewOrder(id);
},

assignOrder(id){
const o=DS.find('orders',id);

// Count active orders per vehicle
const vehicleOrders={};
DS.d.orders.filter(ord=>ord.status==='active'&&ord.vehicleId).forEach(ord=>{
vehicleOrders[ord.vehicleId]=(vehicleOrders[ord.vehicleId]||0)+1;
});

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–∞–∑–Ω–∞—á–∏ —Ä–µ—Å—É—Ä—Å–∏ - ${o.id}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAssignOrder(event,'${id}')">
<div class="form-group">
<label>–®–æ—Ñ—å–æ—Ä *</label>
<select id="staffId" required>
<option value="">–ò–∑–±–µ—Ä–∏ —à–æ—Ñ—å–æ—Ä</option>
${DS.d.staff.filter(s=>s.position==='–®–æ—Ñ—å–æ—Ä'&&s.status==='active').map(s=>`
<option value="${s.id}">${s.name}</option>
`).join('')}
</select>
</div>
<div class="form-group">
<label>–ê–≤—Ç–æ–º–æ–±–∏–ª *</label>
<select id="vehicleId" required>
<option value="">–ò–∑–±–µ—Ä–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</option>
${DS.d.vehicles.filter(v=>v.status!=='inactive'&&v.status!=='maintenance').map(v=>{
const activeCount=vehicleOrders[v.id]||0;
const statusLabel=v.status==='available'?'üü¢ –°–≤–æ–±–æ–¥–µ–Ω':activeCount>0?`üü° –ó–∞–µ—Ç (${activeCount})`:v.status;
return `<option value="${v.id}">${v.model} (${v.reg}) - ${v.capacity}—Ç ${statusLabel}</option>`;
}).join('')}
</select>
<small style="color:var(--gray6);font-size:11px">üü¢ –°–≤–æ–±–æ–¥–µ–Ω | üü° –ó–∞–µ—Ç —Å –¥—Ä—É–≥–∞ –ø–æ—Ä—ä—á–∫–∞</small>
</div>
<button type="submit" class="btn">–ù–∞–∑–Ω–∞—á–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleAssignOrder(e,id){
e.preventDefault();
const o=DS.find('orders',id);
const staffId=document.getElementById('staffId').value;
const vehicleId=document.getElementById('vehicleId').value;
const driver=DS.find('staff',staffId);
const vehicle=DS.find('vehicles',vehicleId);

DS.update('orders',id,{staffId,vehicleId,status:'active'});
DS.update('vehicles',vehicleId,{status:'active'});

const delivery={
orderId:id,
clientId:o.clientId,
client:o.client,
driverId:staffId,
driver:driver.name,
vehicleId,
vehicle:vehicle.model+' ('+vehicle.reg+')',
status:'in-progress',
startTime:o.time,
eta:'',
distance:0,
route:o.address
};
DS.add('deliveries',delivery);

UI.closeModal();
UI.toast('‚úÖ –ü–æ—Ä—ä—á–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞!');
this.viewOrder(id);
},

completeOrder(id){
if(confirm('–ü—Ä–∏–∫–ª—é—á–∏ –ø–æ—Ä—ä—á–∫–∞—Ç–∞?')){
const o=DS.find('orders',id);
DS.update('orders',id,{status:'delivered'});
if(o.vehicleId){
DS.update('vehicles',o.vehicleId,{status:'available'});
}
const delivery=DS.d.deliveries.find(d=>d.orderId===id);
if(delivery){
DS.update('deliveries',delivery.id,{status:'completed',endTime:new Date().toLocaleTimeString('bg-BG',{hour:'2-digit',minute:'2-digit'})});
}
UI.closeModal();
UI.toast('‚úÖ –ü–æ—Ä—ä—á–∫–∞ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∞!');
this.render();
}
},

changeOrderStatus(id){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ü—Ä–æ–º–µ–Ω–∏ —Å—Ç–∞—Ç—É—Å</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<button class="btn" style="background:var(--orange)" onclick="App.updateOrderStatus('${id}','pending')">‚è≥ –ß–∞–∫–∞—â–∞</button>
<button class="btn" style="background:var(--blue)" onclick="App.updateOrderStatus('${id}','active')">üöÄ –ê–∫—Ç–∏–≤–Ω–∞</button>
<button class="btn btn-success" onclick="App.updateOrderStatus('${id}','delivered')">‚úÖ –î–æ—Å—Ç–∞–≤–µ–Ω–∞</button>
<button class="btn btn-danger" onclick="App.updateOrderStatus('${id}','cancelled')">‚ùå –û—Ç–∫–∞–∑–∞–Ω–∞</button>
</div>
</div>`;

UI.modal(html);
},

updateOrderStatus(id,status){
DS.update('orders',id,{status});
UI.closeModal();
UI.toast('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–µ–Ω!');
this.viewOrder(id);
},

createInvoice(orderId){
const o=DS.find('orders',orderId);
const client=DS.find('clients',o.clientId);
const company=Auth.company;
const invoiceNum=company.invoicePrefix+'-'+(new Date().getFullYear())+'-'+(DS.d.invoices.length+1).toString().padStart(3,'0');

const vat=company.vatEnabled?o.finalValue*0.2:0;
const total=o.finalValue+vat;

const invoice={
id:invoiceNum,
orderId,
clientId:o.clientId,
client:o.client,
amount:o.finalValue,
vat,
total,
status:'pending',
issueDate:new Date().toISOString().split('T')[0],
dueDate:new Date(Date.now()+30*86400000).toISOString().split('T')[0]
};

DS.add('invoices',invoice);

const receivable={
invoiceId:invoiceNum,
clientId:o.clientId,
client:o.client,
totalAmount:total,
paidAmount:0,
remainingAmount:total,
dueDate:invoice.dueDate,
status:'pending',
notes:''
};
DS.add('receivables',receivable);

// Auto-create document record
const document={
type:'–§–∞–∫—Ç—É—Ä–∞',
name:invoiceNum,
date:invoice.issueDate,
relatedType:'Order',
relatedId:orderId,
status:'issued',
notes:`–§–∞–∫—Ç—É—Ä–∞ –∑–∞ –ø–æ—Ä—ä—á–∫–∞ ${orderId} - ${o.client}`
};
DS.add('documents',document);

UI.closeModal();
UI.toast('‚úÖ –§–∞–∫—Ç—É—Ä–∞ —Å—ä–∑–¥–∞–¥–µ–Ω–∞: '+invoiceNum);
this.viewOrder(orderId);
},

deleteOrder(id){
const o=DS.find('orders',id);
if(!o)return;

// Find all related records
const invoice=DS.d.invoices.find(inv=>inv.orderId===id);
const payments=invoice?DS.d.payments.filter(p=>p.invoiceId===invoice.id):[];
const receivable=invoice?DS.d.receivables.find(r=>r.invoiceId===invoice.id):null;
const revenues=payments.map(p=>DS.d.revenues.find(r=>r.source.includes(p.reference))).filter(Boolean);
const delivery=DS.d.deliveries.find(d=>d.orderId===id);
const documents=DS.d.documents.filter(d=>d.relatedType==='Order'&&d.relatedId===id);

// Build warning message
let warningMsg=`–ò–∑—Ç—Ä–∏–π –ø–æ—Ä—ä—á–∫–∞: ${o.client} - ${o.material}?`;

let itemsToDelete=[];
if(invoice){
itemsToDelete.push(`‚Ä¢ –§–∞–∫—Ç—É—Ä–∞ ${invoice.id} (${invoice.total} –ª–≤)`);
}
if(payments.length>0){
const totalPaid=payments.reduce((s,p)=>s+p.amount,0);
itemsToDelete.push(`‚Ä¢ ${payments.length} –ø–ª–∞—â–∞–Ω–∏—è (${totalPaid} –ª–≤)`);
}
if(receivable){
itemsToDelete.push(`‚Ä¢ –í–∑–µ–º–∞–Ω–µ ${receivable.remainingAmount} –ª–≤`);
}
if(revenues.length>0){
const totalRev=revenues.reduce((s,r)=>s+r.amount,0);
itemsToDelete.push(`‚Ä¢ ${revenues.length} –ø—Ä–∏—Ö–æ–¥–∞ (${totalRev} –ª–≤)`);
}
if(delivery){
itemsToDelete.push(`‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞ ${delivery.id}`);
}
if(documents.length>0){
itemsToDelete.push(`‚Ä¢ ${documents.length} –¥–æ–∫—É–º–µ–Ω—Ç–∞`);
}

if(itemsToDelete.length>0){
warningMsg+=`\n\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –©–µ —Å–µ –∏–∑—Ç—Ä–∏—è—Ç –∏:\n${itemsToDelete.join('\n')}`;
warningMsg+=`\n\nüí∞ –¢–æ–≤–∞ —â–µ –ø—Ä–æ–º–µ–Ω–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∏—è –ø—Ä–µ–≥–ª–µ–¥!`;
}

UI.confirm(warningMsg,()=>{
// Delete all related records
let deletedCount=1; // Order itself

if(invoice){
DS.delete('invoices',invoice.id);
deletedCount++;
}

if(receivable){
DS.delete('receivables',receivable.id);
deletedCount++;
}

payments.forEach(p=>{
DS.delete('payments',p.id);
deletedCount++;
});

revenues.forEach(r=>{
DS.delete('revenues',r.id);
deletedCount++;
});

if(delivery){
DS.delete('deliveries',delivery.id);
deletedCount++;
}

documents.forEach(d=>{
DS.delete('documents',d.id);
deletedCount++;
});

// Finally delete the order
DS.delete('orders',id);

UI.closeModal();
UI.toast(`‚úÖ –ò–∑—Ç—Ä–∏—Ç–∏ ${deletedCount} –∑–∞–ø–∏—Å–∞! –§–∏–Ω–∞–Ω—Å–∏—Ç–µ –æ–±–Ω–æ–≤–µ–Ω–∏.`);
App.render();
});
},
renderStaff(){
let staff=DS.d.staff;
if(this.searchQuery){
staff=staff.filter(s=>
s.name.toLowerCase().includes(this.searchQuery.toLowerCase())||
s.phone.includes(this.searchQuery)
);
}

return `<div class="header">
<div>
<div class="header-title">üë∑ –ü–µ—Ä—Å–æ–Ω–∞–ª</div>
<div class="header-subtitle">${staff.length} —Å–ª—É–∂–∏—Ç–µ–ª–∏</div>
</div>
<button class="header-btn" onclick="App.addStaff()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ —Å–ª—É–∂–∏—Ç–µ–ª..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${staff.length===0?UI.empty('üë∑','–ù—è–º–∞ —Å–ª—É–∂–∏—Ç–µ–ª–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è —Å–ª—É–∂–∏—Ç–µ–ª'):staff.map(s=>`
<div class="card" onclick="App.viewStaff('${s.id}')">
<div class="card-header">
<div class="card-title">${s.name}</div>
<span class="badge badge-${s.status==='active'?'delivered':'cancelled'}">${s.status}</span>
</div>
<div class="card-body">
<strong>${s.position}</strong><br>
üìû ${s.phone} ¬∑ üìß ${s.email||'N/A'}<br>
üí∞ ${s.salary||0} –ª–≤ ¬∑ –°—Ç–∞–∂: ${s.seniority||0} –≥–æ–¥.
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addStaff(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ —Å–ª—É–∂–∏—Ç–µ–ª</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddStaff(event)">
<div class="form-group">
<label>–ò–º–µ *</label>
<input type="text" id="name" required placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
</div>
<div class="form-group">
<label>–î–ª—ä–∂–Ω–æ—Å—Ç *</label>
<select id="position" required onchange="const lg=document.getElementById('licenseGroup');this.value==='–®–æ—Ñ—å–æ—Ä'?lg.style.display='block':(lg.style.display='none',document.getElementById('licenseExpiry').value='')">
<option value="–®–æ—Ñ—å–æ—Ä">–®–æ—Ñ—å–æ—Ä</option>
<option value="–°–∫–ª–∞–¥–æ–≤">–°–∫–ª–∞–¥–æ–≤ –ø–µ—Ä—Å–æ–Ω–∞–ª</option>
<option value="–ú–µ–Ω–∏–¥–∂—ä—Ä">–ú–µ–Ω–∏–¥–∂—ä—Ä</option>
<option value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
<option value="–ú–µ—Ö–∞–Ω–∏–∫">–ú–µ—Ö–∞–Ω–∏–∫</option>
</select>
</div>
<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
<input type="tel" id="phone" required placeholder="+359 888 111 111">
</div>
<div class="form-group">
<label>Email (–æ—Ñ–∏—Å)</label>
<input type="email" id="email" placeholder="ivan@company.bg">
</div>
<div class="form-group" id="driverCredsGroup" style="display:block;background:rgba(0,122,255,0.05);padding:15px;border-radius:8px;border:1px solid rgba(0,122,255,0.2);margin:15px 0">
<strong style="color:var(--blue);margin-bottom:10px;display:block">üîê –î–∞–Ω–Ω–∏ –∑–∞ –≤—Ö–æ–¥ (—Å–∞–º–æ –∑–∞ —à–æ—Ñ—å–æ—Ä–∏)</strong>
<div style="margin-bottom:10px">
<label>Email –∑–∞ –≤—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ</label>
<input type="email" id="driverEmail" placeholder="ivan.petrov@buildflow.bg">
</div>
<div style="margin-bottom:10px">
<label>–ü–∞—Ä–æ–ª–∞</label>
<input type="text" id="driverPassword" placeholder="password123">
</div>
<button type="button" class="btn btn-secondary" style="width:100%;font-size:13px" onclick="const name=document.getElementById('name').value;if(name){const latin=App.transliterate(name).toLowerCase().replace(/[^a-z\\s]/g,'').replace(/\\s+/g,'.');document.getElementById('driverEmail').value=latin+'@buildflow.bg';document.getElementById('driverPassword').value='BF'+Math.random().toString(36).substring(2,8).toUpperCase()}else{alert('–ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ –ø—ä—Ä–≤–æ!')}">üé≤ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</button>
<small style="color:var(--gray6);font-size:11px;margin-top:8px;display:block">–¢–µ–∑–∏ –¥–∞–Ω–Ω–∏ —à–æ—Ñ—å–æ—Ä—ä—Ç —â–µ –∏–∑–ø–æ–ª–∑–≤–∞ –∑–∞ –≤—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ</small>
</div>
<div class="form-group">
<label>–ó–∞–ø–ª–∞—Ç–∞ (–ª–≤) *</label>
<input type="number" id="salary" required placeholder="2500">
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ –Ω–∞ –ø–æ—Å—Ç—ä–ø–≤–∞–Ω–µ *</label>
<input type="date" id="contractStart" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group" id="licenseGroup" style="display:block">
<label>–í–∞–ª–∏–¥–Ω–æ—Å—Ç –Ω–∞ —à–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞</label>
<input type="date" id="licenseExpiry">
<small style="color:var(--gray6);font-size:11px">–©–µ –ø–æ–ª—É—á–∏—Ç–µ –∏–∑–≤–µ—Å—Ç–∏–µ 30 –¥–Ω–∏ –ø—Ä–µ–¥–∏ –∏–∑—Ç–∏—á–∞–Ω–µ</small>
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes"></textarea>
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ —Å–ª—É–∂–∏—Ç–µ–ª</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddStaff(e){
e.preventDefault();
const name=document.getElementById('name').value;
const position=document.getElementById('position').value;
const phone=document.getElementById('phone').value;
const email=document.getElementById('email').value;
const driverEmail=document.getElementById('driverEmail')?.value||'';
const driverPassword=document.getElementById('driverPassword')?.value||'';
const salary=Number(document.getElementById('salary').value);
const contractStart=document.getElementById('contractStart').value;
const licenseExpiry=document.getElementById('licenseExpiry').value;
const notes=document.getElementById('notes').value;

const startDate=new Date(contractStart);
const now=new Date();
const years=Math.floor((now-startDate)/(365.25*24*60*60*1000));

const staff={
name,position,phone,email,salary,
contractStart,
contractEnd:'',
seniority:Math.max(0,years),
status:'active',
licenseExpiry:licenseExpiry||'',
notes,
driverEmail,
driverPassword
};

const s=DS.add('staff',staff);

const contract={
staffId:s.id,
staffName:name,
type:'–ë–µ–∑—Å—Ä–æ—á–µ–Ω',
startDate:contractStart,
endDate:'',
salary,
position,
status:'active'
};
DS.add('contracts',contract);

UI.closeModal();
UI.toast('‚úÖ –°–ª—É–∂–∏—Ç–µ–ª –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

viewStaff(id){
const s=DS.find('staff',id);
if(!s)return;

const contracts=DS.d.contracts.filter(c=>c.staffId===id);
const payrolls=DS.d.payrolls.filter(p=>p.staffId===id);
const leaves=DS.d.leaves.filter(l=>l.staffId===id);
const totalPaid=payrolls.reduce((sum,p)=>sum+p.total,0);
const totalLeaves=leaves.filter(l=>l.status==='approved').reduce((sum,l)=>sum+l.days,0);

// Calculate license status if driver
let licenseStatusHtml='';
if(s.position==='–®–æ—Ñ—å–æ—Ä'&&s.licenseExpiry){
const expiry=new Date(s.licenseExpiry);
const now=new Date();
const days=Math.floor((expiry-now)/86400000);
if(days<0){
licenseStatusHtml=`<div class="detail-row">
<div class="detail-label">–®–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞</div>
<div class="detail-value"><span style="color:var(--red)">üî¥ –ò–∑—Ç–µ–∫–ª–∞ –ø—Ä–µ–¥–∏ ${Math.abs(days)} –¥–Ω–∏</span></div>
</div>`;
}else if(days<30){
licenseStatusHtml=`<div class="detail-row">
<div class="detail-label">–®–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞</div>
<div class="detail-value"><span style="color:var(--orange)">‚ö†Ô∏è –ò–∑—Ç–∏—á–∞ —Å–ª–µ–¥ ${days} –¥–Ω–∏ (${s.licenseExpiry})</span></div>
</div>`;
}else{
licenseStatusHtml=`<div class="detail-row">
<div class="detail-label">–®–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞</div>
<div class="detail-value"><span style="color:var(--green)">‚úÖ –í–∞–ª–∏–¥–Ω–∞ –¥–æ ${s.licenseExpiry}</span></div>
</div>`;
}
}

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìÅ –î–æ—Å–∏–µ: ${s.name}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">

<div class="tabs">
<div class="tab active" onclick="App.switchTab(event,'info')">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
<div class="tab" onclick="App.switchTab(event,'contract')">–î–æ–≥–æ–≤–æ—Ä</div>
<div class="tab" onclick="App.switchTab(event,'salary')">–ó–∞–ø–ª–∞—Ç–∏ (${payrolls.length})</div>
<div class="tab" onclick="App.switchTab(event,'leaves')">–û—Ç–ø—É—Å–∫–∏ (${leaves.length})</div>
</div>

<div id="tab-info" class="tab-content">
<div class="detail-section">
<div class="detail-title">–õ–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏</div>
<div class="detail-row">
<div class="detail-label">–ò–º–µ</div>
<div class="detail-value">${s.name}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–ª—ä–∂–Ω–æ—Å—Ç</div>
<div class="detail-value">${s.position}</div>
</div>
<div class="detail-row">
<div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
<div class="detail-value"><a href="tel:${s.phone}">${s.phone}</a></div>
</div>
<div class="detail-row">
<div class="detail-label">Email</div>
<div class="detail-value">${s.email?'<a href="mailto:'+s.email+'">'+s.email+'</a>':'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${s.status==='active'?'delivered':'cancelled'}">${s.status}</span></div>
</div>
${licenseStatusHtml}
</div>

<div class="detail-section">
<div class="detail-title">–¢—Ä—É–¥–æ–≤ —Å—Ç–∞–∂</div>
<div class="detail-row">
<div class="detail-label">–ù–∞—á–∞–ª–æ</div>
<div class="detail-value">${s.contractStart||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞–∂ –≤—ä–≤ —Ñ–∏—Ä–º–∞—Ç–∞</div>
<div class="detail-value">${s.seniority||0} –≥–æ–¥.</div>
</div>
<div class="detail-row">
<div class="detail-label">–ë–∞–∑–æ–≤–∞ –∑–∞–ø–ª–∞—Ç–∞</div>
<div class="detail-value">${s.salary} –ª–≤</div>
</div>
</div>
</div>

${s.position==='–®–æ—Ñ—å–æ—Ä'&&s.driverEmail&&s.driverPassword?`
<div class="detail-section" style="background:rgba(0,122,255,0.05);border:1px solid rgba(0,122,255,0.2)">
<div class="detail-title">üîê –î–∞–Ω–Ω–∏ –∑–∞ –≤—Ö–æ–¥</div>
<div class="detail-row">
<div class="detail-label">Email</div>
<div class="detail-value"><strong>${s.driverEmail}</strong></div>
</div>
<div class="detail-row">
<div class="detail-label">–ü–∞—Ä–æ–ª–∞</div>
<div class="detail-value"><strong>${s.driverPassword}</strong></div>
</div>
<div class="detail-row">
<div class="detail-label">App URL</div>
<div class="detail-value" style="font-size:11px;word-break:break-all">${window.location.origin+window.location.pathname}</div>
</div>
<button class="btn btn-secondary" onclick="const text='üöó BuildFlow Pro - –î–∞–Ω–Ω–∏ –∑–∞ –≤—Ö–æ–¥\\n\\n–ò–º–µ: ${s.name}\\nEmail: ${s.driverEmail}\\n–ü–∞—Ä–æ–ª–∞: ${s.driverPassword}\\n\\nApp: ${window.location.origin+window.location.pathname}\\n\\n–ú–æ–ª—è, –∑–∞–ø–∞–∑–µ—Ç–µ —Ç–µ–∑–∏ –¥–∞–Ω–Ω–∏ –Ω–∞ —Å–∏–≥—É—Ä–Ω–æ –º—è—Å—Ç–æ!';navigator.clipboard.writeText(text).then(()=>alert('‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∫–æ–ø–∏—Ä–∞–Ω–∏! –ú–æ–∂–µ –¥–∞ –≥–∏ –∏–∑–ø—Ä–∞—Ç–∏—Ç–µ –Ω–∞ —à–æ—Ñ—å–æ—Ä–∞.')).catch(()=>alert(text))" style="width:100%;margin-top:10px">
üìã –ö–æ–ø–∏—Ä–∞–π –¥–∞–Ω–Ω–∏ –∑–∞ SMS
</button>
</div>
`:''}
</div>

<div id="tab-contract" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–î–æ–≥–æ–≤–æ—Ä</div>
${contracts.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ –¥–æ–≥–æ–≤–æ—Ä</p>':contracts.map(c=>`
<div style="padding:10px;border:1px solid var(--gray2);border-radius:8px;margin-bottom:10px">
<strong>–¢–∏–ø:</strong> ${c.type}<br>
<strong>–ù–∞—á–∞–ª–æ:</strong> ${c.startDate}<br>
${c.endDate?'<strong>–ö—Ä–∞–π:</strong> '+c.endDate+'<br>':''}
<strong>–ü–æ–∑–∏—Ü–∏—è:</strong> ${c.position}<br>
<strong>–ó–∞–ø–ª–∞—Ç–∞:</strong> ${c.salary} –ª–≤<br>
<span class="badge badge-${c.status==='active'?'delivered':'cancelled'}">${c.status}</span>
</div>
`).join('')}
</div>
</div>

<div id="tab-salary" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∑–∞–ø–ª–∞—Ç–∏</div>
${payrolls.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ –∑–∞–ø–ª–∞—Ç–∏</p>':payrolls.map(p=>`
<div style="padding:10px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${p.month}</strong><br>
–ë–∞–∑–æ–≤–∞: ${p.baseSalary} –ª–≤ | –ò–∑–≤—ä–Ω—Ä–µ–¥–µ–Ω: ${p.overtime} –ª–≤ | –ë–æ–Ω—É—Å: ${p.bonus} –ª–≤<br>
<strong>–û–±—â–æ: ${p.total} –ª–≤</strong> ¬∑ <span class="badge badge-${p.status==='paid'?'delivered':'pending'}">${p.status}</span>
</div>
`).join('')}
<div style="margin-top:10px;padding:10px;background:var(--gray1);border-radius:8px">
<strong>–û–±—â–∞ –∏–∑–ø–ª–∞—Ç–µ–Ω–∞ —Å—É–º–∞:</strong> ${totalPaid.toLocaleString()} –ª–≤
</div>
</div>
</div>

<div id="tab-leaves" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–û—Ç–ø—É—Å–∫–∏ –∏ –±–æ–ª–Ω–∏—á–Ω–∏</div>
${leaves.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ –æ—Ç–ø—É—Å–∫–∏</p>':leaves.map(l=>`
<div style="padding:10px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${l.type}</strong><br>
${l.startDate} ‚Üí ${l.endDate} (${l.days} –¥–Ω–∏)<br>
<span class="badge badge-${l.status==='approved'?'delivered':l.status==='pending'?'pending':'cancelled'}">${l.status}</span>
${l.notes?'<br><em>'+l.notes+'</em>':''}
</div>
`).join('')}
<div style="margin-top:10px;padding:10px;background:var(--gray1);border-radius:8px">
<strong>–û–±—â–æ –æ–¥–æ–±—Ä–µ–Ω–∏ –¥–Ω–∏:</strong> ${totalLeaves}
</div>
</div>
</div>

<button class="btn" onclick="App.editStaff('${s.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-secondary" onclick="App.addPayroll('${s.id}')">üíµ –î–æ–±–∞–≤–∏ –∑–∞–ø–ª–∞—Ç–∞</button>
<button class="btn btn-secondary" onclick="App.addLeave('${s.id}')">üèñÔ∏è –î–æ–±–∞–≤–∏ –æ—Ç–ø—É—Å–∫</button>
<button class="btn btn-danger" onclick="App.deleteStaff('${s.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editStaff(id){
const s=DS.find('staff',id);
if(!s)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Å–ª—É–∂–∏—Ç–µ–ª</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditStaff(event,'${id}')">
<div class="form-group">
<label>–ò–º–µ</label>
<input type="text" id="name" value="${s.name}" required>
</div>
<div class="form-group">
<label>–î–ª—ä–∂–Ω–æ—Å—Ç</label>
<select id="position" required onchange="const lg=document.getElementById('licenseGroup');lg.style.display=this.value==='–®–æ—Ñ—å–æ—Ä'?'block':'none'">
<option value="–®–æ—Ñ—å–æ—Ä" ${s.position==='–®–æ—Ñ—å–æ—Ä'?'selected':''}>–®–æ—Ñ—å–æ—Ä</option>
<option value="–°–∫–ª–∞–¥–æ–≤" ${s.position==='–°–∫–ª–∞–¥–æ–≤'?'selected':''}>–°–∫–ª–∞–¥–æ–≤ –ø–µ—Ä—Å–æ–Ω–∞–ª</option>
<option value="–ú–µ–Ω–∏–¥–∂—ä—Ä" ${s.position==='–ú–µ–Ω–∏–¥–∂—ä—Ä'?'selected':''}>–ú–µ–Ω–∏–¥–∂—ä—Ä</option>
<option value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" ${s.position==='–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'?'selected':''}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
<option value="–ú–µ—Ö–∞–Ω–∏–∫" ${s.position==='–ú–µ—Ö–∞–Ω–∏–∫'?'selected':''}>–ú–µ—Ö–∞–Ω–∏–∫</option>
</select>
</div>
<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
<input type="tel" id="phone" value="${s.phone}" required>
</div>
<div class="form-group">
<label>Email</label>
<input type="email" id="email" value="${s.email||''}">
</div>
<div class="form-group">
<label>–ó–∞–ø–ª–∞—Ç–∞</label>
<input type="number" id="salary" value="${s.salary}">
</div>
<div class="form-group">
<label>–°—Ç–∞—Ç—É—Å</label>
<select id="status">
<option value="active" ${s.status==='active'?'selected':''}>–ê–∫—Ç–∏–≤–µ–Ω</option>
<option value="inactive" ${s.status==='inactive'?'selected':''}>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
</select>
</div>
<div class="form-group" id="licenseGroup" style="display:${s.position==='–®–æ—Ñ—å–æ—Ä'?'block':'none'}">
<label>–í–∞–ª–∏–¥–Ω–æ—Å—Ç –Ω–∞ —à–æ—Ñ—å–æ—Ä—Å–∫–∞ –∫–Ω–∏–∂–∫–∞</label>
<input type="date" id="licenseExpiry" value="${s.licenseExpiry||''}">
<small style="color:var(--gray6);font-size:11px">–©–µ –ø–æ–ª—É—á–∏—Ç–µ –∏–∑–≤–µ—Å—Ç–∏–µ 30 –¥–Ω–∏ –ø—Ä–µ–¥–∏ –∏–∑—Ç–∏—á–∞–Ω–µ</small>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditStaff(e,id){
e.preventDefault();
const updates={
name:document.getElementById('name').value,
position:document.getElementById('position').value,
phone:document.getElementById('phone').value,
email:document.getElementById('email').value,
salary:Number(document.getElementById('salary').value),
status:document.getElementById('status').value,
licenseExpiry:document.getElementById('licenseExpiry').value||''
};

DS.update('staff',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.render();
},

deleteStaff(id){
const staff=DS.find('staff',id);
const contracts=DS.d.contracts.filter(c=>c.staffId===id);
const payrolls=DS.d.payrolls.filter(p=>p.staffId===id);
const leaves=DS.d.leaves.filter(l=>l.staffId===id);
const unpaidPayrolls=payrolls.filter(p=>p.status==='pending');

if(contracts.length>0||payrolls.length>0||leaves.length>0){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="alert alert-warning">
<strong>–°–ª—É–∂–∏—Ç–µ–ª—è—Ç –∏–º–∞ —Å–≤—ä—Ä–∑–∞–Ω–∏ –¥–∞–Ω–Ω–∏:</strong>
${contracts.length>0?`<br>‚Ä¢ ${contracts.length} –¥–æ–≥–æ–≤–æ—Ä–∏`:''}
${payrolls.length>0?`<br>‚Ä¢ ${payrolls.length} –∑–∞–ø–ª–∞—Ç–∏`:''}
${unpaidPayrolls.length>0?`<br>‚Ä¢ ${unpaidPayrolls.length} –Ω–µ–ø–ª–∞—Ç–µ–Ω–∏ –∑–∞–ø–ª–∞—Ç–∏ (${unpaidPayrolls.reduce((s,p)=>s+p.total,0).toFixed(2)} –ª–≤)`:''}
${leaves.length>0?`<br>‚Ä¢ ${leaves.length} –æ—Ç–ø—É—Å–∫–∏`:''}
</div>
<p>–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Å–ª—É–∂–∏—Ç–µ–ª—è —â–µ –∏–∑—Ç—Ä–∏–µ –∏ –≤—Å–∏—á–∫–∏ —Å–≤—ä—Ä–∑–∞–Ω–∏ –¥–∞–Ω–Ω–∏!</p>
<button class="btn btn-danger" onclick="App.confirmDeleteStaff('${id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π –≤—Å–∏—á–∫–æ</button>
<button class="btn btn-secondary" onclick="UI.closeModal()">‚ùå –û—Ç–∫–∞–∂–∏</button>
</div>
</div>`;
UI.modal(html);
}else{
UI.confirm(`–ò–∑—Ç—Ä–∏–π —Å–ª—É–∂–∏—Ç–µ–ª "${staff.name}"?`,()=>{
DS.delete('staff',id);
UI.closeModal();
UI.toast('‚úÖ –°–ª—É–∂–∏—Ç–µ–ª –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
}
},

confirmDeleteStaff(id){
DS.delete('staff',id);
DS.d.contracts.filter(c=>c.staffId===id).forEach(c=>DS.delete('contracts',c.id));
DS.d.payrolls.filter(p=>p.staffId===id).forEach(p=>DS.delete('payrolls',p.id));
DS.d.leaves.filter(l=>l.staffId===id).forEach(l=>DS.delete('leaves',l.id));
UI.closeModal();
UI.toast('‚úÖ –°–ª—É–∂–∏—Ç–µ–ª –∏ –≤—Å–∏—á–∫–∏ —Å–≤—ä—Ä–∑–∞–Ω–∏ –¥–∞–Ω–Ω–∏ –∏–∑—Ç—Ä–∏—Ç–∏!');
App.render();
},

addPayroll(staffId){
const s=DS.find('staff',staffId);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–∞ –∑–∞–ø–ª–∞—Ç–∞ - ${s.name}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddPayroll(event,'${staffId}')">
<div class="form-group">
<label>–ú–µ—Å–µ—Ü *</label>
<input type="month" id="month" required value="${new Date().toISOString().slice(0,7)}">
</div>
<div class="form-group">
<label>–ë–∞–∑–æ–≤–∞ –∑–∞–ø–ª–∞—Ç–∞ *</label>
<input type="number" id="baseSalary" required value="${s.salary}">
</div>
<div class="form-group">
<label>–ò–∑–≤—ä–Ω—Ä–µ–¥–µ–Ω —Ç—Ä—É–¥</label>
<input type="number" id="overtime" value="0">
</div>
<div class="form-group">
<label>–ë–æ–Ω—É—Å</label>
<input type="number" id="bonus" value="0">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ –∑–∞–ø–ª–∞—Ç–∞</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddPayroll(e,staffId){
e.preventDefault();
const s=DS.find('staff',staffId);
const baseSalary=Number(document.getElementById('baseSalary').value);
const overtime=Number(document.getElementById('overtime').value);
const bonus=Number(document.getElementById('bonus').value);

const payroll={
staffId,
staffName:s.name,
month:document.getElementById('month').value,
baseSalary,
overtime,
bonus,
total:baseSalary+overtime+bonus,
status:'pending'
};

DS.add('payrolls',payroll);
UI.closeModal();
UI.toast('‚úÖ –ó–∞–ø–ª–∞—Ç–∞ –¥–æ–±–∞–≤–µ–Ω–∞!');
this.viewStaff(staffId);
},

addLeave(staffId){
const s=DS.find('staff',staffId);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –æ—Ç–ø—É—Å–∫ - ${s.name}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddLeave(event,'${staffId}')">
<div class="form-group">
<label>–¢–∏–ø *</label>
<select id="type" required>
<option value="–ü–ª–∞—Ç–µ–Ω –æ—Ç–ø—É—Å–∫">–ü–ª–∞—Ç–µ–Ω –æ—Ç–ø—É—Å–∫</option>
<option value="–ë–æ–ª–Ω–∏—á–µ–Ω">–ë–æ–ª–Ω–∏—á–µ–Ω</option>
<option value="–ù–µ–ø–ª–∞—Ç–µ–Ω –æ—Ç–ø—É—Å–∫">–ù–µ–ø–ª–∞—Ç–µ–Ω –æ—Ç–ø—É—Å–∫</option>
</select>
</div>
<div class="form-group">
<label>–û—Ç –¥–∞—Ç–∞ *</label>
<input type="date" id="startDate" required>
</div>
<div class="form-group">
<label>–î–æ –¥–∞—Ç–∞ *</label>
<input type="date" id="endDate" required>
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes"></textarea>
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ –æ—Ç–ø—É—Å–∫</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddLeave(e,staffId){
e.preventDefault();
const s=DS.find('staff',staffId);
const start=new Date(document.getElementById('startDate').value);
const end=new Date(document.getElementById('endDate').value);
const days=Math.ceil((end-start)/(24*60*60*1000))+1;

const leave={
staffId,
staffName:s.name,
type:document.getElementById('type').value,
startDate:document.getElementById('startDate').value,
endDate:document.getElementById('endDate').value,
days,
status:'pending',
notes:document.getElementById('notes').value
};

DS.add('leaves',leave);
UI.closeModal();
UI.toast('‚úÖ –û—Ç–ø—É—Å–∫ –¥–æ–±–∞–≤–µ–Ω!');
this.viewStaff(staffId);
},
renderVehicles(){
let vehicles=DS.d.vehicles;
if(this.searchQuery){
vehicles=vehicles.filter(v=>
v.model.toLowerCase().includes(this.searchQuery.toLowerCase())||
v.reg.includes(this.searchQuery)
);
}

return `<div class="header">
<div>
<div class="header-title">üöõ –ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>
<div class="header-subtitle">${vehicles.length} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞</div>
</div>
<button class="header-btn" onclick="App.addVehicle()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${vehicles.length===0?UI.empty('üöõ','–ù—è–º–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª'):vehicles.map(v=>`
<div class="card" onclick="App.viewVehicle('${v.id}')">
<div class="card-header">
<div class="card-title">${v.model}</div>
<span class="badge badge-${
v.status==='available'?'delivered':
v.status==='active'?'pending':
v.status==='maintenance'?'cancelled':
'cancelled'
}">${
v.status==='available'?'üü¢ –°–≤–æ–±–æ–¥–µ–Ω':
v.status==='active'?'üü° –ó–∞–µ—Ç':
v.status==='maintenance'?'üîß –†–µ–º–æ–Ω—Ç':
v.status==='inactive'?'‚ö´ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω':
v.status
}</span>
</div>
<div class="card-body">
üöó ${v.reg} ¬∑ ‚öñÔ∏è ${v.capacity}—Ç<br>
üìè ${v.mileage?.toLocaleString()||0} –∫–º ¬∑ ‚õΩ ${v.fuel||'N/A'} ¬∑ üìÖ ${v.year}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addVehicle(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddVehicle(event)">
<div class="form-group">
<label>–ú–æ–¥–µ–ª *</label>
<input type="text" id="model" required placeholder="Mercedes Actros">
</div>
<div class="form-group">
<label>–†–µ–≥. –Ω–æ–º–µ—Ä *</label>
<input type="text" id="reg" required placeholder="–°–í 1234 –ê–í">
</div>
<div class="form-group">
<label>–ö–∞–ø–∞—Ü–∏—Ç–µ—Ç (—Ç–æ–Ω–∞) *</label>
<input type="number" id="capacity" required placeholder="12">
</div>
<div class="form-group">
<label>–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
<input type="number" id="mileage" placeholder="145000" value="0">
</div>
<div class="form-group">
<label>–ì–æ—Ä–∏–≤–æ</label>
<select id="fuel">
<option value="diesel">–î–∏–∑–µ–ª</option>
<option value="petrol">–ë–µ–Ω–∑–∏–Ω</option>
<option value="electric">–ï–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏</option>
</select>
</div>
<div class="form-group">
<label>–ì–æ–¥–∏–Ω–∞ *</label>
<input type="number" id="year" required placeholder="2020">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddVehicle(e){
e.preventDefault();
const vehicle={
model:document.getElementById('model').value,
reg:document.getElementById('reg').value,
capacity:Number(document.getElementById('capacity').value),
mileage:Number(document.getElementById('mileage').value)||0,
fuel:document.getElementById('fuel').value,
year:Number(document.getElementById('year').value),
status:'available'
};

DS.add('vehicles',vehicle);
UI.closeModal();
UI.toast('‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

viewVehicle(id){
const v=DS.find('vehicles',id);
if(!v)return;

const insurances=DS.d.insurances.filter(i=>i.vehicleId===id);
const tis=DS.d.technicalInspections.filter(t=>t.vehicleId===id);
const services=DS.d.services.filter(s=>s.vehicleId===id);
const vignettes=DS.d.vignettes.filter(vig=>vig.vehicleId===id);
const expenses=DS.d.expenses.filter(e=>e.vehicleId===id);
const deliveries=DS.d.deliveries.filter(d=>d.vehicleId===id);

const totalExpenses=expenses.reduce((s,e)=>s+e.amount,0);
const totalServices=services.reduce((s,srv)=>s+srv.cost,0);
const totalInsurances=insurances.reduce((s,i)=>s+i.premium,0);
const totalVignettes=vignettes.reduce((s,vig)=>s+vig.price,0);
const totalCost=totalExpenses+totalServices+totalInsurances+totalVignettes;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìÅ –î–æ—Å–∏–µ: ${v.model}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">

<div class="tabs">
<div class="tab active" onclick="App.switchTab(event,'info')">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
<div class="tab" onclick="App.switchTab(event,'insurance')">–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ (${insurances.length})</div>
<div class="tab" onclick="App.switchTab(event,'ti')">–¢–ü (${tis.length})</div>
<div class="tab" onclick="App.switchTab(event,'service')">–°–µ—Ä–≤–∏–∑ (${services.length})</div>
<div class="tab" onclick="App.switchTab(event,'vignette')">–í–∏–Ω–µ—Ç–∫–∏ (${vignettes.length})</div>
<div class="tab" onclick="App.switchTab(event,'costs')">–†–∞–∑—Ö–æ–¥–∏</div>
</div>

<div id="tab-info" class="tab-content">
<div class="detail-section">
<div class="detail-title">–û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
<div class="detail-row">
<div class="detail-label">–ú–æ–¥–µ–ª</div>
<div class="detail-value">${v.model}</div>
</div>
<div class="detail-row">
<div class="detail-label">–†–µ–≥. ‚Ññ</div>
<div class="detail-value">${v.reg}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ö–∞–ø–∞—Ü–∏—Ç–µ—Ç</div>
<div class="detail-value">${v.capacity} —Ç–æ–Ω–∞</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü—Ä–æ–±–µ–≥</div>
<div class="detail-value">${v.mileage?.toLocaleString()||0} –∫–º</div>
</div>
<div class="detail-row">
<div class="detail-label">–ì–æ—Ä–∏–≤–æ</div>
<div class="detail-value">${v.fuel||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ì–æ–¥–∏–Ω–∞</div>
<div class="detail-value">${v.year||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${
v.status==='available'?'delivered':
v.status==='active'?'pending':
'cancelled'
}">${
v.status==='available'?'üü¢ –°–≤–æ–±–æ–¥–µ–Ω':
v.status==='active'?'üü° –ó–∞–µ—Ç':
v.status==='maintenance'?'üîß –ù–∞ —Ä–µ–º–æ–Ω—Ç':
v.status==='inactive'?'‚ö´ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω':
v.status
}</span></div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–ï–∫—Å–ø–ª–æ–∞—Ç–∞—Ü–∏—è</div>
<div class="detail-row">
<div class="detail-label">–î–æ—Å—Ç–∞–≤–∫–∏</div>
<div class="detail-value">${deliveries.length}</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–∏ —Ä–∞–∑—Ö–æ–¥–∏</div>
<div class="detail-value" style="color:var(--red)">${totalCost.toLocaleString()} –ª–≤</div>
</div>
</div>
</div>

<div id="tab-insurance" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</div>
${insurances.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</p>':insurances.map(ins=>`
<div style="padding:10px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${ins.type}</strong><br>
${ins.provider} ¬∑ ${ins.policyNumber}<br>
–í–∞–ª–∏–¥–Ω–∞ –¥–æ: ${new Date(ins.endDate).toLocaleDateString('bg-BG')}<br>
üí∞ ${ins.premium} –ª–≤ ¬∑ <span class="badge badge-${ins.status}">${ins.status}</span>
</div>
`).join('')}
<div style="margin-top:10px">
<button class="btn btn-secondary" onclick="App.addInsuranceForVehicle('${id}')">‚ûï –î–æ–±–∞–≤–∏ –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞</button>
</div>
</div>
</div>

<div id="tab-ti" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ø—Ä–µ–≥–ª–µ–¥–∏</div>
${tis.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ –¢–ü</p>':tis.map(ti=>`
<div style="padding:10px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${ti.certificateNumber}</strong><br>
–î–∞—Ç–∞: ${new Date(ti.inspectionDate).toLocaleDateString('bg-BG')}<br>
–°–ª–µ–¥–≤–∞—â: ${new Date(ti.nextInspectionDate).toLocaleDateString('bg-BG')}<br>
–°—Ç–∞–Ω—Ü–∏—è: ${ti.station}<br>
<span class="badge badge-${ti.status}">${ti.result}</span>
</div>
`).join('')}
<div style="margin-top:10px">
<button class="btn btn-secondary" onclick="App.addTIForVehicle('${id}')">‚ûï –î–æ–±–∞–≤–∏ –¢–ü</button>
</div>
</div>
</div>

<div id="tab-service" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–°–µ—Ä–≤–∏–∑–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è</div>
${services.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ —Å–µ—Ä–≤–∏–∑–∏</p>':services.map(srv=>`
<div style="padding:10px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${srv.type}</strong> - ${srv.description}<br>
–î–∞—Ç–∞: ${new Date(srv.serviceDate).toLocaleDateString('bg-BG')}<br>
${srv.mileage?'–ü—Ä–æ–±–µ–≥: '+srv.mileage.toLocaleString()+' –∫–º<br>':''}
${srv.provider} ¬∑ üí∞ ${srv.cost} –ª–≤
${srv.nextServiceDate?'<br>–°–ª–µ–¥–≤–∞—â: '+new Date(srv.nextServiceDate).toLocaleDateString('bg-BG'):''}
</div>
`).join('')}
<div style="margin-top:10px;padding:10px;background:var(--gray1);border-radius:8px">
<strong>–û–±—â–æ —Ä–∞–∑—Ö–æ–¥–∏ –∑–∞ —Å–µ—Ä–≤–∏–∑–∏:</strong> ${totalServices.toLocaleString()} –ª–≤
</div>
<div style="margin-top:10px">
<button class="btn btn-secondary" onclick="App.addServiceForVehicle('${id}')">‚ûï –î–æ–±–∞–≤–∏ —Å–µ—Ä–≤–∏–∑</button>
</div>
</div>
</div>

<div id="tab-vignette" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–í–∏–Ω–µ—Ç–∫–∏</div>
${vignettes.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ –≤–∏–Ω–µ—Ç–∫–∏</p>':vignettes.map(vig=>`
<div style="padding:10px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${vig.country}</strong> - ${vig.type}<br>
–û—Ç: ${new Date(vig.startDate).toLocaleDateString('bg-BG')}<br>
–î–æ: ${new Date(vig.endDate).toLocaleDateString('bg-BG')}<br>
üí∞ ${vig.price} –ª–≤ ¬∑ <span class="badge badge-${vig.status}">${vig.status}</span>
</div>
`).join('')}
<div style="margin-top:10px">
<button class="btn btn-secondary" onclick="App.addVignetteForVehicle('${id}')">‚ûï –î–æ–±–∞–≤–∏ –≤–∏–Ω–µ—Ç–∫–∞</button>
</div>
</div>
</div>

<div id="tab-costs" class="tab-content hidden">
<div class="detail-section">
<div class="detail-title">–†–∞–∑—Ö–æ–¥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
<div class="detail-row">
<div class="detail-label">–ì–æ—Ä–∏–≤–æ</div>
<div class="detail-value">${expenses.filter(e=>e.category==='–ì–æ—Ä–∏–≤–æ').reduce((s,e)=>s+e.amount,0).toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–°–µ—Ä–≤–∏–∑–∏</div>
<div class="detail-value">${totalServices.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</div>
<div class="detail-value">${totalInsurances.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–í–∏–Ω–µ—Ç–∫–∏</div>
<div class="detail-value">${totalVignettes.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–æ</div>
<div class="detail-value" style="font-size:18px;color:var(--red)">${totalCost.toLocaleString()} –ª–≤</div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–ü–æ—Å–ª–µ–¥–Ω–∏ —Ä–∞–∑—Ö–æ–¥–∏</div>
${expenses.length===0?'<p style="text-align:center;color:var(--gray6);padding:20px">–ù—è–º–∞ —Ä–∞–∑—Ö–æ–¥–∏</p>':expenses.slice(0,5).map(e=>`
<div style="padding:8px;border-bottom:1px solid var(--gray1);font-size:12px">
${e.category} - ${e.description}<br>
${e.date} ¬∑ üí∞ ${e.amount} –ª–≤
</div>
`).join('')}
</div>
</div>

<button class="btn" onclick="App.editVehicle('${v.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-danger" onclick="App.deleteVehicle('${v.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editVehicle(id){
const v=DS.find('vehicles',id);
if(!v)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –∞–≤—Ç–æ–º–æ–±–∏–ª</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditVehicle(event,'${id}')">
<div class="form-group">
<label>–ú–æ–¥–µ–ª</label>
<input type="text" id="model" value="${v.model}" required>
</div>
<div class="form-group">
<label>–†–µ–≥. –Ω–æ–º–µ—Ä</label>
<input type="text" id="reg" value="${v.reg}" required>
</div>
<div class="form-group">
<label>–ö–∞–ø–∞—Ü–∏—Ç–µ—Ç</label>
<input type="number" id="capacity" value="${v.capacity}" required>
</div>
<div class="form-group">
<label>–ü—Ä–æ–±–µ–≥</label>
<input type="number" id="mileage" value="${v.mileage||0}">
</div>
<div class="form-group">
<label>–ì–æ—Ä–∏–≤–æ</label>
<select id="fuel">
<option value="diesel" ${v.fuel==='diesel'?'selected':''}>–î–∏–∑–µ–ª</option>
<option value="petrol" ${v.fuel==='petrol'?'selected':''}>–ë–µ–Ω–∑–∏–Ω</option>
<option value="electric" ${v.fuel==='electric'?'selected':''}>–ï–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏</option>
</select>
</div>
<div class="form-group">
<label>–ì–æ–¥–∏–Ω–∞</label>
<input type="number" id="year" value="${v.year}">
</div>
<div class="form-group">
<label>–°—Ç–∞—Ç—É—Å</label>
<select id="status">
<option value="available" ${v.status==='available'?'selected':''}>üü¢ –ù–∞ —Ä–∞–∑–ø–æ–ª–æ–∂–µ–Ω–∏–µ</option>
<option value="active" ${v.status==='active'?'selected':''}>üü° –ê–∫—Ç–∏–≤–µ–Ω (–∑–∞–µ—Ç)</option>
<option value="maintenance" ${v.status==='maintenance'?'selected':''}>üîß –ù–∞ —Ä–µ–º–æ–Ω—Ç</option>
<option value="inactive" ${v.status==='inactive'?'selected':''}>‚ö´ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
</select>
<small style="color:var(--gray6);font-size:11px">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ "–ù–∞ —Ä–µ–º–æ–Ω—Ç" –∏ "–ù–µ–∞–∫—Ç–∏–≤–µ–Ω" –Ω—è–º–∞ –¥–∞ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–∞–≤–∞–Ω–µ</small>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditVehicle(e,id){
e.preventDefault();
const updates={
model:document.getElementById('model').value,
reg:document.getElementById('reg').value,
capacity:Number(document.getElementById('capacity').value),
mileage:Number(document.getElementById('mileage').value),
fuel:document.getElementById('fuel').value,
year:Number(document.getElementById('year').value),
status:document.getElementById('status').value
};

DS.update('vehicles',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.render();
},

deleteVehicle(id){
const vehicle=DS.find('vehicles',id);
const deliveries=DS.d.deliveries.filter(d=>d.vehicleId===id);
const activeDeliveries=deliveries.filter(d=>d.status==='in-progress');
const insurances=DS.d.insurances.filter(i=>i.vehicleId===id);
const services=DS.d.services.filter(s=>s.vehicleId===id);
const expenses=DS.d.expenses.filter(e=>e.vehicleId===id);

if(deliveries.length>0||insurances.length>0||services.length>0||expenses.length>0){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="alert alert-warning">
<strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—ä—Ç –∏–º–∞ —Å–≤—ä—Ä–∑–∞–Ω–∏ –¥–∞–Ω–Ω–∏:</strong>
${deliveries.length>0?`<br>‚Ä¢ ${deliveries.length} –¥–æ—Å—Ç–∞–≤–∫–∏`:''}
${activeDeliveries.length>0?`<br>‚Ä¢ ${activeDeliveries.length} –ê–ö–¢–ò–í–ù–ò –¥–æ—Å—Ç–∞–≤–∫–∏`:''}
${insurances.length>0?`<br>‚Ä¢ ${insurances.length} –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏`:''}
${services.length>0?`<br>‚Ä¢ ${services.length} —Å–µ—Ä–≤–∏–∑–∏`:''}
${expenses.length>0?`<br>‚Ä¢ ${expenses.length} —Ä–∞–∑—Ö–æ–¥–∏`:''}
</div>
${activeDeliveries.length>0?`<div class="alert alert-danger">
üö® –ò–º–∞ –∞–∫—Ç–∏–≤–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏! –ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –∏–∑—Ç—Ä–∏–µ –¥–æ–∫–∞—Ç–æ –Ω–µ –∑–∞–≤—ä—Ä—à–∞—Ç.
</div>`:'<p>–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ –Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –∏ –≤—Å–∏—á–∫–∏ —Å–≤—ä—Ä–∑–∞–Ω–∏ –¥–∞–Ω–Ω–∏!</p>'}
${activeDeliveries.length===0?`<button class="btn btn-danger" onclick="App.confirmDeleteVehicle('${id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π –≤—Å–∏—á–∫–æ</button>`:''}
<button class="btn btn-secondary" onclick="UI.closeModal()">‚ùå –û—Ç–∫–∞–∂–∏</button>
</div>
</div>`;
UI.modal(html);
}else{
UI.confirm(`–ò–∑—Ç—Ä–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª "${vehicle.model} (${vehicle.reg})"?`,()=>{
DS.delete('vehicles',id);
UI.closeModal();
UI.toast('‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
}
},

confirmDeleteVehicle(id){
DS.delete('vehicles',id);
DS.d.insurances.filter(i=>i.vehicleId===id).forEach(i=>DS.delete('insurances',i.id));
DS.d.technicalInspections.filter(t=>t.vehicleId===id).forEach(t=>DS.delete('technicalInspections',t.id));
DS.d.services.filter(s=>s.vehicleId===id).forEach(s=>DS.delete('services',s.id));
DS.d.vignettes.filter(v=>v.vehicleId===id).forEach(v=>DS.delete('vignettes',v.id));
DS.d.deliveries.filter(d=>d.vehicleId===id&&d.status!=='in-progress').forEach(d=>DS.delete('deliveries',d.id));
UI.closeModal();
UI.toast('‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª –∏ –≤—Å–∏—á–∫–∏ —Å–≤—ä—Ä–∑–∞–Ω–∏ –¥–∞–Ω–Ω–∏ –∏–∑—Ç—Ä–∏—Ç–∏!');
App.render();
},

addInsuranceForVehicle(vehicleId){
const v=DS.find('vehicles',vehicleId);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–∞ –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ - ${v.model}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddInsuranceForVehicle(event,'${vehicleId}')">
<div class="form-group">
<label>–¢–∏–ø *</label>
<select id="type" required>
<option value="–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç">–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç</option>
<option value="–ö–∞—Å–∫–æ">–ö–∞—Å–∫–æ</option>
<option value="–ü—ä–ª–Ω–æ –∫–∞—Å–∫–æ">–ü—ä–ª–Ω–æ –∫–∞—Å–∫–æ</option>
</select>
</div>
<div class="form-group">
<label>–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç–µ–ª *</label>
<input type="text" id="provider" required placeholder="–ó–î –ë—É–ª—Å—Ç—Ä–∞–¥">
</div>
<div class="form-group">
<label>–ü–æ–ª–∏—Ü–∞ ‚Ññ *</label>
<input type="text" id="policyNumber" required placeholder="POL-123456">
</div>
<div class="form-group">
<label>–û—Ç –¥–∞—Ç–∞ *</label>
<input type="date" id="startDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–î–æ –¥–∞—Ç–∞ *</label>
<input type="date" id="endDate" required>
</div>
<div class="form-group">
<label>–ü—Ä–µ–º–∏—è (–ª–≤) *</label>
<input type="number" id="premium" required placeholder="850">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddInsuranceForVehicle(e,vehicleId){
e.preventDefault();
const v=DS.find('vehicles',vehicleId);
const endDate=new Date(document.getElementById('endDate').value);
const now=new Date();
const daysUntil=Math.floor((endDate-now)/86400000);
let status='valid';
if(daysUntil<0)status='expired';
else if(daysUntil<30)status='expiring';

const ins={
vehicleId,
vehicle:`${v.model} (${v.reg})`,
type:document.getElementById('type').value,
provider:document.getElementById('provider').value,
policyNumber:document.getElementById('policyNumber').value,
startDate:document.getElementById('startDate').value,
endDate:document.getElementById('endDate').value,
premium:Number(document.getElementById('premium').value),
status
};

DS.add('insurances',ins);
UI.closeModal();
UI.toast('‚úÖ –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –¥–æ–±–∞–≤–µ–Ω–∞!');
this.viewVehicle(vehicleId);
},

addTIForVehicle(vehicleId){
const v=DS.find('vehicles',vehicleId);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –¢–ü - ${v.model}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddTIForVehicle(event,'${vehicleId}')">
<div class="form-group">
<label>–î–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–≥–ª–µ–¥ *</label>
<input type="date" id="inspectionDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–°–ª–µ–¥–≤–∞—â –ø—Ä–µ–≥–ª–µ–¥ *</label>
<input type="date" id="nextInspectionDate" required>
</div>
<div class="form-group">
<label>–†–µ–∑—É–ª—Ç–∞—Ç *</label>
<select id="result" required>
<option value="–ì–æ–¥–µ–Ω">–ì–æ–¥–µ–Ω</option>
<option value="–£—Å–ª–æ–≤–Ω–æ –≥–æ–¥–µ–Ω">–£—Å–ª–æ–≤–Ω–æ –≥–æ–¥–µ–Ω</option>
<option value="–ù–µ–≥–æ–¥–µ–Ω">–ù–µ–≥–æ–¥–µ–Ω</option>
</select>
</div>
<div class="form-group">
<label>–°—Ç–∞–Ω—Ü–∏—è *</label>
<input type="text" id="station" required placeholder="–¢–ü –°–æ—Ñ–∏—è –ò–∑—Ç–æ–∫">
</div>
<div class="form-group">
<label>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç ‚Ññ *</label>
<input type="text" id="certificateNumber" required placeholder="TP-12345">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddTIForVehicle(e,vehicleId){
e.preventDefault();
const v=DS.find('vehicles',vehicleId);
const nextDate=new Date(document.getElementById('nextInspectionDate').value);
const now=new Date();
const daysUntil=Math.floor((nextDate-now)/86400000);
let status='valid';
if(daysUntil<60)status='expiring';

const ti={
vehicleId,
vehicle:`${v.model} (${v.reg})`,
inspectionDate:document.getElementById('inspectionDate').value,
nextInspectionDate:document.getElementById('nextInspectionDate').value,
result:document.getElementById('result').value,
station:document.getElementById('station').value,
certificateNumber:document.getElementById('certificateNumber').value,
status
};

DS.add('technicalInspections',ti);
UI.closeModal();
UI.toast('‚úÖ –¢–ü –¥–æ–±–∞–≤–µ–Ω!');
this.viewVehicle(vehicleId);
},

addServiceForVehicle(vehicleId){
const v=DS.find('vehicles',vehicleId);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ —Å–µ—Ä–≤–∏–∑ - ${v.model}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddServiceForVehicle(event,'${vehicleId}')">
<div class="form-group">
<label>–¢–∏–ø *</label>
<select id="type" required>
<option value="–ü–ª–∞–Ω–æ–≤–æ –æ–±—Å–ª—É–∂–≤–∞–Ω–µ">–ü–ª–∞–Ω–æ–≤–æ –æ–±—Å–ª—É–∂–≤–∞–Ω–µ</option>
<option value="–†–µ–º–æ–Ω—Ç">–†–µ–º–æ–Ω—Ç</option>
<option value="–ì—É–º–∏">–°–º—è–Ω–∞ –Ω–∞ –≥—É–º–∏</option>
<option value="–°–ø–∏—Ä–∞—á–∫–∏">–°–ø–∏—Ä–∞—á–Ω–∞ —Å–∏—Å—Ç–µ–º–∞</option>
</select>
</div>
<div class="form-group">
<label>–û–ø–∏—Å–∞–Ω–∏–µ *</label>
<input type="text" id="description" required placeholder="–°–º—è–Ω–∞ –º–∞—Å–ª–æ –∏ —Ñ–∏–ª—Ç—Ä–∏">
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ *</label>
<input type="date" id="serviceDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
<input type="number" id="mileage" placeholder="${v.mileage}">
</div>
<div class="form-group">
<label>–¶–µ–Ω–∞ (–ª–≤) *</label>
<input type="number" id="cost" required placeholder="450">
</div>
<div class="form-group">
<label>–°–µ—Ä–≤–∏–∑ *</label>
<input type="text" id="provider" required placeholder="–ú–µ—Ä—Ü–µ–¥–µ—Å –°–µ—Ä–≤–∏–∑">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddServiceForVehicle(e,vehicleId){
e.preventDefault();
const v=DS.find('vehicles',vehicleId);

const srv={
vehicleId,
vehicle:`${v.model} (${v.reg})`,
type:document.getElementById('type').value,
description:document.getElementById('description').value,
serviceDate:document.getElementById('serviceDate').value,
mileage:Number(document.getElementById('mileage').value)||null,
cost:Number(document.getElementById('cost').value),
provider:document.getElementById('provider').value
};

DS.add('services',srv);
UI.closeModal();
UI.toast('‚úÖ –°–µ—Ä–≤–∏–∑ –¥–æ–±–∞–≤–µ–Ω!');
this.viewVehicle(vehicleId);
},

addVignetteForVehicle(vehicleId){
const v=DS.find('vehicles',vehicleId);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–∞ –≤–∏–Ω–µ—Ç–∫–∞ - ${v.model}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddVignetteForVehicle(event,'${vehicleId}')">
<div class="form-group">
<label>–î—ä—Ä–∂–∞–≤–∞ *</label>
<select id="country" required>
<option value="–ë—ä–ª–≥–∞—Ä–∏—è">–ë—ä–ª–≥–∞—Ä–∏—è</option>
<option value="–†—É–º—ä–Ω–∏—è">–†—É–º—ä–Ω–∏—è</option>
<option value="–£–Ω–≥–∞—Ä–∏—è">–£–Ω–≥–∞—Ä–∏—è</option>
<option value="–ê–≤—Å—Ç—Ä–∏—è">–ê–≤—Å—Ç—Ä–∏—è</option>
</select>
</div>
<div class="form-group">
<label>–¢–∏–ø *</label>
<select id="type" required>
<option value="–î–Ω–µ–≤–Ω–∞">–î–Ω–µ–≤–Ω–∞</option>
<option value="–°–µ–¥–º–∏—á–Ω–∞">–°–µ–¥–º–∏—á–Ω–∞</option>
<option value="–ú–µ—Å–µ—á–Ω–∞">–ú–µ—Å–µ—á–Ω–∞</option>
<option value="–ì–æ–¥–∏—à–Ω–∞">–ì–æ–¥–∏—à–Ω–∞</option>
</select>
</div>
<div class="form-group">
<label>–û—Ç –¥–∞—Ç–∞ *</label>
<input type="date" id="startDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–î–æ –¥–∞—Ç–∞ *</label>
<input type="date" id="endDate" required>
</div>
<div class="form-group">
<label>–¶–µ–Ω–∞ (–ª–≤) *</label>
<input type="number" id="price" required placeholder="1470">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddVignetteForVehicle(e,vehicleId){
e.preventDefault();
const v=DS.find('vehicles',vehicleId);
const endDate=new Date(document.getElementById('endDate').value);
const now=new Date();
const status=endDate<now?'expired':'valid';

const vig={
vehicleId,
vehicle:`${v.model} (${v.reg})`,
country:document.getElementById('country').value,
type:document.getElementById('type').value,
startDate:document.getElementById('startDate').value,
endDate:document.getElementById('endDate').value,
price:Number(document.getElementById('price').value),
status
};

DS.add('vignettes',vig);
UI.closeModal();
UI.toast('‚úÖ –í–∏–Ω–µ—Ç–∫–∞ –¥–æ–±–∞–≤–µ–Ω–∞!');
this.viewVehicle(vehicleId);
},
renderDeliveries(){
let deliveries=DS.d.deliveries;
if(this.searchQuery){
deliveries=deliveries.filter(d=>
d.id.toLowerCase().includes(this.searchQuery.toLowerCase())||
d.client.toLowerCase().includes(this.searchQuery.toLowerCase())||
d.driver.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus!=='all'){
deliveries=deliveries.filter(d=>d.status===this.filterStatus);
}

return `<div class="header">
<div>
<div class="header-title">üöö –î–æ—Å—Ç–∞–≤–∫–∏</div>
<div class="header-subtitle">${deliveries.length} –¥–æ—Å—Ç–∞–≤–∫–∏</div>
</div>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –¥–æ—Å—Ç–∞–≤–∫–∞..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='in-progress'?'active':''}" 
onclick="App.filterStatus='in-progress';App.render()">–í –¥–≤–∏–∂–µ–Ω–∏–µ</button>
<button class="filter-btn ${this.filterStatus==='completed'?'active':''}" 
onclick="App.filterStatus='completed';App.render()">–ó–∞–≤—ä—Ä—à–µ–Ω–∏</button>
</div>

<div class="section">
${deliveries.length===0?UI.empty('üöö','–ù—è–º–∞ –¥–æ—Å—Ç–∞–≤–∫–∏','–ù–∞–∑–Ω–∞—á–µ—Ç–µ –ø–æ—Ä—ä—á–∫–∏ –∑–∞ –¥–æ—Å—Ç–∞–≤–∫–∞'):deliveries.map(d=>{
const paymentStatus=d.orderId?this.getOrderPaymentStatus(d.orderId):{paid:true,overdueDays:0};
return `<div class="card" onclick="App.viewDelivery('${d.id}')" style="${!paymentStatus.paid&&d.status==='completed'?'border-left:3px solid var(--red)':''}">
<div class="card-header">
<div class="card-title">${d.id}</div>
<div style="display:flex;gap:4px;align-items:center">
${d.status==='completed'&&!paymentStatus.paid?`<span class="badge" style="background:var(--red);font-size:10px">üí≥ –ù–ï–ü–õ–ê–¢–ï–ù–ê</span>`:''}
<span class="badge badge-${d.status==='completed'?'delivered':'active'}">${d.status}</span>
</div>
</div>
<div class="card-body">
<strong>${d.client}</strong><br>
üë∑ ${d.driver} ¬∑ üöõ ${d.vehicle}<br>
üìç ${d.route}${d.distance>0?' ¬∑ üìè '+d.distance+' –∫–º':''}<br>
‚è∞ ${d.startTime}${d.eta?' ‚Üí '+d.eta:''}${d.endTime?' (–∑–∞–≤—ä—Ä—à–µ–Ω–∞: '+d.endTime+')':''}
${d.status==='completed'&&!paymentStatus.paid&&paymentStatus.overdueDays>0?`<br><span style="color:var(--red);font-weight:600">üí≥ ${paymentStatus.overdueDays} –¥–Ω–∏ –Ω–µ–ø–ª–∞—Ç–µ–Ω–∞</span>`:''}
</div>
</div>`;
}).join('')}
</div>
</div>

${this.renderNav()}`;
},

viewDelivery(id){
const d=DS.find('deliveries',id);
if(!d)return;
const order=DS.find('orders',d.orderId);
const driver=DS.find('staff',d.driverId);
const vehicle=DS.find('vehicles',d.vehicleId);

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìÅ –î–æ—Å—Ç–∞–≤–∫–∞ ${d.id}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">

<div class="detail-section">
<div class="detail-title">–°—Ç–∞—Ç—É—Å</div>
<div style="text-align:center;padding:10px">
<span class="badge badge-${d.status==='completed'?'delivered':'active'}" style="font-size:16px;padding:8px 16px">${d.status.toUpperCase()}</span>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–ü–æ—Ä—ä—á–∫–∞</div>
<div class="detail-row">
<div class="detail-label">–ù–æ–º–µ—Ä</div>
<div class="detail-value">${order?'<a href="#" onclick="event.preventDefault();UI.closeModal();App.viewOrder(\''+d.orderId+'\')">'+d.orderId+'</a>':d.orderId}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ö–ª–∏–µ–Ω—Ç</div>
<div class="detail-value">${d.client}</div>
</div>
${order?`<div class="detail-row">
<div class="detail-label">–ú–∞—Ç–µ—Ä–∏–∞–ª–∏</div>
<div class="detail-value">${order.materials}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–æ–π–Ω–æ—Å—Ç</div>
<div class="detail-value">${order.finalValue} –ª–≤</div>
</div>`:''}
</div>

<div class="detail-section">
<div class="detail-title">–†–µ—Å—É—Ä—Å–∏</div>
<div class="detail-row">
<div class="detail-label">–®–æ—Ñ—å–æ—Ä</div>
<div class="detail-value">${driver?'<a href="#" onclick="event.preventDefault();UI.closeModal();App.viewStaff(\''+d.driverId+'\')">'+d.driver+'</a>':d.driver}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ê–≤—Ç–æ–º–æ–±–∏–ª</div>
<div class="detail-value">${vehicle?'<a href="#" onclick="event.preventDefault();UI.closeModal();App.viewVehicle(\''+d.vehicleId+'\')">'+d.vehicle+'</a>':d.vehicle}</div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–ú–∞—Ä—à—Ä—É—Ç</div>
<div class="detail-row">
<div class="detail-label">–ú–∞—Ä—à—Ä—É—Ç</div>
<div class="detail-value">${d.route}</div>
</div>
${d.distance>0?`<div class="detail-row">
<div class="detail-label">–†–∞–∑—Å—Ç–æ—è–Ω–∏–µ</div>
<div class="detail-value">${d.distance} –∫–º</div>
</div>`:''}
<div class="detail-row">
<div class="detail-label">–ù–∞—á–∞–ª–æ</div>
<div class="detail-value">${d.startTime}</div>
</div>
${d.eta?`<div class="detail-row">
<div class="detail-label">ETA</div>
<div class="detail-value">${d.eta}</div>
</div>`:''}
${d.endTime?`<div class="detail-row">
<div class="detail-label">–ó–∞–≤—ä—Ä—à–µ–Ω–∞</div>
<div class="detail-value">${d.endTime}</div>
</div>`:''}
</div>

${d.status==='in-progress'?`<button class="btn btn-success" onclick="App.completeDelivery('${d.id}')">‚úÖ –ó–∞–≤—ä—Ä—à–∏ –¥–æ—Å—Ç–∞–≤–∫–∞</button>`:''}
<button class="btn btn-secondary" onclick="UI.closeModal()">–ó–∞—Ç–≤–æ—Ä–∏</button>
</div>
</div>`;

UI.modal(html);
},

completeDelivery(id){
if(confirm('–ó–∞–≤—ä—Ä—à–∏ –¥–æ—Å—Ç–∞–≤–∫–∞—Ç–∞?')){
const d=DS.find('deliveries',id);
DS.update('deliveries',id,{
status:'completed',
endTime:new Date().toLocaleTimeString('bg-BG',{hour:'2-digit',minute:'2-digit'})
});

if(d.orderId){
DS.update('orders',d.orderId,{status:'delivered'});
}
if(d.vehicleId){
DS.update('vehicles',d.vehicleId,{status:'available'});
}

UI.closeModal();
UI.toast('‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∞!');
this.render();
}
},
renderMaterials(){
let materials=DS.d.materials;
if(this.searchQuery){
materials=materials.filter(m=>
m.name.toLowerCase().includes(this.searchQuery.toLowerCase())||
m.category.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}

return `<div class="header">
<div>
<div class="header-title">üß± –ú–∞—Ç–µ—Ä–∏–∞–ª–∏</div>
<div class="header-subtitle">${materials.length} –º–∞—Ç–µ—Ä–∏–∞–ª–∞</div>
</div>
<button class="header-btn" onclick="App.addMaterial()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –º–∞—Ç–µ—Ä–∏–∞–ª..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${materials.length===0?UI.empty('üß±','–ù—è–º–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª'):materials.map(m=>`
<div class="card" onclick="App.viewMaterial('${m.id}')">
<div class="card-header">
<div class="card-title">${m.name}</div>
<span class="badge badge-active">${m.category}</span>
</div>
<div class="card-body">
üí∞ ${m.price} –ª–≤ / ${m.unit}<br>
üè™ ${m.supplierName||'N/A'}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addMaterial(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddMaterial(event)">
<div class="form-group">
<label>–ò–º–µ *</label>
<input type="text" id="name" required placeholder="–¢—É—Ö–ª–∏ –∫–µ—Ä–∞–º–∏—á–Ω–∏">
</div>
<div class="form-group">
<label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
<select id="category" required>
<option value="–°—Ç—Ä–æ–∏—Ç–µ–ª–Ω–∏">–°—Ç—Ä–æ–∏—Ç–µ–ª–Ω–∏</option>
<option value="–ú–µ—Ç–∞–ª–Ω–∏">–ú–µ—Ç–∞–ª–Ω–∏</option>
<option value="–î—ä—Ä–≤–µ–Ω–∏">–î—ä—Ä–≤–µ–Ω–∏</option>
<option value="–•–∏–º–∏–∫–∞–ª–∏">–•–∏–º–∏–∫–∞–ª–∏</option>
<option value="–ï–ª–µ–∫—Ç—Ä–æ">–ï–ª–µ–∫—Ç—Ä–æ</option>
<option value="–î—Ä—É–≥–∏">–î—Ä—É–≥–∏</option>
</select>
</div>
<div class="form-group">
<label>–ú–µ—Ä–Ω–∞ –µ–¥–∏–Ω–∏—Ü–∞ *</label>
<select id="unit" required>
<option value="–±—Ä">–±—Ä–æ–π</option>
<option value="–∫–≥">–∫–∏–ª–æ–≥—Ä–∞–º–∞</option>
<option value="—Ç–æ–Ω–∞">—Ç–æ–Ω–∞</option>
<option value="–º">–º–µ—Ç—ä—Ä</option>
<option value="–º¬≤">–∫–≤–∞–¥—Ä–∞—Ç–µ–Ω –º–µ—Ç—ä—Ä</option>
<option value="–º¬≥">–∫—É–±–∏—á–µ–Ω –º–µ—Ç—ä—Ä</option>
<option value="–ª–∏—Ç—ä—Ä">–ª–∏—Ç—ä—Ä</option>
</select>
</div>
<div class="form-group">
<label>–¶–µ–Ω–∞ *</label>
<input type="number" id="price" step="0.01" required placeholder="0.15">
</div>
<div class="form-group">
<label>–î–æ—Å—Ç–∞–≤—á–∏–∫</label>
<select id="supplierId">
<option value="">–ë–µ–∑ –¥–æ—Å—Ç–∞–≤—á–∏–∫</option>
${DS.d.suppliers.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}
</select>
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ –º–∞—Ç–µ—Ä–∏–∞–ª</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddMaterial(e){
e.preventDefault();
const supplierId=document.getElementById('supplierId').value;
const supplier=supplierId?DS.find('suppliers',supplierId):null;

const material={
name:document.getElementById('name').value,
category:document.getElementById('category').value,
unit:document.getElementById('unit').value,
price:Number(document.getElementById('price').value),
supplierId:supplierId||null,
supplierName:supplier?supplier.name:null
};

DS.add('materials',material);
UI.closeModal();
UI.toast('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

viewMaterial(id){
const m=DS.find('materials',id);
if(!m)return;

const orders=DS.d.orders.filter(o=>o.materialId===id);
const inventory=DS.d.inventory.filter(inv=>inv.materialId===id);
const totalOrders=orders.reduce((s,o)=>s+o.quantity,0);
const totalStock=inventory.reduce((s,i)=>s+i.quantity,0);

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìÅ ${m.name}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">

<div class="detail-section">
<div class="detail-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
<div class="detail-row">
<div class="detail-label">–ò–º–µ</div>
<div class="detail-value">${m.name}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
<div class="detail-value">${m.category}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú—è—Ä–∫–∞</div>
<div class="detail-value">${m.unit}</div>
</div>
<div class="detail-row">
<div class="detail-label">–¶–µ–Ω–∞</div>
<div class="detail-value">${m.price} –ª–≤ / ${m.unit}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–æ—Å—Ç–∞–≤—á–∏–∫</div>
<div class="detail-value">${m.supplierName?'<a href="#" onclick="event.preventDefault();UI.closeModal();App.viewSupplier(\''+m.supplierId+'\')">'+m.supplierName+'</a>':'N/A'}</div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
<div class="detail-row">
<div class="detail-label">–ü–æ—Ä—ä—á–∫–∏</div>
<div class="detail-value">${orders.length}</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–æ –ø–æ—Ä—ä—á–∞–Ω–æ</div>
<div class="detail-value">${totalOrders} ${m.unit}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ù–∞–ª–∏—á–Ω–æ—Å—Ç</div>
<div class="detail-value">${totalStock} ${m.unit}</div>
</div>
</div>

${orders.length>0?`<div class="detail-section">
<div class="detail-title">–ü–æ—Å–ª–µ–¥–Ω–∏ –ø–æ—Ä—ä—á–∫–∏</div>
${orders.slice(0,5).map(o=>`
<div style="padding:8px;border-bottom:1px solid var(--gray1);font-size:12px">
<strong>${o.id}</strong> - ${o.client}<br>
${o.quantity} ${m.unit} ¬∑ ${o.date} ¬∑ <span class="badge badge-${o.status}">${o.status}</span>
</div>
`).join('')}
</div>`:''}

<button class="btn" onclick="App.editMaterial('${m.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-danger" onclick="App.deleteMaterial('${m.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editMaterial(id){
const m=DS.find('materials',id);
if(!m)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –º–∞—Ç–µ—Ä–∏–∞–ª</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditMaterial(event,'${id}')">
<div class="form-group">
<label>–ò–º–µ</label>
<input type="text" id="name" value="${m.name}" required>
</div>
<div class="form-group">
<label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
<select id="category" required>
<option value="–°—Ç—Ä–æ–∏—Ç–µ–ª–Ω–∏" ${m.category==='–°—Ç—Ä–æ–∏—Ç–µ–ª–Ω–∏'?'selected':''}>–°—Ç—Ä–æ–∏—Ç–µ–ª–Ω–∏</option>
<option value="–ú–µ—Ç–∞–ª–Ω–∏" ${m.category==='–ú–µ—Ç–∞–ª–Ω–∏'?'selected':''}>–ú–µ—Ç–∞–ª–Ω–∏</option>
<option value="–î—ä—Ä–≤–µ–Ω–∏" ${m.category==='–î—ä—Ä–≤–µ–Ω–∏'?'selected':''}>–î—ä—Ä–≤–µ–Ω–∏</option>
<option value="–•–∏–º–∏–∫–∞–ª–∏" ${m.category==='–•–∏–º–∏–∫–∞–ª–∏'?'selected':''}>–•–∏–º–∏–∫–∞–ª–∏</option>
<option value="–ï–ª–µ–∫—Ç—Ä–æ" ${m.category==='–ï–ª–µ–∫—Ç—Ä–æ'?'selected':''}>–ï–ª–µ–∫—Ç—Ä–æ</option>
<option value="–î—Ä—É–≥–∏" ${m.category==='–î—Ä—É–≥–∏'?'selected':''}>–î—Ä—É–≥–∏</option>
</select>
</div>
<div class="form-group">
<label>–ú–µ—Ä–Ω–∞ –µ–¥–∏–Ω–∏—Ü–∞</label>
<select id="unit" required>
<option value="–±—Ä" ${m.unit==='–±—Ä'?'selected':''}>–±—Ä–æ–π</option>
<option value="–∫–≥" ${m.unit==='–∫–≥'?'selected':''}>–∫–∏–ª–æ–≥—Ä–∞–º–∞</option>
<option value="—Ç–æ–Ω–∞" ${m.unit==='—Ç–æ–Ω–∞'?'selected':''}>—Ç–æ–Ω–∞</option>
<option value="–º" ${m.unit==='–º'?'selected':''}>–º–µ—Ç—ä—Ä</option>
<option value="–º¬≤" ${m.unit==='–º¬≤'?'selected':''}>–∫–≤–∞–¥—Ä–∞—Ç–µ–Ω –º–µ—Ç—ä—Ä</option>
<option value="–º¬≥" ${m.unit==='–º¬≥'?'selected':''}>–∫—É–±–∏—á–µ–Ω –º–µ—Ç—ä—Ä</option>
<option value="–ª–∏—Ç—ä—Ä" ${m.unit==='–ª–∏—Ç—ä—Ä'?'selected':''}>–ª–∏—Ç—ä—Ä</option>
</select>
</div>
<div class="form-group">
<label>–¶–µ–Ω–∞</label>
<input type="number" id="price" step="0.01" value="${m.price}" required>
</div>
<div class="form-group">
<label>–î–æ—Å—Ç–∞–≤—á–∏–∫</label>
<select id="supplierId">
<option value="">–ë–µ–∑ –¥–æ—Å—Ç–∞–≤—á–∏–∫</option>
${DS.d.suppliers.map(s=>`<option value="${s.id}" ${m.supplierId===s.id?'selected':''}>${s.name}</option>`).join('')}
</select>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditMaterial(e,id){
e.preventDefault();
const supplierId=document.getElementById('supplierId').value;
const supplier=supplierId?DS.find('suppliers',supplierId):null;

const updates={
name:document.getElementById('name').value,
category:document.getElementById('category').value,
unit:document.getElementById('unit').value,
price:Number(document.getElementById('price').value),
supplierId:supplierId||null,
supplierName:supplier?supplier.name:null
};

DS.update('materials',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.render();
},

deleteMaterial(id){
UI.confirm('–ò–∑—Ç—Ä–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª?',()=>{
DS.delete('materials',id);
UI.closeModal();
UI.toast('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
},
renderInvoices(){
let invoices=DS.d.invoices;
if(this.searchQuery){
invoices=invoices.filter(i=>
i.id.toLowerCase().includes(this.searchQuery.toLowerCase())||
i.client.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus!=='all'){
invoices=invoices.filter(i=>i.status===this.filterStatus);
}

const totalPending=invoices.filter(i=>i.status==='pending').reduce((s,i)=>s+i.total,0);
const totalPaid=invoices.filter(i=>i.status==='paid').reduce((s,i)=>s+i.total,0);

return `<div class="header">
<div>
<div class="header-title">üßæ –§–∞–∫—Ç—É—Ä–∏</div>
<div class="header-subtitle">${invoices.length} —Ñ–∞–∫—Ç—É—Ä–∏</div>
</div>
</div>

<div class="container">
<div class="section">
<div class="stats" style="grid-template-columns:repeat(2,1fr)">
<div class="stat">
<div class="stat-icon">‚è≥</div>
<div class="stat-value" style="color:var(--orange)">${totalPending.toLocaleString()}</div>
<div class="stat-label">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</div>
</div>
<div class="stat">
<div class="stat-icon">‚úÖ</div>
<div class="stat-value" style="color:var(--green)">${totalPaid.toLocaleString()}</div>
<div class="stat-label">–ü–ª–∞—Ç–µ–Ω–∏</div>
</div>
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ —Ñ–∞–∫—Ç—É—Ä–∞..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='pending'?'active':''}" 
onclick="App.filterStatus='pending';App.render()">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='paid'?'active':''}" 
onclick="App.filterStatus='paid';App.render()">–ü–ª–∞—Ç–µ–Ω–∏</button>
</div>

<div class="section">
${invoices.length===0?UI.empty('üßæ','–ù—è–º–∞ —Ñ–∞–∫—Ç—É—Ä–∏',''):invoices.sort((a,b)=>new Date(b.issueDate)-new Date(a.issueDate)).map(inv=>`
<div class="card" onclick="App.viewInvoice('${inv.id}')">
<div class="card-header">
<div class="card-title">${inv.id}</div>
<span class="badge badge-${inv.status==='paid'?'delivered':'pending'}">${inv.status}</span>
</div>
<div class="card-body">
<strong>${inv.client}</strong><br>
üí∞ ${inv.amount} –ª–≤ + –î–î–° ${inv.vat} –ª–≤ = <strong>${inv.total} –ª–≤</strong><br>
üìÖ –ò–∑–¥–∞–¥–µ–Ω–∞: ${inv.issueDate} ${inv.dueDate?' ¬∑ –ü–∞–¥–µ–∂: '+inv.dueDate:''}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

viewInvoice(id){
const inv=DS.find('invoices',id);
if(!inv)return;
const payments=DS.d.payments.filter(p=>p.invoiceId===id);
const totalPaid=payments.reduce((s,p)=>s+p.amount,0);

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üßæ ${inv.id}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-row">
<div class="detail-label">–ö–ª–∏–µ–Ω—Ç</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewClient('${inv.clientId}')">${inv.client}</a></div>
</div>
<div class="detail-row">
<div class="detail-label">–°—É–º–∞</div>
<div class="detail-value">${inv.amount} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–î–° (20%)</div>
<div class="detail-value">${inv.vat} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–æ</div>
<div class="detail-value" style="font-size:20px;font-weight:800">${inv.total} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü–ª–∞—Ç–µ–Ω–æ</div>
<div class="detail-value" style="color:var(--green)">${totalPaid} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–û—Å—Ç–∞—Ç—ä–∫</div>
<div class="detail-value" style="color:var(--red)">${(inv.total-totalPaid).toFixed(2)} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ò–∑–¥–∞–¥–µ–Ω–∞</div>
<div class="detail-value">${inv.issueDate}</div>
</div>
${inv.dueDate?`<div class="detail-row">
<div class="detail-label">–ü–∞–¥–µ–∂</div>
<div class="detail-value">${inv.dueDate}</div>
</div>`:''}
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${inv.status==='paid'?'delivered':'pending'}">${inv.status}</span></div>
</div>
</div>

${payments.length>0?`<div class="detail-section">
<div class="detail-title">–ü–ª–∞—â–∞–Ω–∏—è</div>
${payments.map(p=>`
<div style="padding:8px;border-bottom:1px solid var(--gray1);font-size:12px">
${p.date} ¬∑ ${p.amount} –ª–≤ ¬∑ ${p.method}
</div>
`).join('')}
</div>`:''}

${totalPaid<inv.total?`<button class="btn btn-success" onclick="App.addPaymentForInvoice('${inv.id}',${inv.total-totalPaid})">üí≥ –î–æ–±–∞–≤–∏ –ø–ª–∞—â–∞–Ω–µ</button>`:''}
</div>
</div>`;

UI.modal(html);
},

addPaymentForInvoice(invoiceId,remaining){
const inv=DS.find('invoices',invoiceId);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–æ –ø–ª–∞—â–∞–Ω–µ</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddPaymentForInvoice(event,'${invoiceId}')">
<div class="form-group">
<label>–°—É–º–∞ (–ª–≤) *</label>
<input type="number" step="0.01" id="amount" required value="${remaining.toFixed(2)}" max="${remaining}">
</div>
<div class="form-group">
<label>–ú–µ—Ç–æ–¥ *</label>
<select id="method" required>
<option value="cash">üíµ –í –±—Ä–æ–π</option>
<option value="card">üí≥ –° –∫–∞—Ä—Ç–∞</option>
<option value="bank">üè¶ –ü–æ –±–∞–Ω–∫–∞</option>
</select>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ *</label>
<input type="date" id="date" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–†–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è</label>
<input type="text" id="reference" placeholder="–ù–∞–ø—Ä. BNK-20240101">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ –ø–ª–∞—â–∞–Ω–µ</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddPaymentForInvoice(e,invoiceId){
e.preventDefault();
const inv=DS.find('invoices',invoiceId);
const amount=Number(document.getElementById('amount').value);

const payment={
invoiceId,
clientId:inv.clientId,
client:inv.client,
amount,
method:document.getElementById('method').value,
date:document.getElementById('date').value,
status:'completed',
reference:document.getElementById('reference').value||'PMT-'+Date.now()
};

DS.add('payments',payment);

const revenue={
source:'–§–∞–∫—Ç—É—Ä–∞ '+invoiceId,
amount,
method:payment.method,
date:payment.date,
invoiceId,
clientId:inv.clientId
};
DS.add('revenues',revenue);

const payments=DS.d.payments.filter(p=>p.invoiceId===invoiceId);
const totalPaid=payments.reduce((s,p)=>s+p.amount,0)+amount;

if(totalPaid>=inv.total){
DS.update('invoices',invoiceId,{status:'paid',paidDate:payment.date});
const receivable=DS.d.receivables.find(r=>r.invoiceId===invoiceId);
if(receivable){
DS.update('receivables',receivable.id,{
paidAmount:totalPaid,
remainingAmount:inv.total-totalPaid,
status:totalPaid>=inv.total?'paid':'partial'
});
}
}

UI.closeModal();
UI.toast('‚úÖ –ü–ª–∞—â–∞–Ω–µ –¥–æ–±–∞–≤–µ–Ω–æ!');
this.viewInvoice(invoiceId);
},

renderPayments(){
let payments=DS.d.payments;
if(this.searchQuery){
payments=payments.filter(p=>
p.id.toLowerCase().includes(this.searchQuery.toLowerCase())||
p.client.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}

const totalPayments=payments.reduce((s,p)=>s+p.amount,0);

return `<div class="header">
<div>
<div class="header-title">üí≥ –ü–ª–∞—â–∞–Ω–∏—è</div>
<div class="header-subtitle">${payments.length} ¬∑ ${totalPayments.toLocaleString()} –ª–≤</div>
</div>
<button class="header-btn" onclick="App.addPayment()">+ –ù–æ–≤–æ</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –ø–ª–∞—â–∞–Ω–µ..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${payments.length===0?UI.empty('üí≥','–ù—è–º–∞ –ø–ª–∞—â–∞–Ω–∏—è',''):payments.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(p=>`
<div class="card" onclick="App.viewPayment('${p.id}')">
<div class="card-header">
<div class="card-title">${p.client}</div>
<span class="badge badge-${p.status==='completed'?'delivered':'pending'}">${p.method}</span>
</div>
<div class="card-body">
üí∞ ${p.amount} –ª–≤<br>
üìÖ ${p.date} ¬∑ üßæ ${p.invoiceId||'N/A'}<br>
${p.reference?'üìù '+p.reference:''}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addPayment(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–æ –ø–ª–∞—â–∞–Ω–µ</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddPaymentStandalone(event)">
<div class="form-group">
<label>–ö–ª–∏–µ–Ω—Ç *</label>
<select id="clientId" required>
<option value="">–ò–∑–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç</option>
${DS.d.clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–§–∞–∫—Ç—É—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)</label>
<select id="invoiceId">
<option value="">-- –ë–µ–∑ —Ñ–∞–∫—Ç—É—Ä–∞ --</option>
${DS.d.invoices.filter(i=>i.status==='pending').map(i=>`<option value="${i.id}">${i.id} - ${i.client} (${i.total} –ª–≤)</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–°—É–º–∞ (–ª–≤) *</label>
<input type="number" step="0.01" id="amount" required placeholder="1500">
</div>
<div class="form-group">
<label>–ú–µ—Ç–æ–¥ *</label>
<select id="method" required>
<option value="cash">üíµ –í –±—Ä–æ–π</option>
<option value="card">üí≥ –° –∫–∞—Ä—Ç–∞</option>
<option value="bank">üè¶ –ü–æ –±–∞–Ω–∫–∞</option>
</select>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ *</label>
<input type="date" id="date" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–†–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è</label>
<input type="text" id="reference" placeholder="PMT-12345">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ –ø–ª–∞—â–∞–Ω–µ</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddPaymentStandalone(e){
e.preventDefault();
const clientId=document.getElementById('clientId').value;
const client=DS.find('clients',clientId);
const invoiceId=document.getElementById('invoiceId').value;
const amount=Number(document.getElementById('amount').value);

const payment={
clientId,
client:client.name,
invoiceId:invoiceId||null,
amount,
method:document.getElementById('method').value,
date:document.getElementById('date').value,
status:'completed',
reference:document.getElementById('reference').value||'PMT-'+Date.now()
};

DS.add('payments',payment);

const revenue={
source:invoiceId?'–§–∞–∫—Ç—É—Ä–∞ '+invoiceId:'–ü–ª–∞—â–∞–Ω–µ –æ—Ç '+client.name,
amount,
method:payment.method,
date:payment.date,
invoiceId:invoiceId||null,
clientId
};
DS.add('revenues',revenue);

if(invoiceId){
const inv=DS.find('invoices',invoiceId);
const payments=DS.d.payments.filter(p=>p.invoiceId===invoiceId);
const totalPaid=payments.reduce((s,p)=>s+p.amount,0)+amount;

if(totalPaid>=inv.total){
DS.update('invoices',invoiceId,{status:'paid',paidDate:payment.date});
const receivable=DS.d.receivables.find(r=>r.invoiceId===invoiceId);
if(receivable){
DS.update('receivables',receivable.id,{
paidAmount:totalPaid,
remainingAmount:inv.total-totalPaid,
status:'paid'
});
}
}
}

UI.closeModal();
UI.toast('‚úÖ –ü–ª–∞—â–∞–Ω–µ –¥–æ–±–∞–≤–µ–Ω–æ!');
this.render();
},

viewPayment(id){
const p=DS.find('payments',id);
if(!p)return;

const client=DS.find('clients',p.clientId);
const invoice=p.invoiceId?DS.find('invoices',p.invoiceId):null;
const revenue=DS.d.revenues.find(r=>r.source.includes(p.reference)||r.clientId===p.clientId&&r.amount===p.amount);

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üí≥ –ü–ª–∞—â–∞–Ω–µ: ${p.reference}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –ø–ª–∞—â–∞–Ω–µ—Ç–æ</div>
<div class="detail-row">
<div class="detail-label">–ö–ª–∏–µ–Ω—Ç</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewClient('${p.clientId}')">${p.client}</a></div>
</div>
${invoice?`<div class="detail-row">
<div class="detail-label">–§–∞–∫—Ç—É—Ä–∞</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewInvoice('${invoice.id}')">${invoice.id}</a></div>
</div>`:''}
<div class="detail-row">
<div class="detail-label">–°—É–º–∞</div>
<div class="detail-value" style="font-size:20px;font-weight:800;color:var(--green)">${p.amount} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–µ—Ç–æ–¥</div>
<div class="detail-value">${p.method==='cash'?'üíµ –í –±—Ä–æ–π':p.method==='card'?'üí≥ –° –∫–∞—Ä—Ç–∞':'üè¶ –ü–æ –±–∞–Ω–∫–∞'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–∞—Ç–∞</div>
<div class="detail-value">${p.date}</div>
</div>
<div class="detail-row">
<div class="detail-label">–†–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è</div>
<div class="detail-value">${p.reference}</div>
</div>
${revenue?`<div class="alert alert-info">
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—ä–∑–¥–∞–¥–µ–Ω –ø—Ä–∏—Ö–æ–¥ –æ—Ç ${revenue.amount} –ª–≤
</div>`:''}
</div>

<button class="btn btn-danger" onclick="App.deletePayment('${p.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

deletePayment(id){
const p=DS.find('payments',id);
const invoice=p.invoiceId?DS.find('invoices',p.invoiceId):null;
const revenue=DS.d.revenues.find(r=>r.source.includes(p.reference)||r.clientId===p.clientId&&r.amount===p.amount);

let warningMsg=`–ò–∑—Ç—Ä–∏–π –ø–ª–∞—â–∞–Ω–µ: ${p.amount} –ª–≤ –æ—Ç ${p.client}?`;
if(invoice){
warningMsg+=`\n\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–≤–∞ —â–µ –ø—Ä–æ–º–µ–Ω–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞ ${invoice.id}!`;
const payments=DS.d.payments.filter(pm=>pm.invoiceId===invoice.id&&pm.id!==id);
const remainingPaid=payments.reduce((s,pm)=>s+pm.amount,0);
if(remainingPaid===0){
warningMsg+=`\n–§–∞–∫—Ç—É—Ä–∞—Ç–∞ —â–µ —Å—Ç–∞–Ω–µ "–ù–ï–ü–õ–ê–¢–ï–ù–ê".`;
}else{
warningMsg+=`\n–ü–ª–∞—Ç–µ–Ω–∞—Ç–∞ —Å—É–º–∞ —â–µ —Å—Ç–∞–Ω–µ ${remainingPaid} –ª–≤.`;
}
}
if(revenue){
warningMsg+=`\n\nüí∞ –©–µ —Å–µ –∏–∑—Ç—Ä–∏–µ –∏ —Å–≤—ä—Ä–∑–∞–Ω–∏—è—Ç –ø—Ä–∏—Ö–æ–¥ –æ—Ç ${revenue.amount} –ª–≤!`;
}

UI.confirm(warningMsg,()=>{
if(invoice){
const payments=DS.d.payments.filter(pm=>pm.invoiceId===invoice.id&&pm.id!==id);
const totalPaid=payments.reduce((s,pm)=>s+pm.amount,0);
const newStatus=totalPaid>=invoice.total?'paid':'pending';
DS.update('invoices',invoice.id,{status:newStatus});

const receivable=DS.d.receivables.find(r=>r.invoiceId===invoice.id);
if(receivable){
DS.update('receivables',receivable.id,{
paidAmount:totalPaid,
remainingAmount:invoice.total-totalPaid,
status:newStatus
});
}
}

if(revenue){
DS.delete('revenues',revenue.id);
}

DS.delete('payments',id);
UI.closeModal();
UI.toast('‚úÖ –ü–ª–∞—â–∞–Ω–µ –∏–∑—Ç—Ä–∏—Ç–æ –∏ –≤—Å–∏—á–∫–∏ –º–æ–¥—É–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞–Ω–∏!');
App.render();
});
},

renderExpenses(){
let expenses=DS.d.expenses;
if(this.searchQuery){
expenses=expenses.filter(e=>
e.description.toLowerCase().includes(this.searchQuery.toLowerCase())||
e.category.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.activeTab!=='all'){
expenses=expenses.filter(e=>e.category===this.activeTab);
}

const totalExpenses=expenses.reduce((s,e)=>s+e.amount,0);
const byCategory={};
DS.d.expenses.forEach(e=>{
byCategory[e.category]=(byCategory[e.category]||0)+e.amount;
});

return `<div class="header">
<div>
<div class="header-title">üí∏ –†–∞–∑—Ö–æ–¥–∏</div>
<div class="header-subtitle">${expenses.length} –∑–∞–ø–∏—Å–∞ ¬∑ ${totalExpenses.toLocaleString()} –ª–≤</div>
</div>
<button class="header-btn" onclick="App.addExpense()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="section">
<div class="section-title">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
<div class="stats" style="grid-template-columns:repeat(3,1fr)">
<div class="stat">
<div class="stat-icon">‚õΩ</div>
<div class="stat-value">${(byCategory['–ì–æ—Ä–∏–≤–æ']||0).toLocaleString()}</div>
<div class="stat-label">–ì–æ—Ä–∏–≤–æ</div>
</div>
<div class="stat">
<div class="stat-icon">‚öôÔ∏è</div>
<div class="stat-value">${(byCategory['–û–±—Å–ª—É–∂–≤–∞–Ω–µ']||0).toLocaleString()}</div>
<div class="stat-label">–û–±—Å–ª—É–∂–≤–∞–Ω–µ</div>
</div>
<div class="stat">
<div class="stat-icon">üíµ</div>
<div class="stat-value">${(byCategory['–ó–∞–ø–ª–∞—Ç–∏']||0).toLocaleString()}</div>
<div class="stat-label">–ó–∞–ø–ª–∞—Ç–∏</div>
</div>
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ —Ä–∞–∑—Ö–æ–¥..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="tabs">
<div class="tab ${this.activeTab==='all'?'active':''}" onclick="App.activeTab='all';App.render()">–í—Å–∏—á–∫–∏</div>
<div class="tab ${this.activeTab==='–ì–æ—Ä–∏–≤–æ'?'active':''}" onclick="App.activeTab='–ì–æ—Ä–∏–≤–æ';App.render()">–ì–æ—Ä–∏–≤–æ</div>
<div class="tab ${this.activeTab==='–û–±—Å–ª—É–∂–≤–∞–Ω–µ'?'active':''}" onclick="App.activeTab='–û–±—Å–ª—É–∂–≤–∞–Ω–µ';App.render()">–û–±—Å–ª—É–∂–≤–∞–Ω–µ</div>
<div class="tab ${this.activeTab==='–ó–∞–ø–ª–∞—Ç–∏'?'active':''}" onclick="App.activeTab='–ó–∞–ø–ª–∞—Ç–∏';App.render()">–ó–∞–ø–ª–∞—Ç–∏</div>
<div class="tab ${this.activeTab==='–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏'?'active':''}" onclick="App.activeTab='–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏';App.render()">–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏</div>
</div>

<div class="section">
${expenses.length===0?UI.empty('üí∏','–ù—è–º–∞ —Ä–∞–∑—Ö–æ–¥–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è —Ä–∞–∑—Ö–æ–¥'):expenses.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(e=>`
<div class="card" onclick="App.viewExpense('${e.id}')">
<div class="card-header">
<div class="card-title">${e.category}</div>
<span class="badge badge-${e.method==='cash'?'warning':'active'}">${e.method}</span>
</div>
<div class="card-body">
${e.description}<br>
üìÖ ${e.date} ¬∑ üí∞ ${e.amount} –ª–≤<br>
${e.vehicleId?'üöõ ':''}${e.approvedBy?'‚úÖ '+e.approvedBy:''}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addExpense(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ —Ä–∞–∑—Ö–æ–¥</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddExpense(event)">
<div class="form-group">
<label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
<select id="category" required>
<option value="–ì–æ—Ä–∏–≤–æ">‚õΩ –ì–æ—Ä–∏–≤–æ</option>
<option value="–û–±—Å–ª—É–∂–≤–∞–Ω–µ">‚öôÔ∏è –û–±—Å–ª—É–∂–≤–∞–Ω–µ</option>
<option value="–ó–∞–ø–ª–∞—Ç–∏">üíµ –ó–∞–ø–ª–∞—Ç–∏</option>
<option value="–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏">üõ°Ô∏è –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</option>
<option value="–í–∏–Ω–µ—Ç–∫–∏">üé´ –í–∏–Ω–µ—Ç–∫–∏</option>
<option value="–ù–∞–µ–º">üè¢ –ù–∞–µ–º</option>
<option value="–ö–æ–º—É–Ω–∞–ª–Ω–∏">üí° –ö–æ–º—É–Ω–∞–ª–Ω–∏</option>
<option value="–û—Ñ–∏—Å –º–∞—Ç–µ—Ä–∏–∞–ª–∏">üìÑ –û—Ñ–∏—Å –º–∞—Ç–µ—Ä–∏–∞–ª–∏</option>
<option value="–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏">üîß –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏</option>
<option value="–î—Ä—É–≥–æ">üìù –î—Ä—É–≥–æ</option>
</select>
</div>
<div class="form-group">
<label>–û–ø–∏—Å–∞–Ω–∏–µ *</label>
<input type="text" id="description" required placeholder="–ù–∞–ø—Ä. –ì–æ—Ä–∏–≤–æ –∑–∞ –°–í 1234 –ê–í">
</div>
<div class="form-group">
<label>–°—É–º–∞ (–ª–≤) *</label>
<input type="number" step="0.01" id="amount" required placeholder="350">
</div>
<div class="form-group">
<label>–ú–µ—Ç–æ–¥ –Ω–∞ –ø–ª–∞—â–∞–Ω–µ *</label>
<select id="method" required>
<option value="cash">üíµ –í –±—Ä–æ–π</option>
<option value="card">üí≥ –° –∫–∞—Ä—Ç–∞</option>
<option value="bank">üè¶ –ü–æ –±–∞–Ω–∫–∞</option>
</select>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ *</label>
<input type="date" id="date" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–ê–≤—Ç–æ–º–æ–±–∏–ª (–∞–∫–æ –µ –ø—Ä–∏–ª–æ–∂–∏–º–æ)</label>
<select id="vehicleId">
<option value="">-- –ë–µ–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª --</option>
${DS.d.vehicles.map(v=>`<option value="${v.id}">${v.model} (${v.reg})</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–û–¥–æ–±—Ä–µ–Ω–æ –æ—Ç</label>
<input type="text" id="approvedBy" placeholder="${Auth.user?.name||'Admin'}">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ —Ä–∞–∑—Ö–æ–¥</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddExpense(e){
e.preventDefault();
const expense={
category:document.getElementById('category').value,
description:document.getElementById('description').value,
amount:Number(document.getElementById('amount').value),
method:document.getElementById('method').value,
date:document.getElementById('date').value,
vehicleId:document.getElementById('vehicleId').value||null,
approvedBy:document.getElementById('approvedBy').value||Auth.user?.name||'Admin'
};

DS.add('expenses',expense);
UI.closeModal();
UI.toast('‚úÖ –†–∞–∑—Ö–æ–¥ –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

viewExpense(id){
const e=DS.find('expenses',id);
if(!e)return;

const vehicle=e.vehicleId?DS.find('vehicles',e.vehicleId):null;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üí∏ –†–∞–∑—Ö–æ–¥: ${e.category}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–∞–∑—Ö–æ–¥–∞</div>
<div class="detail-row">
<div class="detail-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
<div class="detail-value">${e.category}</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
<div class="detail-value">${e.description}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—É–º–∞</div>
<div class="detail-value" style="font-size:20px;font-weight:800;color:var(--red)">${e.amount} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–µ—Ç–æ–¥</div>
<div class="detail-value">${e.method==='cash'?'üíµ –í –±—Ä–æ–π':e.method==='card'?'üí≥ –° –∫–∞—Ä—Ç–∞':'üè¶ –ü–æ –±–∞–Ω–∫–∞'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–∞—Ç–∞</div>
<div class="detail-value">${e.date}</div>
</div>
${vehicle?`<div class="detail-row">
<div class="detail-label">–ê–≤—Ç–æ–º–æ–±–∏–ª</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewVehicle('${e.vehicleId}')">${vehicle.model} (${vehicle.reg})</a></div>
</div>`:''}
<div class="detail-row">
<div class="detail-label">–û–¥–æ–±—Ä–µ–Ω–æ –æ—Ç</div>
<div class="detail-value">${e.approvedBy||'N/A'}</div>
</div>
</div>

<button class="btn" onclick="App.editExpense('${e.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-danger" onclick="App.deleteExpense('${e.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editExpense(id){
const e=DS.find('expenses',id);
if(!e)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Ä–∞–∑—Ö–æ–¥</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditExpense(event,'${id}')">
<div class="form-group">
<label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
<select id="category" required>
<option value="–ì–æ—Ä–∏–≤–æ" ${e.category==='–ì–æ—Ä–∏–≤–æ'?'selected':''}>‚õΩ –ì–æ—Ä–∏–≤–æ</option>
<option value="–û–±—Å–ª—É–∂–≤–∞–Ω–µ" ${e.category==='–û–±—Å–ª—É–∂–≤–∞–Ω–µ'?'selected':''}>‚öôÔ∏è –û–±—Å–ª—É–∂–≤–∞–Ω–µ</option>
<option value="–ó–∞–ø–ª–∞—Ç–∏" ${e.category==='–ó–∞–ø–ª–∞—Ç–∏'?'selected':''}>üíµ –ó–∞–ø–ª–∞—Ç–∏</option>
<option value="–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏" ${e.category==='–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏'?'selected':''}>üõ°Ô∏è –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</option>
<option value="–í–∏–Ω–µ—Ç–∫–∏" ${e.category==='–í–∏–Ω–µ—Ç–∫–∏'?'selected':''}>üé´ –í–∏–Ω–µ—Ç–∫–∏</option>
<option value="–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏" ${e.category==='–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏'?'selected':''}>üîß –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∏</option>
<option value="–î—Ä—É–≥–æ" ${e.category==='–î—Ä—É–≥–æ'?'selected':''}>üìù –î—Ä—É–≥–æ</option>
</select>
</div>
<div class="form-group">
<label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
<input type="text" id="description" value="${e.description}" required>
</div>
<div class="form-group">
<label>–°—É–º–∞ (–ª–≤)</label>
<input type="number" step="0.01" id="amount" value="${e.amount}" required>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞</label>
<input type="date" id="date" value="${e.date}" required>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditExpense(e,id){
e.preventDefault();
const updates={
category:document.getElementById('category').value,
description:document.getElementById('description').value,
amount:Number(document.getElementById('amount').value),
date:document.getElementById('date').value
};

DS.update('expenses',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.viewExpense(id);
},

deleteExpense(id){
const e=DS.find('expenses',id);
let warningMsg=`–ò–∑—Ç—Ä–∏–π —Ä–∞–∑—Ö–æ–¥: ${e.description} - ${e.amount} –ª–≤?`;

if(e.payrollId){
const payroll=DS.find('payrolls',e.payrollId);
if(payroll){
warningMsg+=`\n\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–∑–∏ —Ä–∞–∑—Ö–æ–¥ –µ —Å—ä–∑–¥–∞–¥–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç –∑–∞–ø–ª–∞—Ç–∞!\n–ó–∞–ø–ª–∞—Ç–∞—Ç–∞ –Ω–∞ ${payroll.staffName} —â–µ –±—ä–¥–µ –º–∞—Ä–∫–∏—Ä–∞–Ω–∞ –∫–∞—Ç–æ "–Ω–µ–ø–ª–∞—Ç–µ–Ω–∞".`;
}
}

UI.confirm(warningMsg,()=>{
if(e.payrollId){
const payroll=DS.find('payrolls',e.payrollId);
if(payroll){
DS.update('payrolls',e.payrollId,{status:'pending'});
}
}
DS.delete('expenses',id);
UI.closeModal();
UI.toast('‚úÖ –†–∞–∑—Ö–æ–¥ –∏–∑—Ç—Ä–∏—Ç' + (e.payrollId?' –∏ –∑–∞–ø–ª–∞—Ç–∞ –æ–±–Ω–æ–≤–µ–Ω–∞!':'!'));
App.render();
});
},

renderRevenues(){
let revenues=DS.d.revenues;
if(this.searchQuery){
revenues=revenues.filter(r=>
r.source.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}

const totalRevenues=revenues.reduce((s,r)=>s+r.amount,0);
const byMonth={};
revenues.forEach(r=>{
const month=r.date.slice(0,7);
byMonth[month]=(byMonth[month]||0)+r.amount;
});

return `<div class="header">
<div>
<div class="header-title">üí∞ –ü—Ä–∏—Ö–æ–¥–∏</div>
<div class="header-subtitle">${revenues.length} ¬∑ ${totalRevenues.toLocaleString()} –ª–≤</div>
</div>
<button class="header-btn" onclick="App.addRevenue()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="section">
<div class="section-title">–û–±—â–æ –ø—Ä–∏—Ö–æ–¥–∏</div>
<div style="text-align:center;padding:20px;font-size:36px;font-weight:800;color:var(--green)">
${totalRevenues.toLocaleString()} –ª–≤
</div>
</div>

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –ø—Ä–∏—Ö–æ–¥..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${revenues.length===0?UI.empty('üí∞','–ù—è–º–∞ –ø—Ä–∏—Ö–æ–¥–∏',''):revenues.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(r=>`
<div class="card">
<div class="card-header">
<div class="card-title">${r.source}</div>
<span class="badge badge-active">${r.method}</span>
</div>
<div class="card-body">
üí∞ ${r.amount} –ª–≤ ¬∑ üìÖ ${r.date}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addRevenue(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –ø—Ä–∏—Ö–æ–¥</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddRevenue(event)">
<div class="form-group">
<label>–ò–∑—Ç–æ—á–Ω–∏–∫ *</label>
<input type="text" id="source" required placeholder="–ù–∞–ø—Ä. –ü—Ä–æ–¥–∞–∂–±–∞ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏">
</div>
<div class="form-group">
<label>–°—É–º–∞ (–ª–≤) *</label>
<input type="number" step="0.01" id="amount" required placeholder="2500">
</div>
<div class="form-group">
<label>–ú–µ—Ç–æ–¥ *</label>
<select id="method" required>
<option value="cash">üíµ –í –±—Ä–æ–π</option>
<option value="card">üí≥ –° –∫–∞—Ä—Ç–∞</option>
<option value="bank">üè¶ –ü–æ –±–∞–Ω–∫–∞</option>
</select>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ *</label>
<input type="date" id="date" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–ö–ª–∏–µ–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)</label>
<select id="clientId">
<option value="">-- –ë–µ–∑ –∫–ª–∏–µ–Ω—Ç --</option>
${DS.d.clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
</select>
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ –ø—Ä–∏—Ö–æ–¥</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddRevenue(e){
e.preventDefault();
const revenue={
source:document.getElementById('source').value,
amount:Number(document.getElementById('amount').value),
method:document.getElementById('method').value,
date:document.getElementById('date').value,
clientId:document.getElementById('clientId').value||null
};

DS.add('revenues',revenue);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–∏—Ö–æ–¥ –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

renderReceivables(){
let receivables=DS.d.receivables;
if(this.searchQuery){
receivables=receivables.filter(r=>
r.client.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus!=='all'){
receivables=receivables.filter(r=>r.status===this.filterStatus);
}

const totalReceivables=receivables.filter(r=>r.status!=='paid').reduce((s,r)=>s+r.remainingAmount,0);

return `<div class="header">
<div>
<div class="header-title">üíµ –í–∑–µ–º–∞–Ω–∏—è</div>
<div class="header-subtitle">${receivables.length} ¬∑ ${totalReceivables.toLocaleString()} –ª–≤</div>
</div>
</div>

<div class="container">
${totalReceivables>0?`<div class="alert alert-warning">
‚ö†Ô∏è –û–±—â–æ –≤–∑–µ–º–∞–Ω–∏—è: <strong>${totalReceivables.toLocaleString()} –ª–≤</strong>
</div>`:''}

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –≤–∑–µ–º–∞–Ω–µ..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='pending'?'active':''}" 
onclick="App.filterStatus='pending';App.render()">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='partial'?'active':''}" 
onclick="App.filterStatus='partial';App.render()">–ß–∞—Å—Ç–∏—á–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='overdue'?'active':''}" 
onclick="App.filterStatus='overdue';App.render()">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∏</button>
</div>

<div class="section">
${receivables.length===0?UI.empty('üíµ','–ù—è–º–∞ –≤–∑–µ–º–∞–Ω–∏—è','–í—Å–∏—á–∫–∏ —Ñ–∞–∫—Ç—É—Ä–∏ —Å–∞ –ø–ª–∞—Ç–µ–Ω–∏'):receivables.sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate)).map(r=>`
<div class="card" onclick="App.viewReceivable('${r.id}')">
<div class="card-header">
<div class="card-title">${r.client}</div>
<span class="badge badge-${r.status==='paid'?'delivered':r.status==='partial'?'active':r.status==='overdue'?'cancelled':'pending'}">${r.status}</span>
</div>
<div class="card-body">
üßæ ${r.invoiceId}<br>
üí∞ –û–±—â–æ: ${r.totalAmount} –ª–≤ ¬∑ –ü–ª–∞—Ç–µ–Ω–æ: ${r.paidAmount} –ª–≤<br>
<strong>–û—Å—Ç–∞—Ç—ä–∫: ${r.remainingAmount} –ª–≤</strong><br>
üìÖ –ü–∞–¥–µ–∂: ${r.dueDate}
${r.notes?'<br><em style="font-size:11px">'+r.notes+'</em>':''}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

viewReceivable(id){
const r=DS.find('receivables',id);
if(!r)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üíµ –í–∑–µ–º–∞–Ω–µ: ${r.client}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-row">
<div class="detail-label">–ö–ª–∏–µ–Ω—Ç</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewClient('${r.clientId}')">${r.client}</a></div>
</div>
<div class="detail-row">
<div class="detail-label">–§–∞–∫—Ç—É—Ä–∞</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewInvoice('${r.invoiceId}')">${r.invoiceId}</a></div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–∞ —Å—É–º–∞</div>
<div class="detail-value">${r.totalAmount} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü–ª–∞—Ç–µ–Ω–æ</div>
<div class="detail-value" style="color:var(--green)">${r.paidAmount} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–û—Å—Ç–∞—Ç—ä–∫</div>
<div class="detail-value" style="font-size:20px;font-weight:800;color:var(--red)">${r.remainingAmount} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü–∞–¥–µ–∂</div>
<div class="detail-value">${r.dueDate}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${r.status==='paid'?'delivered':'pending'}">${r.status}</span></div>
</div>
${r.notes?`<div class="detail-row">
<div class="detail-label">–ó–∞–±–µ–ª–µ–∂–∫–∏</div>
<div class="detail-value">${r.notes}</div>
</div>`:''}
</div>

<button class="btn btn-secondary" onclick="App.viewInvoice('${r.invoiceId}')">üßæ –í–∏–∂ —Ñ–∞–∫—Ç—É—Ä–∞</button>
</div>
</div>`;

UI.modal(html);
},

renderInsurances(){
let insurances=DS.d.insurances;
if(this.searchQuery){
insurances=insurances.filter(i=>
i.vehicle.toLowerCase().includes(this.searchQuery.toLowerCase())||
i.provider.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus!=='all'){
insurances=insurances.filter(i=>i.status===this.filterStatus);
}

const expiring=insurances.filter(i=>i.status==='expiring').length;

return `<div class="header">
<div>
<div class="header-title">üõ°Ô∏è –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</div>
<div class="header-subtitle">${insurances.length} –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏</div>
</div>
<button class="header-btn" onclick="App.addInsuranceStandalone()">+ –ù–æ–≤–∞</button>
</div>

<div class="container">
${expiring>0?`<div class="alert alert-warning">
‚ö†Ô∏è ${expiring} –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ –∏–∑—Ç–∏—á–∞—Ç —Å–∫–æ—Ä–æ!
</div>`:''}

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='valid'?'active':''}" 
onclick="App.filterStatus='valid';App.render()">–í–∞–ª–∏–¥–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='expiring'?'active':''}" 
onclick="App.filterStatus='expiring';App.render()">–ò–∑—Ç–∏—á–∞—â–∏</button>
<button class="filter-btn ${this.filterStatus==='expired'?'active':''}" 
onclick="App.filterStatus='expired';App.render()">–ò–∑—Ç–µ–∫–ª–∏</button>
</div>

<div class="section">
${insurances.length===0?UI.empty('üõ°Ô∏è','–ù—è–º–∞ –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏',''):insurances.sort((a,b)=>new Date(a.endDate)-new Date(b.endDate)).map(ins=>`
<div class="card" onclick="App.viewVehicle('${ins.vehicleId}')">
<div class="card-header">
<div class="card-title">${ins.vehicle}</div>
<span class="badge badge-${ins.status}">${ins.status}</span>
</div>
<div class="card-body">
<strong>${ins.type}</strong> ¬∑ ${ins.provider}<br>
üìù ${ins.policyNumber} ¬∑ üí∞ ${ins.premium} –ª–≤<br>
üìÖ –î–æ: ${new Date(ins.endDate).toLocaleDateString('bg-BG')}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addInsuranceStandalone(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–∞ –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddInsuranceStandalone(event)">
<div class="form-group">
<label>–ê–≤—Ç–æ–º–æ–±–∏–ª *</label>
<select id="vehicleId" required>
<option value="">–ò–∑–±–µ—Ä–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</option>
${DS.d.vehicles.map(v=>`<option value="${v.id}">${v.model} (${v.reg})</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–¢–∏–ø *</label>
<select id="type" required>
<option value="–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç">–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç</option>
<option value="–ö–∞—Å–∫–æ">–ö–∞—Å–∫–æ</option>
<option value="–ü—ä–ª–Ω–æ –∫–∞—Å–∫–æ">–ü—ä–ª–Ω–æ –∫–∞—Å–∫–æ</option>
</select>
</div>
<div class="form-group">
<label>–ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç–µ–ª *</label>
<input type="text" id="provider" required placeholder="–ó–î –ë—É–ª—Å—Ç—Ä–∞–¥">
</div>
<div class="form-group">
<label>–ü–æ–ª–∏—Ü–∞ ‚Ññ *</label>
<input type="text" id="policyNumber" required placeholder="POL-123456">
</div>
<div class="form-group">
<label>–û—Ç –¥–∞—Ç–∞ *</label>
<input type="date" id="startDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–î–æ –¥–∞—Ç–∞ *</label>
<input type="date" id="endDate" required>
</div>
<div class="form-group">
<label>–ü—Ä–µ–º–∏—è (–ª–≤) *</label>
<input type="number" id="premium" required placeholder="850">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddInsuranceStandalone(e){
e.preventDefault();
const vehicleId=document.getElementById('vehicleId').value;
const v=DS.find('vehicles',vehicleId);
const endDate=new Date(document.getElementById('endDate').value);
const now=new Date();
const daysUntil=Math.floor((endDate-now)/86400000);
let status='valid';
if(daysUntil<0)status='expired';
else if(daysUntil<30)status='expiring';

const ins={
vehicleId,
vehicle:`${v.model} (${v.reg})`,
type:document.getElementById('type').value,
provider:document.getElementById('provider').value,
policyNumber:document.getElementById('policyNumber').value,
startDate:document.getElementById('startDate').value,
endDate:document.getElementById('endDate').value,
premium:Number(document.getElementById('premium').value),
status
};

DS.add('insurances',ins);
UI.closeModal();
UI.toast('‚úÖ –ó–∞—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –¥–æ–±–∞–≤–µ–Ω–∞!');
this.render();
},

renderTechnicalInspections(){
let tis=DS.d.technicalInspections;
if(this.searchQuery){
tis=tis.filter(t=>
t.vehicle.toLowerCase().includes(this.searchQuery.toLowerCase())||
t.station.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus!=='all'){
tis=tis.filter(t=>t.status===this.filterStatus);
}

const expiring=tis.filter(t=>t.status==='expiring').length;

return `<div class="header">
<div>
<div class="header-title">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ø—Ä–µ–≥–ª–µ–¥–∏</div>
<div class="header-subtitle">${tis.length} –ø—Ä–µ–≥–ª–µ–¥–∞</div>
</div>
<button class="header-btn" onclick="App.addTIStandalone()">+ –ù–æ–≤</button>
</div>

<div class="container">
${expiring>0?`<div class="alert alert-warning">
‚ö†Ô∏è ${expiring} –¢–ü –∏–∑—Ç–∏—á–∞—Ç —Å–∫–æ—Ä–æ!
</div>`:''}

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –¢–ü..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='valid'?'active':''}" 
onclick="App.filterStatus='valid';App.render()">–í–∞–ª–∏–¥–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='expiring'?'active':''}" 
onclick="App.filterStatus='expiring';App.render()">–ò–∑—Ç–∏—á–∞—â–∏</button>
</div>

<div class="section">
${tis.length===0?UI.empty('üîß','–ù—è–º–∞ –¢–ü',''):tis.sort((a,b)=>new Date(a.nextInspectionDate)-new Date(b.nextInspectionDate)).map(ti=>`
<div class="card" onclick="App.viewVehicle('${ti.vehicleId}')">
<div class="card-header">
<div class="card-title">${ti.vehicle}</div>
<span class="badge badge-${ti.status}">${ti.result}</span>
</div>
<div class="card-body">
üìù ${ti.certificateNumber} ¬∑ ${ti.station}<br>
üìÖ –ù–∞–ø—Ä–∞–≤–µ–Ω: ${new Date(ti.inspectionDate).toLocaleDateString('bg-BG')}<br>
üìÖ –°–ª–µ–¥–≤–∞—â: ${new Date(ti.nextInspectionDate).toLocaleDateString('bg-BG')}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addTIStandalone(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ø—Ä–µ–≥–ª–µ–¥</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddTIStandalone(event)">
<div class="form-group">
<label>–ê–≤—Ç–æ–º–æ–±–∏–ª *</label>
<select id="vehicleId" required>
<option value="">–ò–∑–±–µ—Ä–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</option>
${DS.d.vehicles.map(v=>`<option value="${v.id}">${v.model} (${v.reg})</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–≥–ª–µ–¥ *</label>
<input type="date" id="inspectionDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–°–ª–µ–¥–≤–∞—â –ø—Ä–µ–≥–ª–µ–¥ *</label>
<input type="date" id="nextInspectionDate" required>
</div>
<div class="form-group">
<label>–†–µ–∑—É–ª—Ç–∞—Ç *</label>
<select id="result" required>
<option value="–ì–æ–¥–µ–Ω">–ì–æ–¥–µ–Ω</option>
<option value="–£—Å–ª–æ–≤–Ω–æ –≥–æ–¥–µ–Ω">–£—Å–ª–æ–≤–Ω–æ –≥–æ–¥–µ–Ω</option>
<option value="–ù–µ–≥–æ–¥–µ–Ω">–ù–µ–≥–æ–¥–µ–Ω</option>
</select>
</div>
<div class="form-group">
<label>–°—Ç–∞–Ω—Ü–∏—è *</label>
<input type="text" id="station" required placeholder="–¢–ü –°–æ—Ñ–∏—è –ò–∑—Ç–æ–∫">
</div>
<div class="form-group">
<label>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç ‚Ññ *</label>
<input type="text" id="certificateNumber" required placeholder="TP-12345">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddTIStandalone(e){
e.preventDefault();
const vehicleId=document.getElementById('vehicleId').value;
const v=DS.find('vehicles',vehicleId);
const nextDate=new Date(document.getElementById('nextInspectionDate').value);
const now=new Date();
const daysUntil=Math.floor((nextDate-now)/86400000);
let status='valid';
if(daysUntil<60)status='expiring';

const ti={
vehicleId,
vehicle:`${v.model} (${v.reg})`,
inspectionDate:document.getElementById('inspectionDate').value,
nextInspectionDate:document.getElementById('nextInspectionDate').value,
result:document.getElementById('result').value,
station:document.getElementById('station').value,
certificateNumber:document.getElementById('certificateNumber').value,
status
};

DS.add('technicalInspections',ti);
UI.closeModal();
UI.toast('‚úÖ –¢–ü –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

renderServices(){
let services=DS.d.services;
if(this.searchQuery){
services=services.filter(s=>
s.vehicle.toLowerCase().includes(this.searchQuery.toLowerCase())||
s.description.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}

const totalCost=services.reduce((s,srv)=>s+srv.cost,0);

return `<div class="header">
<div>
<div class="header-title">‚öôÔ∏è –û–±—Å–ª—É–∂–≤–∞–Ω–µ</div>
<div class="header-subtitle">${services.length} —Å–µ—Ä–≤–∏–∑–∏ ¬∑ ${totalCost.toLocaleString()} –ª–≤</div>
</div>
<button class="header-btn" onclick="App.addServiceStandalone()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ —Å–µ—Ä–≤–∏–∑..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${services.length===0?UI.empty('‚öôÔ∏è','–ù—è–º–∞ —Å–µ—Ä–≤–∏–∑–∏',''):services.sort((a,b)=>new Date(b.serviceDate)-new Date(a.serviceDate)).map(srv=>`
<div class="card" onclick="App.viewVehicle('${srv.vehicleId}')">
<div class="card-header">
<div class="card-title">${srv.vehicle}</div>
<span class="badge badge-active">${srv.type}</span>
</div>
<div class="card-body">
${srv.description}<br>
üìÖ ${new Date(srv.serviceDate).toLocaleDateString('bg-BG')} ¬∑ ${srv.provider}<br>
${srv.mileage?'üìè '+srv.mileage.toLocaleString()+' –∫–º ¬∑ ':''} üí∞ ${srv.cost} –ª–≤
${srv.nextServiceDate?'<br>üìÖ –°–ª–µ–¥–≤–∞—â: '+new Date(srv.nextServiceDate).toLocaleDateString('bg-BG'):''}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addServiceStandalone(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ —Å–µ—Ä–≤–∏–∑</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddServiceStandalone(event)">
<div class="form-group">
<label>–ê–≤—Ç–æ–º–æ–±–∏–ª *</label>
<select id="vehicleId" required>
<option value="">–ò–∑–±–µ—Ä–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</option>
${DS.d.vehicles.map(v=>`<option value="${v.id}">${v.model} (${v.reg})</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–¢–∏–ø *</label>
<select id="type" required>
<option value="–ü–ª–∞–Ω–æ–≤–æ –æ–±—Å–ª—É–∂–≤–∞–Ω–µ">–ü–ª–∞–Ω–æ–≤–æ –æ–±—Å–ª—É–∂–≤–∞–Ω–µ</option>
<option value="–†–µ–º–æ–Ω—Ç">–†–µ–º–æ–Ω—Ç</option>
<option value="–ì—É–º–∏">–°–º—è–Ω–∞ –Ω–∞ –≥—É–º–∏</option>
<option value="–°–ø–∏—Ä–∞—á–∫–∏">–°–ø–∏—Ä–∞—á–Ω–∞ —Å–∏—Å—Ç–µ–º–∞</option>
</select>
</div>
<div class="form-group">
<label>–û–ø–∏—Å–∞–Ω–∏–µ *</label>
<input type="text" id="description" required placeholder="–°–º—è–Ω–∞ –º–∞—Å–ª–æ –∏ —Ñ–∏–ª—Ç—Ä–∏">
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ *</label>
<input type="date" id="serviceDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
<input type="number" id="mileage" placeholder="150000">
</div>
<div class="form-group">
<label>–¶–µ–Ω–∞ (–ª–≤) *</label>
<input type="number" id="cost" required placeholder="450">
</div>
<div class="form-group">
<label>–°–µ—Ä–≤–∏–∑ *</label>
<input type="text" id="provider" required placeholder="–ú–µ—Ä—Ü–µ–¥–µ—Å –°–µ—Ä–≤–∏–∑">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddServiceStandalone(e){
e.preventDefault();
const vehicleId=document.getElementById('vehicleId').value;
const v=DS.find('vehicles',vehicleId);

const srv={
vehicleId,
vehicle:`${v.model} (${v.reg})`,
type:document.getElementById('type').value,
description:document.getElementById('description').value,
serviceDate:document.getElementById('serviceDate').value,
mileage:Number(document.getElementById('mileage').value)||null,
cost:Number(document.getElementById('cost').value),
provider:document.getElementById('provider').value
};

DS.add('services',srv);
UI.closeModal();
UI.toast('‚úÖ –°–µ—Ä–≤–∏–∑ –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

renderVignettes(){
let vignettes=DS.d.vignettes;
if(this.searchQuery){
vignettes=vignettes.filter(v=>
v.vehicle.toLowerCase().includes(this.searchQuery.toLowerCase())||
v.country.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus!=='all'){
vignettes=vignettes.filter(v=>v.status===this.filterStatus);
}

const expired=vignettes.filter(v=>v.status==='expired').length;

return `<div class="header">
<div>
<div class="header-title">üé´ –í–∏–Ω–µ—Ç–∫–∏</div>
<div class="header-subtitle">${vignettes.length} –≤–∏–Ω–µ—Ç–∫–∏</div>
</div>
<button class="header-btn" onclick="App.addVignetteStandalone()">+ –ù–æ–≤–∞</button>
</div>

<div class="container">
${expired>0?`<div class="alert alert-danger">
üö® ${expired} –∏–∑—Ç–µ–∫–ª–∏ –≤–∏–Ω–µ—Ç–∫–∏!
</div>`:''}

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –≤–∏–Ω–µ—Ç–∫–∞..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='valid'?'active':''}" 
onclick="App.filterStatus='valid';App.render()">–í–∞–ª–∏–¥–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='expired'?'active':''}" 
onclick="App.filterStatus='expired';App.render()">–ò–∑—Ç–µ–∫–ª–∏</button>
</div>

<div class="section">
${vignettes.length===0?UI.empty('üé´','–ù—è–º–∞ –≤–∏–Ω–µ—Ç–∫–∏',''):vignettes.sort((a,b)=>new Date(a.endDate)-new Date(b.endDate)).map(vig=>`
<div class="card" onclick="App.viewVehicle('${vig.vehicleId}')">
<div class="card-header">
<div class="card-title">${vig.vehicle}</div>
<span class="badge badge-${vig.status}">${vig.status}</span>
</div>
<div class="card-body">
üåç <strong>${vig.country}</strong> ¬∑ ${vig.type}<br>
üìÖ ${new Date(vig.startDate).toLocaleDateString('bg-BG')} ‚Üí ${new Date(vig.endDate).toLocaleDateString('bg-BG')}<br>
üí∞ ${vig.price} –ª–≤
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addVignetteStandalone(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–∞ –≤–∏–Ω–µ—Ç–∫–∞</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddVignetteStandalone(event)">
<div class="form-group">
<label>–ê–≤—Ç–æ–º–æ–±–∏–ª *</label>
<select id="vehicleId" required>
<option value="">–ò–∑–±–µ—Ä–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª</option>
${DS.d.vehicles.map(v=>`<option value="${v.id}">${v.model} (${v.reg})</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–î—ä—Ä–∂–∞–≤–∞ *</label>
<select id="country" required>
<option value="–ë—ä–ª–≥–∞—Ä–∏—è">–ë—ä–ª–≥–∞—Ä–∏—è</option>
<option value="–†—É–º—ä–Ω–∏—è">–†—É–º—ä–Ω–∏—è</option>
<option value="–£–Ω–≥–∞—Ä–∏—è">–£–Ω–≥–∞—Ä–∏—è</option>
<option value="–ê–≤—Å—Ç—Ä–∏—è">–ê–≤—Å—Ç—Ä–∏—è</option>
<option value="–ì–µ—Ä–º–∞–Ω–∏—è">–ì–µ—Ä–º–∞–Ω–∏—è</option>
<option value="–°—ä—Ä–±–∏—è">–°—ä—Ä–±–∏—è</option>
</select>
</div>
<div class="form-group">
<label>–¢–∏–ø *</label>
<select id="type" required>
<option value="–î–Ω–µ–≤–Ω–∞">–î–Ω–µ–≤–Ω–∞</option>
<option value="–°–µ–¥–º–∏—á–Ω–∞">–°–µ–¥–º–∏—á–Ω–∞</option>
<option value="–ú–µ—Å–µ—á–Ω–∞">–ú–µ—Å–µ—á–Ω–∞</option>
<option value="–ì–æ–¥–∏—à–Ω–∞">–ì–æ–¥–∏—à–Ω–∞</option>
</select>
</div>
<div class="form-group">
<label>–û—Ç –¥–∞—Ç–∞ *</label>
<input type="date" id="startDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–î–æ –¥–∞—Ç–∞ *</label>
<input type="date" id="endDate" required>
</div>
<div class="form-group">
<label>–¶–µ–Ω–∞ (–ª–≤) *</label>
<input type="number" id="price" required placeholder="1470">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddVignetteStandalone(e){
e.preventDefault();
const vehicleId=document.getElementById('vehicleId').value;
const v=DS.find('vehicles',vehicleId);
const endDate=new Date(document.getElementById('endDate').value);
const now=new Date();
const status=endDate<now?'expired':'valid';

const vig={
vehicleId,
vehicle:`${v.model} (${v.reg})`,
country:document.getElementById('country').value,
type:document.getElementById('type').value,
startDate:document.getElementById('startDate').value,
endDate:document.getElementById('endDate').value,
price:Number(document.getElementById('price').value),
status
};

DS.add('vignettes',vig);
UI.closeModal();
UI.toast('‚úÖ –í–∏–Ω–µ—Ç–∫–∞ –¥–æ–±–∞–≤–µ–Ω–∞!');
this.render();
},

renderGPS(){
const vehicles=DS.d.vehicles;
const deliveries=DS.d.deliveries.filter(d=>d.status==='in-progress');
const today=new Date().toISOString().split('T')[0];

// Generate daily waybills
const waybills=this.generateDailyWaybills(today);

// After render, initialize map
setTimeout(()=>this.initGPSMap(vehicles,deliveries),100);

return `<div class="header">
<div>
<div class="header-title">üó∫Ô∏è GPS Tracking</div>
<div class="header-subtitle">${vehicles.length} –∞–≤—Ç–æ–º–æ–±–∏–ª–∞ ¬∑ ${deliveries.length} –∞–∫—Ç–∏–≤–Ω–∏</div>
</div>
<button class="header-btn" onclick="App.refreshGPSMap()">üîÑ –û–±–Ω–æ–≤–∏</button>
</div>

<div class="container">
<div class="section">
<div class="section-title">üõ∞Ô∏è GPS Tracking Control</div>
<div style="display:flex;gap:12px;margin-bottom:12px;align-items:center">
<div style="flex:1">
<strong>–°—Ç–∞—Ç—É—Å:</strong> ${GPSTracker.isTracking?'üü¢ –ê–∫—Ç–∏–≤–µ–Ω':'üî¥ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}<br>
<small style="color:var(--gray6)">
${GPSTracker.isTracking?`–û–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –≤—Å–µ–∫–∏ ${GPSTracker.updateFrequency/1000} —Å–µ–∫—É–Ω–¥–∏`:'GPS tracking –µ –∏–∑–∫–ª—é—á–µ–Ω'}
</small>
</div>
<button class="btn ${GPSTracker.isTracking?'btn-danger':''}" 
onclick="${GPSTracker.isTracking?'GPSTracker.stopTracking();App.render()':'GPSTracker.startTracking();App.render()'}"
style="padding:10px 16px;font-size:13px;width:auto">
${GPSTracker.isTracking?'üî¥ –°—Ç–æ–ø':'üü¢ –°—Ç–∞—Ä—Ç'}
</button>
</div>
<div style="background:rgba(0,122,255,0.05);padding:12px;border-radius:8px;font-size:13px">
<strong>‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∏:</strong><br>
‚Ä¢ –®–æ—Ñ—å–æ—Ä–∏—Ç–µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ<br>
‚Ä¢ –ü—Ä–∏ —Å—Ç–∞—Ä—Ç –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞, –∞–∫—Ç–∏–≤–∏—Ä–∞—Ç GPS tracking<br>
‚Ä¢ –ü–æ–∑–∏—Ü–∏—è—Ç–∞ —Å–µ –∑–∞–ø–∏—Å–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ –≤—Å–µ–∫–∏ ${GPSTracker.updateFrequency/1000} —Å–µ–∫—É–Ω–¥–∏<br>
‚Ä¢ –î–∏—Å–ø–µ—á–µ—Ä—ä—Ç –≤–∏–∂–¥–∞ —Ä–µ–∞–ª–Ω–∞—Ç–∞ –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç–∞—Ç–∞<br>
‚Ä¢ –ö–∏–ª–æ–º–µ—Ç—Ä–∏—Ç–µ —Å–µ –∏–∑—á–∏—Å–ª—è–≤–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
</div>
</div>

<div class="section">
<div class="section-title">–ö–∞—Ä—Ç–∞</div>
<div id="gpsMap"></div>
<div class="route-controls">
<button class="route-btn active" onclick="App.showAllVehicles()">üöó –í—Å–∏—á–∫–∏</button>
<button class="route-btn" onclick="App.showActiveOnly()">üöö –ê–∫—Ç–∏–≤–Ω–∏</button>
<button class="route-btn" onclick="App.showRoutes()">üõ£Ô∏è –ú–∞—Ä—à—Ä—É—Ç–∏</button>
</div>
</div>

<div class="section">
<div class="section-title">üìÑ –î–Ω–µ–≤–Ω–∏ —Ç–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∏ (${today})</div>
${waybills.length===0?UI.empty('üìÑ','–ù—è–º–∞ —Ç–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∏ –∑–∞ –¥–Ω–µ—Å','–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —â–µ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏'):waybills.map(wb=>`
<div class="waybill-card">
<div class="waybill-header">
<div>
<div class="waybill-title">–¢–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∞ ‚Ññ${wb.number}</div>
<div class="waybill-number">${wb.date} ¬∑ ${wb.gpsTracked?'üü¢ GPS –¥–∞–Ω–Ω–∏':'‚ö†Ô∏è –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª–Ω–∏ –∫–º'}</div>
</div>
</div>
<div class="waybill-row">
<div class="waybill-label">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª</div>
<div class="waybill-value">${wb.vehicle}</div>
</div>
<div class="waybill-row">
<div class="waybill-label">üë®‚Äç‚úàÔ∏è –®–æ—Ñ—å–æ—Ä</div>
<div class="waybill-value">${wb.driver}</div>
</div>
<div class="waybill-row">
<div class="waybill-label">üìç –ù–∞—á–∞–ª–µ–Ω –∫–º</div>
<div class="waybill-value">${wb.startKm.toLocaleString()} –∫–º</div>
</div>
<div class="waybill-row">
<div class="waybill-label">üìç –ö—Ä–∞–µ–Ω –∫–º</div>
<div class="waybill-value">${wb.endKm.toLocaleString()} –∫–º</div>
</div>
<div class="waybill-row">
<div class="waybill-label">üìè –ò–∑–º–∏–Ω–∞—Ç–∏ –∫–º ${wb.gpsTracked?'(GPS)':'(~–∏–∑—á–∏—Å–ª.)'}</div>
<div class="waybill-value">${wb.totalKm} –∫–º</div>
</div>
<button class="btn" onclick="App.downloadWaybill('${wb.id}')" style="margin-top:12px">
üì• –ò–∑—Ç–µ–≥–ª–∏ —Ç–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∞
</button>
</div>
`).join('')}
</div>

<div class="section">
<div class="section-title">–ê–∫—Ç–∏–≤–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ (${deliveries.length})</div>
${deliveries.length===0?UI.empty('üó∫Ô∏è','–ù—è–º–∞ –∞–∫—Ç–∏–≤–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏',''):deliveries.map(d=>`
<div class="card" onclick="App.focusVehicleOnMap('${d.vehicleId}')">
<div class="card-header">
<div class="card-title">${d.vehicle}</div>
<span class="badge badge-active">–í –¥–≤–∏–∂–µ–Ω–∏–µ</span>
</div>
<div class="card-body">
üë®‚Äç‚úàÔ∏è ${d.driver}<br>
üìç ${d.route}<br>
üïê ${d.startTime} ¬∑ ETA: ${d.eta||'~'}<br>
üìè –ò–∑–º–∏–Ω–∞—Ç–∏: <strong>${d.distanceTraveled||0} –∫–º</strong><br>
üì¶ <a href="#" onclick="event.preventDefault();App.viewOrder('${d.orderId}')">${d.orderId}</a> ‚Üí ${d.client}
</div>
</div>
`).join('')}
</div>

<div class="section">
<div class="section-title">–í—Å–∏—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ (${vehicles.length})</div>
${vehicles.map(v=>`
<div class="card" onclick="App.focusVehicleOnMap('${v.id}')">
<div class="card-header">
<div class="card-title">${v.model}</div>
<span class="badge badge-${v.status==='available'?'delivered':'active'}">${v.status}</span>
</div>
<div class="card-body">
üöó ${v.reg} ¬∑ ‚öñÔ∏è ${v.capacity}—Ç<br>
üìè –û–±—â–æ –∏–∑–º–∏–Ω–∞—Ç–∏: <strong>${v.mileage?.toLocaleString()||0} –∫–º</strong><br>
üìè –î–Ω–µ—Å: <strong>${v.dailyKm||0} –∫–º</strong>
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

initGPSMap(vehicles,deliveries){
if(!window.L)return;

// Get recent GPS positions
const recentPositions=GPSTracker.getRecentPositions(60); // Last hour

// Determine map center
let centerLat=42.6977; // Sofia default
let centerLng=23.3219;

if(recentPositions.length>0){
// Center on most recent position
const latest=recentPositions[recentPositions.length-1];
centerLat=latest.latitude;
centerLng=latest.longitude;
}

const map=L.map('gpsMap').setView([centerLat,centerLng],12);
this.gpsMapInstance=map;

// Add OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
attribution:'¬© OpenStreetMap contributors',
maxZoom:19
}).addTo(map);

// Track markers by driver ID
const driverMarkers={};

// Add vehicle markers using REAL GPS data
vehicles.forEach(v=>{
const delivery=deliveries.find(d=>d.vehicleId===v.id);
const isActive=delivery!==undefined;

// Get driver's latest position
let lat,lng;
let hasRealGPS=false;

if(delivery&&delivery.driverId){
const driverPositions=GPSTracker.getPositionsByDriver(delivery.driverId);
if(driverPositions.length>0){
const latest=driverPositions[driverPositions.length-1];
lat=latest.latitude;
lng=latest.longitude;
hasRealGPS=true;

// Store for route drawing
driverMarkers[delivery.driverId]=driverPositions;
}
}

// Fallback to demo coordinates if no real GPS
if(!hasRealGPS){
lat=42.6977+(Math.random()-0.5)*0.1;
lng=23.3219+(Math.random()-0.5)*0.1;
}

const icon=L.divIcon({
className:'vehicle-marker',
html:hasRealGPS?'üü¢':'üî¥',
iconSize:[32,32]
});

const marker=L.marker([lat,lng],{icon}).addTo(map);

// Calculate today's distance
let todayKm=0;
if(delivery&&delivery.driverId){
todayKm=GPSTracker.getTodayDistance(delivery.driverId);
}

marker.bindPopup(`
<div class="vehicle-popup">
<h4>${v.model} (${v.reg})</h4>
<p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${isActive?'üü¢ –ê–∫—Ç–∏–≤–µ–Ω':'‚ö™ –ù–∞ –ø–∞—Ä–∫–∏–Ω–≥'}</p>
<p><strong>GPS:</strong> ${hasRealGPS?'üü¢ –†–µ–∞–ª–Ω–∞ –ø–æ–∑–∏—Ü–∏—è':'üî¥ Demo –¥–∞–Ω–Ω–∏'}</p>
<p><strong>–ö–∏–ª–æ–º–µ—Ç—Ä–∞–∂:</strong> ${v.mileage?.toLocaleString()||0} –∫–º</p>
<p><strong>–î–Ω–µ—Å:</strong> ${todayKm.toFixed(1)} –∫–º</p>
${delivery?`<p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> ${delivery.route}</p>`:''}
${delivery?`<p><strong>–®–æ—Ñ—å–æ—Ä:</strong> ${delivery.driver}</p>`:''}
</div>
`);

// Store marker reference
v.mapMarker=marker;
});

// Draw REAL routes from GPS data
Object.keys(driverMarkers).forEach(driverId=>{
const positions=driverMarkers[driverId];
if(positions.length<2)return;

// Convert to Leaflet LatLng array
const points=positions.map(p=>[p.latitude,p.longitude]);

// Draw route line
L.polyline(points,{
color:'#007AFF',
weight:3,
opacity:0.7,
dashArray:'10, 5'
}).addTo(map);

// Add start marker
const start=positions[0];
L.circleMarker([start.latitude,start.longitude],{
radius:6,
fillColor:'#34C759',
color:'white',
weight:2,
fillOpacity:1
}).addTo(map).bindPopup('üèÅ –ù–∞—á–∞–ª–æ');

// Add end marker
const end=positions[positions.length-1];
L.circleMarker([end.latitude,end.longitude],{
radius:6,
fillColor:'#FF3B30',
color:'white',
weight:2,
fillOpacity:1
}).addTo(map).bindPopup('üìç –¢–µ–∫—É—â–∞ –ø–æ–∑–∏—Ü–∏—è');
});

// Listen for real-time updates
GPSTracker.listenForUpdates((position)=>{
console.log('üîÑ New GPS position received:',position);
// Refresh map with new data
this.refreshGPSMap();
});
},

refreshGPSMap(){
this.render();
UI.toast('üîÑ –ö–∞—Ä—Ç–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞');
},

focusVehicleOnMap(vehicleId){
if(!this.gpsMapInstance)return;

const vehicle=DS.d.vehicles.find(v=>v.id===vehicleId);
if(vehicle&&vehicle.mapMarker){
this.gpsMapInstance.setView(vehicle.mapMarker.getLatLng(),15);
vehicle.mapMarker.openPopup();
}
},

showAllVehicles(){
document.querySelectorAll('.route-btn').forEach(btn=>{
btn.classList.remove('active');
});
event.target.classList.add('active');
UI.toast('üöó –ü–æ–∫–∞–∑–∞–Ω–∏ –≤—Å–∏—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏');
},

showActiveOnly(){
document.querySelectorAll('.route-btn').forEach(btn=>{
btn.classList.remove('active');
});
event.target.classList.add('active');
UI.toast('üöö –ü–æ–∫–∞–∑–∞–Ω–∏ —Å–∞–º–æ –∞–∫—Ç–∏–≤–Ω–∏—Ç–µ');
},

showRoutes(){
document.querySelectorAll('.route-btn').forEach(btn=>{
btn.classList.remove('active');
});
event.target.classList.add('active');
UI.toast('üõ£Ô∏è –ü–æ–∫–∞–∑–∞–Ω–∏ –º–∞—Ä—à—Ä—É—Ç–∏');
},

generateDailyWaybills(date){
// Get all deliveries for the day
const deliveries=DS.d.deliveries.filter(d=>{
return d.date===date&&d.status!=='pending';
});

// Group by vehicle
const vehicleGroups={};
deliveries.forEach(d=>{
if(!vehicleGroups[d.vehicleId]){
vehicleGroups[d.vehicleId]={
vehicle:d.vehicle,
driver:d.driver,
driverId:d.driverId,
deliveries:[]
};
}
vehicleGroups[d.vehicleId].deliveries.push(d);
});

// Generate waybills
const waybills=[];
Object.keys(vehicleGroups).forEach((vehicleId,idx)=>{
const group=vehicleGroups[vehicleId];
const vehicle=DS.d.vehicles.find(v=>v.id===vehicleId);

// Get REAL km from GPS data
let dailyKm=0;
if(group.driverId){
dailyKm=GPSTracker.getTodayDistance(group.driverId);
}

// Fallback to estimate if no GPS data
if(dailyKm===0){
dailyKm=group.deliveries.length*15; // ~15km per delivery average
}

const baseKm=vehicle?.mileage||50000;

waybills.push({
id:`WB-${date}-${idx+1}`,
number:`${date.replace(/-/g,'')}-${idx+1}`,
date:new Date(date).toLocaleDateString('bg-BG'),
vehicleId,
vehicle:group.vehicle,
driver:group.driver,
startKm:baseKm,
endKm:baseKm+dailyKm,
totalKm:Math.round(dailyKm), // Round to nearest km
deliveries:group.deliveries,
gpsTracked:dailyKm>0&&group.driverId!==undefined
});
});

return waybills;
},

downloadWaybill(waybillId){
// Generate PDF-like text document
const wb=this.generateDailyWaybills(new Date().toISOString().split('T')[0])
.find(w=>w.id===waybillId);

if(!wb)return;

const content=`
–¢–û–í–ê–†–ò–¢–ï–õ–ù–ò–¶–ê ‚Ññ${wb.number}
–î–∞—Ç–∞: ${wb.date}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ê–í–¢–û–ú–û–ë–ò–õ
–ú–∞—Ä–∫–∞: ${wb.vehicle}
–®–æ—Ñ—å–æ—Ä: ${wb.driver}

–ö–ò–õ–û–ú–ï–¢–†–ê–ñ
–ù–∞—á–∞–ª–µ–Ω: ${wb.startKm.toLocaleString()} –∫–º
–ö—Ä–∞–µ–Ω: ${wb.endKm.toLocaleString()} –∫–º
–ò–∑–º–∏–Ω–∞—Ç–∏: ${wb.totalKm} –∫–º

–î–û–°–¢–ê–í–ö–ò (${wb.deliveries.length})
${wb.deliveries.map((d,i)=>`${i+1}. ${d.client} - ${d.route}`).join('\n')}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–ü–æ–¥–ø–∏—Å —à–æ—Ñ—å–æ—Ä: _________________

–ü–æ–¥–ø–∏—Å –¥–∏—Å–ø–µ—á–µ—Ä: _________________

${Auth.company?.name||'BuildFlow Pro'}
${new Date().toLocaleDateString('bg-BG')}
`;

// Download as text file
const blob=new Blob([content],{type:'text/plain;charset=utf-8'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`Tovaritelnica_${wb.number}.txt`;
a.click();
URL.revokeObjectURL(url);

UI.toast('üì• –¢–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∞ –∏–∑—Ç–µ–≥–ª–µ–Ω–∞');
},

renderWarehouses(){
let warehouses=DS.d.warehouses;
if(this.searchQuery){
warehouses=warehouses.filter(w=>
w.name.toLowerCase().includes(this.searchQuery.toLowerCase())||
w.location.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}

return `<div class="header">
<div>
<div class="header-title">üè≠ –°–∫–ª–∞–¥–æ–≤–µ</div>
<div class="header-subtitle">${warehouses.length} —Å–∫–ª–∞–¥–æ–≤–µ</div>
</div>
<button class="header-btn" onclick="App.addWarehouse()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ —Å–∫–ª–∞–¥..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${warehouses.length===0?UI.empty('üè≠','–ù—è–º–∞ —Å–∫–ª–∞–¥–æ–≤–µ','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è —Å–∫–ª–∞–¥'):warehouses.map(w=>`
<div class="card" onclick="App.viewWarehouse('${w.id}')">
<div class="card-header">
<div class="card-title">${w.name}</div>
<span class="badge badge-${w.status==='active'?'delivered':'cancelled'}">${w.status}</span>
</div>
<div class="card-body">
üìç ${w.location} ¬∑ ${w.address}<br>
üì¶ –ö–∞–ø–∞—Ü–∏—Ç–µ—Ç: ${w.capacity} ¬∑ –ó–∞–µ—Ç–æ: ${w.occupied}<br>
üë§ –ú–µ–Ω–∏–¥–∂—ä—Ä: ${w.manager||'N/A'}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addWarehouse(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ —Å–∫–ª–∞–¥</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddWarehouse(event)">
<div class="form-group">
<label>–ò–º–µ *</label>
<input type="text" id="name" required placeholder="–¶–µ–Ω—Ç—Ä–∞–ª–µ–Ω —Å–∫–ª–∞–¥">
</div>
<div class="form-group">
<label>–õ–æ–∫–∞—Ü–∏—è *</label>
<input type="text" id="location" required placeholder="–°–æ—Ñ–∏—è">
</div>
<div class="form-group">
<label>–ê–¥—Ä–µ—Å *</label>
<input type="text" id="address" required placeholder="–ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª–Ω–∞ –∑–æ–Ω–∞ 1">
</div>
<div class="form-group">
<label>–ö–∞–ø–∞—Ü–∏—Ç–µ—Ç (–º¬≤)</label>
<input type="number" id="capacity" placeholder="5000">
</div>
<div class="form-group">
<label>–ú–µ–Ω–∏–¥–∂—ä—Ä</label>
<select id="manager">
<option value="">-- –ë–µ–∑ –º–µ–Ω–∏–¥–∂—ä—Ä --</option>
${DS.d.staff.map(s=>`<option value="${s.name}">${s.name}</option>`).join('')}
</select>
</div>
<button type="submit" class="btn">–°—ä–∑–¥–∞–π —Å–∫–ª–∞–¥</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddWarehouse(e){
e.preventDefault();
const warehouse={
name:document.getElementById('name').value,
location:document.getElementById('location').value,
address:document.getElementById('address').value,
capacity:Number(document.getElementById('capacity').value)||0,
occupied:0,
manager:document.getElementById('manager').value,
status:'active'
};

DS.add('warehouses',warehouse);
UI.closeModal();
UI.toast('‚úÖ –°–∫–ª–∞–¥ –¥–æ–±–∞–≤–µ–Ω!');
this.render();
},

viewWarehouse(id){
const w=DS.find('warehouses',id);
if(!w)return;

const inventory=DS.d.inventory.filter(i=>i.warehouseId===id);

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üè≠ ${w.name}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-row">
<div class="detail-label">–õ–æ–∫–∞—Ü–∏—è</div>
<div class="detail-value">${w.location}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ê–¥—Ä–µ—Å</div>
<div class="detail-value">${w.address}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ö–∞–ø–∞—Ü–∏—Ç–µ—Ç</div>
<div class="detail-value">${w.capacity} –º¬≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ó–∞–µ—Ç–æ</div>
<div class="detail-value">${w.occupied} –º¬≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–°–≤–æ–±–æ–¥–Ω–æ</div>
<div class="detail-value">${w.capacity-w.occupied} –º¬≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–µ–Ω–∏–¥–∂—ä—Ä</div>
<div class="detail-value">${w.manager||'N/A'}</div>
</div>
</div>

<div class="detail-section">
<div class="detail-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä (${inventory.length})</div>
${inventory.length===0?'<p style="text-align:center;color:var(--gray6)">–ù—è–º–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä</p>':inventory.map(inv=>`
<div style="padding:8px;border-bottom:1px solid var(--gray1);font-size:12px">
${inv.material} ¬∑ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <strong>${inv.quantity}</strong> ¬∑ –ó–æ–Ω–∞: ${inv.location}
</div>
`).join('')}
</div>

<button class="btn btn-secondary" onclick="UI.closeModal();App.navigate('inventory')">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä</button>
<button class="btn" onclick="App.editWarehouse('${w.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-danger" onclick="App.deleteWarehouse('${w.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editWarehouse(id){
const w=DS.find('warehouses',id);
if(!w)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π —Å–∫–ª–∞–¥</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditWarehouse(event,'${id}')">
<div class="form-group">
<label>–ò–º–µ</label>
<input type="text" id="name" value="${w.name}" required>
</div>
<div class="form-group">
<label>–õ–æ–∫–∞—Ü–∏—è</label>
<input type="text" id="location" value="${w.location}" required>
</div>
<div class="form-group">
<label>–ê–¥—Ä–µ—Å</label>
<input type="text" id="address" value="${w.address}" required>
</div>
<div class="form-group">
<label>–ö–∞–ø–∞—Ü–∏—Ç–µ—Ç (–º¬≤)</label>
<input type="number" id="capacity" value="${w.capacity}">
</div>
<div class="form-group">
<label>–ú–µ–Ω–∏–¥–∂—ä—Ä</label>
<select id="manager">
<option value="">-- –ë–µ–∑ –º–µ–Ω–∏–¥–∂—ä—Ä --</option>
${DS.d.staff.map(s=>`<option value="${s.name}" ${w.manager===s.name?'selected':''}>${s.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–°—Ç–∞—Ç—É—Å</label>
<select id="status">
<option value="active" ${w.status==='active'?'selected':''}>–ê–∫—Ç–∏–≤–µ–Ω</option>
<option value="inactive" ${w.status==='inactive'?'selected':''}>–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
</select>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditWarehouse(e,id){
e.preventDefault();
const updates={
name:document.getElementById('name').value,
location:document.getElementById('location').value,
address:document.getElementById('address').value,
capacity:Number(document.getElementById('capacity').value),
manager:document.getElementById('manager').value,
status:document.getElementById('status').value
};

DS.update('warehouses',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.viewWarehouse(id);
},

deleteWarehouse(id){
UI.confirm('–ò–∑—Ç—Ä–∏–π —Å–∫–ª–∞–¥?',()=>{
DS.delete('warehouses',id);
UI.closeModal();
UI.toast('‚úÖ –°–∫–ª–∞–¥ –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
},

renderInventory(){
let inventory=DS.d.inventory;
if(this.searchQuery){
inventory=inventory.filter(i=>
i.material.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}

return `<div class="header">
<div>
<div class="header-title">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä</div>
<div class="header-subtitle">${inventory.length} –ø–æ–∑–∏—Ü–∏–∏</div>
</div>
<button class="header-btn" onclick="App.addInventory()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –º–∞—Ç–µ—Ä–∏–∞–ª..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="section">
${inventory.length===0?UI.empty('üì¶','–ù—è–º–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∞—Ç–∞ –ø–æ–∑–∏—Ü–∏—è'):inventory.map(inv=>`
<div class="card" onclick="App.viewInventory('${inv.id}')">
<div class="card-header">
<div class="card-title">${inv.material}</div>
${inv.quantity<inv.minQty?'<span class="badge badge-cancelled">–ú–∞–ª–∫–æ!</span>':'<span class="badge badge-delivered">OK</span>'}
</div>
<div class="card-body">
üè≠ ${DS.d.warehouses.find(w=>w.id===inv.warehouseId)?.name||'N/A'}<br>
üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <strong>${inv.quantity}</strong> ¬∑ Min: ${inv.minQty}<br>
üìç –ó–æ–Ω–∞: ${inv.location}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addInventory(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–∞ –ø–æ–∑–∏—Ü–∏—è</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddInventory(event)">
<div class="form-group">
<label>–°–∫–ª–∞–¥ *</label>
<select id="warehouseId" required>
<option value="">–ò–∑–±–µ—Ä–∏ —Å–∫–ª–∞–¥</option>
${DS.d.warehouses.map(w=>`<option value="${w.id}">${w.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–ú–∞—Ç–µ—Ä–∏–∞–ª *</label>
<select id="materialId" required>
<option value="">–ò–∑–±–µ—Ä–∏ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
${DS.d.materials.map(m=>`<option value="${m.id}">${m.name}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
<input type="number" id="quantity" required placeholder="5000">
</div>
<div class="form-group">
<label>–ú–∏–Ω–∏–º–∞–ª–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
<input type="number" id="minQty" required placeholder="1000">
</div>
<div class="form-group">
<label>–ó–æ–Ω–∞ *</label>
<input type="text" id="location" required placeholder="–ó–æ–Ω–∞ –ê1">
</div>
<button type="submit" class="btn">–î–æ–±–∞–≤–∏ –ø–æ–∑–∏—Ü–∏—è</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddInventory(e){
e.preventDefault();
const materialId=document.getElementById('materialId').value;
const material=DS.find('materials',materialId);

const inv={
warehouseId:document.getElementById('warehouseId').value,
materialId,
material:material.name,
quantity:Number(document.getElementById('quantity').value),
minQty:Number(document.getElementById('minQty').value),
location:document.getElementById('location').value
};

DS.add('inventory',inv);
UI.closeModal();
UI.toast('‚úÖ –ü–æ–∑–∏—Ü–∏—è –¥–æ–±–∞–≤–µ–Ω–∞!');
this.render();
},

viewInventory(id){
const inv=DS.find('inventory',id);
if(!inv)return;

const warehouse=DS.find('warehouses',inv.warehouseId);

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üì¶ ${inv.material}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-row">
<div class="detail-label">–°–∫–ª–∞–¥</div>
<div class="detail-value">${warehouse?.name||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</div>
<div class="detail-value">${inv.material}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
<div class="detail-value" style="font-size:20px;font-weight:800">${inv.quantity}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–∏–Ω–∏–º—É–º</div>
<div class="detail-value">${inv.minQty}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ó–æ–Ω–∞</div>
<div class="detail-value">${inv.location}</div>
</div>
${inv.quantity<inv.minQty?`<div class="alert alert-warning">
‚ö†Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ—Ç–æ –µ –ø–æ–¥ –º–∏–Ω–∏–º—É–º–∞!
</div>`:''}
</div>

<button class="btn" onclick="App.updateInventoryQty('${inv.id}')">üìä –ü—Ä–æ–º–µ–Ω–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</button>
<button class="btn" onclick="App.editInventory('${inv.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-danger" onclick="App.deleteInventory('${inv.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editInventory(id){
const inv=DS.find('inventory',id);
if(!inv)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditInventory(event,'${id}')">
<div class="form-group">
<label>–ú–∏–Ω–∏–º–∞–ª–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
<input type="number" id="minQty" value="${inv.minQty}" required>
</div>
<div class="form-group">
<label>–ó–æ–Ω–∞</label>
<input type="text" id="location" value="${inv.location}" required>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditInventory(e,id){
e.preventDefault();
const updates={
minQty:Number(document.getElementById('minQty').value),
location:document.getElementById('location').value
};

DS.update('inventory',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.viewInventory(id);
},

deleteInventory(id){
UI.confirm('–ò–∑—Ç—Ä–∏–π –ø–æ–∑–∏—Ü–∏—è –æ—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∞?',()=>{
DS.delete('inventory',id);
UI.closeModal();
UI.toast('‚úÖ –ü–æ–∑–∏—Ü–∏—è –∏–∑—Ç—Ä–∏—Ç–∞!');
App.render();
});
},

updateInventoryQty(id){
const inv=DS.find('inventory',id);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ü—Ä–æ–º–µ–Ω–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleUpdateInventoryQty(event,'${id}')">
<div class="form-group">
<label>–¢–µ–∫—É—â–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
<input type="number" value="${inv.quantity}" readonly style="background:var(--gray1)">
</div>
<div class="form-group">
<label>–ù–æ–≤–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
<input type="number" id="quantity" required value="${inv.quantity}">
</div>
<button type="submit" class="btn">–ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–π</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleUpdateInventoryQty(e,id){
e.preventDefault();
DS.update('inventory',id,{quantity:Number(document.getElementById('quantity').value)});
UI.closeModal();
UI.toast('‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–æ!');
this.viewInventory(id);
},

renderDocuments(){
// Combine documents and invoices
let allDocuments=[...DS.d.documents];

// Add invoices as document entries
DS.d.invoices.forEach(inv=>{
const existingDoc=DS.d.documents.find(d=>d.name===inv.id);
if(!existingDoc){
allDocuments.push({
id:inv.id,
type:'–§–∞–∫—Ç—É—Ä–∞',
name:inv.id,
date:inv.issueDate,
relatedType:'Order',
relatedId:inv.orderId,
status:inv.status==='paid'?'signed':'issued',
notes:`${inv.client} - ${inv.total} –ª–≤`,
isInvoice:true
});
}
});

// Apply search filter
if(this.searchQuery){
allDocuments=allDocuments.filter(d=>
d.name.toLowerCase().includes(this.searchQuery.toLowerCase())||
d.type.toLowerCase().includes(this.searchQuery.toLowerCase())||
(d.notes&&d.notes.toLowerCase().includes(this.searchQuery.toLowerCase()))
);
}

// Apply tab filter
if(this.activeTab!=='all'){
allDocuments=allDocuments.filter(d=>d.type===this.activeTab);
}

return `<div class="header">
<div>
<div class="header-title">üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∏</div>
<div class="header-subtitle">${allDocuments.length} –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
</div>
<button class="header-btn" onclick="App.addDocument()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="alert alert-info">
‚ÑπÔ∏è –î–æ–∫—É–º–µ–Ω—Ç–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ - —Ñ–∞–∫—Ç—É—Ä–∏, —Ç–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∏, –ø—Ä–æ—Ç–æ–∫–æ–ª–∏ –∏ –¥—Ä.
</div>

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –¥–æ–∫—É–º–µ–Ω—Ç..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="tabs">
<div class="tab ${this.activeTab==='all'?'active':''}" onclick="App.activeTab='all';App.render()">–í—Å–∏—á–∫–∏</div>
<div class="tab ${this.activeTab==='–§–∞–∫—Ç—É—Ä–∞'?'active':''}" onclick="App.activeTab='–§–∞–∫—Ç—É—Ä–∞';App.render()">–§–∞–∫—Ç—É—Ä–∏</div>
<div class="tab ${this.activeTab==='–¢–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∞'?'active':''}" onclick="App.activeTab='–¢–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∞';App.render()">–¢–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∏</div>
<div class="tab ${this.activeTab==='–ü—Ä–æ—Ç–æ–∫–æ–ª'?'active':''}" onclick="App.activeTab='–ü—Ä–æ—Ç–æ–∫–æ–ª';App.render()">–ü—Ä–æ—Ç–æ–∫–æ–ª–∏</div>
</div>

<div class="section">
${allDocuments.length===0?UI.empty('üìÑ','–ù—è–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏','–°—ä–∑–¥–∞–π—Ç–µ –ø–æ—Ä—ä—á–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–π—Ç–µ —Ñ–∞–∫—Ç—É—Ä–∞'):allDocuments.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(d=>`
<div class="card" onclick="App.${d.isInvoice?'viewInvoiceFromDoc':'viewDocument'}('${d.id}')">
<div class="card-header">
<div class="card-title">${d.name}</div>
<span class="badge badge-${d.status==='issued'?'delivered':d.status==='signed'?'active':'pending'}">${d.status}</span>
</div>
${d.file?`<div style="text-align:center;padding:10px;background:var(--gray1);border-top:1px solid var(--gray3)">
${d.fileType?.startsWith('image/')?`
<img src="${d.file}" style="max-width:100%;height:120px;object-fit:cover;border-radius:4px">
`:d.fileType==='application/pdf'?`
<div style="padding:20px;color:var(--gray6)">
<div style="font-size:26px">üìÑ</div>
<div style="font-size:10px;margin-top:5px">PDF - ${(d.fileSize/1024).toFixed(0)} KB</div>
</div>
`:`
<div style="padding:15px;color:var(--gray6)">
<div style="font-size:24px">üìé</div>
<div style="font-size:10px;margin-top:5px">${d.fileName?.substring(0,20)||'–§–∞–π–ª'}</div>
</div>
`}
</div>`:''}
<div class="card-body">
üìù <strong>${d.type}</strong><br>
üìÖ ${d.date}<br>
${d.relatedType?'üîó –°–≤—ä—Ä–∑–∞–Ω: '+d.relatedType+' '+d.relatedId:''}<br>
${d.notes?'üìã '+d.notes:''}
${!d.file&&!d.isInvoice?'<br>üìé –ù—è–º–∞ –ø—Ä–∏–∫–∞—á–µ–Ω —Ñ–∞–π–ª':''}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

viewInvoiceFromDoc(invoiceId){
// Navigate to invoices and show the invoice
this.navigate('invoices');
// Use setTimeout to ensure page is rendered first
setTimeout(()=>{
this.viewInvoice(invoiceId);
},100);
},

addDocument(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddDocument(event)">
<div class="alert alert-info">
üì∏ –ú–æ–∂–µ—à –¥–∞ –∫–∞—á–∏—à —Å–Ω–∏–º–∫–∞ –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç –∫–∞–º–µ—Ä–∞—Ç–∞ –∏–ª–∏ –¥–∞ –∏–∑–±–µ—Ä–µ—à —Ñ–∞–π–ª
</div>

<div class="form-group">
<label>–ü—Ä–∏–∫–∞—á–∏ —Ñ–∞–π–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)</label>
<input type="file" id="docFile" accept="image/*,application/pdf" capture="environment">
<div id="filePreview" style="margin-top:10px;text-align:center;min-height:30px"></div>
</div>

<div class="form-group">
<label>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç *</label>
<select id="type" required>
<option value="–§–∞–∫—Ç—É—Ä–∞">üßæ –§–∞–∫—Ç—É—Ä–∞</option>
<option value="–¢–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∞">üì¶ –¢–æ–≤–∞—Ä–∏—Ç–µ–ª–Ω–∏—Ü–∞</option>
<option value="–ü—Ä–æ—Ç–æ–∫–æ–ª">üìã –ü—Ä–æ—Ç–æ–∫–æ–ª</option>
<option value="CMR">üöõ CMR</option>
<option value="–û—Ñ–µ—Ä—Ç–∞">üí∞ –û—Ñ–µ—Ä—Ç–∞</option>
<option value="–î–æ–≥–æ–≤–æ—Ä">üìù –î–æ–≥–æ–≤–æ—Ä</option>
<option value="–†–∞–∑—Ö–æ–¥–µ–Ω –æ—Ä–¥–µ—Ä">üí∏ –†–∞–∑—Ö–æ–¥–µ–Ω –æ—Ä–¥–µ—Ä</option>
<option value="–ü—Ä–∏—Ö–æ–¥–µ–Ω –æ—Ä–¥–µ—Ä">üí∞ –ü—Ä–∏—Ö–æ–¥–µ–Ω –æ—Ä–¥–µ—Ä</option>
</select>
</div>
<div class="form-group">
<label>–ò–º–µ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç *</label>
<input type="text" id="name" required placeholder="DOC-2024-001">
</div>
<div class="form-group">
<label>–î–∞—Ç–∞ *</label>
<input type="date" id="date" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–°–≤—ä—Ä–∑–∞–Ω —Å</label>
<select id="relatedType">
<option value="">-- –ù–µ—Å–≤—ä—Ä–∑–∞–Ω --</option>
<option value="Order">–ü–æ—Ä—ä—á–∫–∞</option>
<option value="Client">–ö–ª–∏–µ–Ω—Ç</option>
<option value="Supplier">–î–æ—Å—Ç–∞–≤—á–∏–∫</option>
<option value="Vehicle">–ê–≤—Ç–æ–º–æ–±–∏–ª</option>
</select>
</div>
<div class="form-group">
<label>ID –Ω–∞ —Å–≤—ä—Ä–∑–∞–Ω–∏—è –æ–±–µ–∫—Ç</label>
<input type="text" id="relatedId" placeholder="–ù–∞–ø—Ä. ORD-001">
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes" placeholder="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
</div>
<button type="submit" class="btn">–°—ä–∑–¥–∞–π –¥–æ–∫—É–º–µ–Ω—Ç</button>
</form>
</div>
</div>`;
UI.modal(html);

setTimeout(()=>{
document.getElementById('docFile').onchange=function(e){
const file=e.target.files[0];
if(!file)return;

if(file.size>5*1024*1024){
UI.toast('‚ö†Ô∏è –§–∞–π–ª—ä—Ç –µ —Ç–≤—ä—Ä–¥–µ –≥–æ–ª—è–º! –ú–∞–∫—Å–∏–º—É–º 5MB');
this.value='';
return;
}

const preview=document.getElementById('filePreview');
const reader=new FileReader();
reader.onload=function(e){
if(file.type.startsWith('image/')){
preview.innerHTML=`<img src="${e.target.result}" style="max-width:100%;max-height:150px;border-radius:4px">`;
}else{
preview.innerHTML=`<div style="padding:10px;color:var(--gray6)">
<div style="font-size:24px">üìÑ</div>
<div style="font-size:11px">${file.name} (${(file.size/1024).toFixed(2)} KB)</div>
</div>`;
}
};
reader.readAsDataURL(file);
};
},100);
},

handleAddDocument(e){
e.preventDefault();

const fileInput=document.getElementById('docFile');
const file=fileInput.files[0];

const saveDocument=(fileData,fileName,fileType,fileSize)=>{
const doc={
type:document.getElementById('type').value,
name:document.getElementById('name').value,
date:document.getElementById('date').value,
relatedType:document.getElementById('relatedType').value,
relatedId:document.getElementById('relatedId').value,
notes:document.getElementById('notes').value,
status:'pending',
file:fileData||null,
fileName:fileName||null,
fileType:fileType||null,
fileSize:fileSize||null,
uploadDate:fileData?new Date().toISOString().split('T')[0]:null
};

DS.add('documents',doc);
UI.closeModal();
UI.toast('‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —Å—ä–∑–¥–∞–¥–µ–Ω!');
this.render();
};

if(file){
const reader=new FileReader();
reader.onload=function(e){
saveDocument(e.target.result,file.name,file.type,file.size);
};
reader.readAsDataURL(file);
}else{
saveDocument();
}
},

viewDocument(id){
const d=DS.find('documents',id);
if(!d)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìÑ ${d.name}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
${d.file?`<div class="detail-section" style="text-align:center;background:var(--gray1);padding:20px;border-radius:8px;margin-bottom:20px;">
${d.fileType?.startsWith('image/')?`
<img src="${d.file}" style="max-width:100%;max-height:400px;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
`:d.fileType==='application/pdf'?`
<iframe src="${d.file}" style="width:100%;height:500px;border:1px solid var(--gray3);border-radius:4px" title="${d.fileName}"></iframe>
<div style="font-size:12px;margin-top:10px;color:var(--gray6)">PDF –¥–æ–∫—É–º–µ–Ω—Ç - ${(d.fileSize/1024).toFixed(2)} KB</div>
`:`
<div style="padding:40px;color:var(--gray6)">
<div style="font-size:48px;margin-bottom:10px">üìÑ</div>
<div style="font-size:14px">${d.fileName||'–î–æ–∫—É–º–µ–Ω—Ç'}</div>
<div style="font-size:12px;margin-top:10px">${(d.fileSize/1024).toFixed(2)} KB</div>
</div>
`}
<div style="margin-top:10px">
<button class="btn btn-secondary" onclick="App.downloadDocument('${d.id}')">‚¨áÔ∏è –ò–∑—Ç–µ–≥–ª–∏</button>
${d.fileType==='application/pdf'?`<button class="btn btn-secondary" onclick="window.open('${d.file}')">üîç –û—Ç–≤–æ—Ä–∏ –≤ –Ω–æ–≤ –ø—Ä–æ–∑–æ—Ä–µ—Ü</button>`:''}
</div>
</div>`:'<div class="alert alert-info">‚ÑπÔ∏è –ù—è–º–∞ –ø—Ä–∏–∫–∞—á–µ–Ω —Ñ–∞–π–ª</div>'}

<div class="detail-section">
<div class="detail-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
<div class="detail-row">
<div class="detail-label">–¢–∏–ø</div>
<div class="detail-value">${d.type}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ò–º–µ</div>
<div class="detail-value">${d.name}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–∞—Ç–∞</div>
<div class="detail-value">${d.date}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${d.status==='issued'?'delivered':d.status==='signed'?'active':'pending'}">${d.status}</span></div>
</div>
${d.relatedType?`<div class="detail-row">
<div class="detail-label">–°–≤—ä—Ä–∑–∞–Ω —Å</div>
<div class="detail-value">${d.relatedType}: ${d.relatedId}</div>
</div>`:''}
${d.notes?`<div class="detail-row">
<div class="detail-label">–ó–∞–±–µ–ª–µ–∂–∫–∏</div>
<div class="detail-value">${d.notes}</div>
</div>`:''}
${d.file?`<div class="detail-row">
<div class="detail-label">–§–∞–π–ª</div>
<div class="detail-value">${d.fileName||'document'} (${(d.fileSize/1024).toFixed(2)} KB)</div>
</div>`:''}
</div>

${!d.file?`<button class="btn btn-secondary" onclick="App.uploadDocumentFile('${d.id}')">üìé –ü—Ä–∏–∫–∞—á–∏ —Ñ–∞–π–ª</button>`:''}
<button class="btn" onclick="App.editDocument('${d.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-secondary" onclick="App.changeDocumentStatus('${d.id}')">üîÑ –ü—Ä–æ–º–µ–Ω–∏ —Å—Ç–∞—Ç—É—Å</button>
<button class="btn btn-danger" onclick="App.deleteDocument('${d.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

downloadDocument(id){
const d=DS.find('documents',id);
if(!d||!d.file)return;

const link=document.createElement('a');
link.href=d.file;
link.download=d.fileName||d.name;
link.click();
UI.toast('‚¨áÔ∏è –î–æ–∫—É–º–µ–Ω—Ç –∏–∑—Ç–µ–≥–ª–µ–Ω!');
},

uploadDocumentFile(id){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ü—Ä–∏–∫–∞—á–∏ —Ñ–∞–π–ª</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="alert alert-info">
üì∏ –ú–æ–∂–µ—à –¥–∞ –∫–∞—á–∏—à —Å–Ω–∏–º–∫–∞ –æ—Ç –∫–∞–º–µ—Ä–∞—Ç–∞ –∏–ª–∏ –¥–∞ –∏–∑–±–µ—Ä–µ—à —Ñ–∞–π–ª
</div>
<form onsubmit="App.handleUploadDocumentFile(event,'${id}')">
<div class="form-group">
<label>–ò–∑–±–µ—Ä–∏ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–ø—Ä–∞–≤–∏ —Å–Ω–∏–º–∫–∞</label>
<input type="file" id="docFile" accept="image/*,application/pdf" capture="environment" required>
<div id="filePreview" style="margin-top:10px;text-align:center;min-height:50px"></div>
</div>
<button type="submit" class="btn">üìé –ü—Ä–∏–∫–∞—á–∏</button>
</form>
</div>
</div>`;

UI.modal(html);

setTimeout(()=>{
document.getElementById('docFile').onchange=function(e){
const file=e.target.files[0];
if(!file)return;

if(file.size>5*1024*1024){
UI.toast('‚ö†Ô∏è –§–∞–π–ª—ä—Ç –µ —Ç–≤—ä—Ä–¥–µ –≥–æ–ª—è–º! –ú–∞–∫—Å–∏–º—É–º 5MB');
this.value='';
return;
}

const preview=document.getElementById('filePreview');
const reader=new FileReader();
reader.onload=function(e){
if(file.type.startsWith('image/')){
preview.innerHTML=`<img src="${e.target.result}" style="max-width:100%;max-height:200px;border-radius:4px">`;
}else{
preview.innerHTML=`<div style="padding:20px;color:var(--gray6)">
<div style="font-size:36px">üìÑ</div>
<div>${file.name}</div>
<div style="font-size:12px;margin-top:5px">${(file.size/1024).toFixed(2)} KB</div>
</div>`;
}
};
reader.readAsDataURL(file);
};
},100);
},

handleUploadDocumentFile(e,id){
e.preventDefault();
const file=document.getElementById('docFile').files[0];
if(!file)return;

const reader=new FileReader();
reader.onload=function(e){
DS.update('documents',id,{
file:e.target.result,
fileName:file.name,
fileType:file.type,
fileSize:file.size,
uploadDate:new Date().toISOString().split('T')[0]
});

UI.closeModal();
UI.toast('‚úÖ –§–∞–π–ª –ø—Ä–∏–∫–∞—á–µ–Ω!');
App.viewDocument(id);
};
reader.readAsDataURL(file);
},

editDocument(id){
const d=DS.find('documents',id);
if(!d)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –¥–æ–∫—É–º–µ–Ω—Ç</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditDocument(event,'${id}')">
<div class="form-group">
<label>–ò–º–µ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç</label>
<input type="text" id="name" value="${d.name}" required>
</div>
<div class="form-group">
<label>–î–∞—Ç–∞</label>
<input type="date" id="date" value="${d.date}" required>
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes">${d.notes||''}</textarea>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditDocument(e,id){
e.preventDefault();
const updates={
name:document.getElementById('name').value,
date:document.getElementById('date').value,
notes:document.getElementById('notes').value
};

DS.update('documents',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.viewDocument(id);
},

changeDocumentStatus(id){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ü—Ä–æ–º–µ–Ω–∏ —Å—Ç–∞—Ç—É—Å</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<button class="btn" style="background:var(--orange)" onclick="App.updateDocumentStatus('${id}','pending')">‚è≥ –ß–∞–∫–∞—â</button>
<button class="btn" style="background:var(--blue)" onclick="App.updateDocumentStatus('${id}','issued')">‚úÖ –ò–∑–¥–∞–¥–µ–Ω</button>
<button class="btn btn-success" onclick="App.updateDocumentStatus('${id}','signed')">‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∞–Ω</button>
</div>
</div>`;

UI.modal(html);
},

updateDocumentStatus(id,status){
DS.update('documents',id,{status});
UI.closeModal();
UI.toast('‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–µ–Ω!');
this.viewDocument(id);
},

deleteDocument(id){
const d=DS.find('documents',id);
let warningMsg=`–ò–∑—Ç—Ä–∏–π –¥–æ–∫—É–º–µ–Ω—Ç: ${d.name}?`;

if(d.relatedType&&d.relatedId){
warningMsg+=`\n\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç –µ —Å–≤—ä—Ä–∑–∞–Ω —Å:\n${d.relatedType}: ${d.relatedId}`;
if(d.relatedType==='Order'){
const order=DS.find('orders',d.relatedId);
if(order){
warningMsg+=`\n(–ü–æ—Ä—ä—á–∫–∞ –Ω–∞ ${order.client})`;
}
}else if(d.relatedType==='Client'){
const client=DS.find('clients',d.relatedId);
if(client){
warningMsg+=`\n(–ö–ª–∏–µ–Ω—Ç: ${client.name})`;
}
}
}

if(d.fileData){
warningMsg+=`\n\nüìé –ò–º–∞ –ø—Ä–∏–∫–∞—á–µ–Ω —Ñ–∞–π–ª, –∫–æ–π—Ç–æ —â–µ —Å–µ –∏–∑—Ç—Ä–∏–µ!`;
}

UI.confirm(warningMsg,()=>{
DS.delete('documents',id);
UI.closeModal();
UI.toast('‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
},

renderContracts(){
let contracts=DS.d.contracts;
if(this.searchQuery){
contracts=contracts.filter(c=>
c.staffName.toLowerCase().includes(this.searchQuery.toLowerCase())||
c.position.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus!=='all'){
contracts=contracts.filter(c=>c.status===this.filterStatus);
}

return `<div class="header">
<div>
<div class="header-title">üìù –î–æ–≥–æ–≤–æ—Ä–∏</div>
<div class="header-subtitle">${contracts.length} –¥–æ–≥–æ–≤–æ—Ä–∞</div>
</div>
<button class="header-btn" onclick="App.addContract()">+ –ù–æ–≤</button>
</div>

<div class="container">
<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –¥–æ–≥–æ–≤–æ—Ä..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='active'?'active':''}" 
onclick="App.filterStatus='active';App.render()">–ê–∫—Ç–∏–≤–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='inactive'?'active':''}" 
onclick="App.filterStatus='inactive';App.render()">–ù–µ–∞–∫—Ç–∏–≤–Ω–∏</button>
</div>

<div class="section">
${contracts.length===0?UI.empty('üìù','–ù—è–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä'):contracts.map(c=>`
<div class="card" onclick="App.viewContract('${c.id}')">
<div class="card-header">
<div class="card-title">${c.staffName}</div>
<span class="badge badge-${c.status==='active'?'delivered':'cancelled'}">${c.status}</span>
</div>
<div class="card-body">
<strong>${c.position}</strong> ¬∑ ${c.type}<br>
üìÖ ${c.startDate} ${c.endDate?'‚Üí '+c.endDate:' (–±–µ–∑—Å—Ä–æ—á–µ–Ω)'}<br>
üí∞ ${c.salary} –ª–≤/–º–µ—Å–µ—Ü
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addContract(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤ –¥–æ–≥–æ–≤–æ—Ä</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddContract(event)">
<div class="form-group">
<label>–°–ª—É–∂–∏—Ç–µ–ª *</label>
<select id="staffId" required>
<option value="">–ò–∑–±–µ—Ä–∏ —Å–ª—É–∂–∏—Ç–µ–ª</option>
${DS.d.staff.map(s=>`<option value="${s.id}" data-position="${s.position}" data-salary="${s.salary}">${s.name} - ${s.position}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä *</label>
<select id="type" required>
<option value="–ë–µ–∑—Å—Ä–æ—á–µ–Ω">–ë–µ–∑—Å—Ä–æ—á–µ–Ω</option>
<option value="–°—Ä–æ—á–µ–Ω">–°—Ä–æ—á–µ–Ω</option>
<option value="–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–æ —Å–ø–æ—Ä–∞–∑—É–º–µ–Ω–∏–µ">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–æ —Å–ø–æ—Ä–∞–∑—É–º–µ–Ω–∏–µ</option>
</select>
</div>
<div class="form-group">
<label>–ù–∞—á–∞–ª–Ω–∞ –¥–∞—Ç–∞ *</label>
<input type="date" id="startDate" required value="${new Date().toISOString().split('T')[0]}">
</div>
<div class="form-group">
<label>–ö—Ä–∞–π–Ω–∞ –¥–∞—Ç–∞ (–ø—Ä–∏ —Å—Ä–æ—á–µ–Ω)</label>
<input type="date" id="endDate">
</div>
<div class="form-group">
<label>–ó–∞–ø–ª–∞—Ç–∞ (–ª–≤) *</label>
<input type="number" id="salary" required placeholder="2500">
</div>
<div class="form-group">
<label>–ü–æ–∑–∏—Ü–∏—è *</label>
<input type="text" id="position" required placeholder="–®–æ—Ñ—å–æ—Ä">
</div>
<button type="submit" class="btn">–°—ä–∑–¥–∞–π –¥–æ–≥–æ–≤–æ—Ä</button>
</form>
</div>
</div>`;
UI.modal(html);

setTimeout(()=>{
document.getElementById('staffId').onchange=function(){
const opt=this.options[this.selectedIndex];
document.getElementById('position').value=opt.getAttribute('data-position')||'';
document.getElementById('salary').value=opt.getAttribute('data-salary')||'';
};
},100);
},

handleAddContract(e){
e.preventDefault();
const staffId=document.getElementById('staffId').value;
const staff=DS.find('staff',staffId);
const contract={
staffId,
staffName:staff.name,
type:document.getElementById('type').value,
startDate:document.getElementById('startDate').value,
endDate:document.getElementById('endDate').value,
salary:Number(document.getElementById('salary').value),
position:document.getElementById('position').value,
status:'active'
};

DS.add('contracts',contract);
UI.closeModal();
UI.toast('‚úÖ –î–æ–≥–æ–≤–æ—Ä —Å—ä–∑–¥–∞–¥–µ–Ω!');
this.render();
},

viewContract(id){
const c=DS.find('contracts',id);
if(!c)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üìù –î–æ–≥–æ–≤–æ—Ä: ${c.staffName}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</div>
<div class="detail-row">
<div class="detail-label">–°–ª—É–∂–∏—Ç–µ–ª</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewStaff('${c.staffId}')">${c.staffName}</a></div>
</div>
<div class="detail-row">
<div class="detail-label">–¢–∏–ø</div>
<div class="detail-value">${c.type}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü–æ–∑–∏—Ü–∏—è</div>
<div class="detail-value">${c.position}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ù–∞—á–∞–ª–Ω–∞ –¥–∞—Ç–∞</div>
<div class="detail-value">${c.startDate}</div>
</div>
${c.endDate?`<div class="detail-row">
<div class="detail-label">–ö—Ä–∞–π–Ω–∞ –¥–∞—Ç–∞</div>
<div class="detail-value">${c.endDate}</div>
</div>`:''}
<div class="detail-row">
<div class="detail-label">–ó–∞–ø–ª–∞—Ç–∞</div>
<div class="detail-value">${c.salary} –ª–≤/–º–µ—Å–µ—Ü</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${c.status==='active'?'delivered':'cancelled'}">${c.status}</span></div>
</div>
</div>

<button class="btn" onclick="App.editContract('${c.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-secondary" onclick="App.terminateContract('${c.id}')">üî¥ –ü—Ä–µ–∫—Ä–∞—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä</button>
<button class="btn btn-danger" onclick="App.deleteContract('${c.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editContract(id){
const c=DS.find('contracts',id);
if(!c)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –¥–æ–≥–æ–≤–æ—Ä</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditContract(event,'${id}')">
<div class="form-group">
<label>–ó–∞–ø–ª–∞—Ç–∞ (–ª–≤)</label>
<input type="number" id="salary" value="${c.salary}" required>
</div>
<div class="form-group">
<label>–ü–æ–∑–∏—Ü–∏—è</label>
<input type="text" id="position" value="${c.position}" required>
</div>
<div class="form-group">
<label>–ö—Ä–∞–π–Ω–∞ –¥–∞—Ç–∞</label>
<input type="date" id="endDate" value="${c.endDate||''}">
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditContract(e,id){
e.preventDefault();
const updates={
salary:Number(document.getElementById('salary').value),
position:document.getElementById('position').value,
endDate:document.getElementById('endDate').value
};

DS.update('contracts',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.viewContract(id);
},

terminateContract(id){
if(confirm('–ü—Ä–µ–∫—Ä–∞—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä?')){
DS.update('contracts',id,{status:'inactive',endDate:new Date().toISOString().split('T')[0]});
UI.closeModal();
UI.toast('‚úÖ –î–æ–≥–æ–≤–æ—Ä –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω!');
this.render();
}
},

deleteContract(id){
UI.confirm('–ò–∑—Ç—Ä–∏–π –¥–æ–≥–æ–≤–æ—Ä?',()=>{
DS.delete('contracts',id);
UI.closeModal();
UI.toast('‚úÖ –î–æ–≥–æ–≤–æ—Ä –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
},
renderPayrolls(){
let payrolls=DS.d.payrolls;
if(this.searchQuery){
payrolls=payrolls.filter(p=>
p.staffName.toLowerCase().includes(this.searchQuery.toLowerCase())||
p.month.includes(this.searchQuery)
);
}
if(this.filterStatus!=='all'){
payrolls=payrolls.filter(p=>p.status===this.filterStatus);
}

const totalPending=payrolls.filter(p=>p.status==='pending').reduce((s,p)=>s+p.total,0);
const totalPaid=payrolls.filter(p=>p.status==='paid').reduce((s,p)=>s+p.total,0);

return `<div class="header">
<div>
<div class="header-title">üíµ –ó–∞–ø–ª–∞—Ç–∏</div>
<div class="header-subtitle">${payrolls.length} –∑–∞–ø–∏—Å–∞</div>
</div>
<button class="header-btn" onclick="App.addPayrollMultiple()">+ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button>
</div>

<div class="container">
${totalPending>0?`<div class="alert alert-warning">
‚ö†Ô∏è –ù–µ–ø–ª–∞—Ç–µ–Ω–∏ –∑–∞–ø–ª–∞—Ç–∏: <strong>${totalPending.toLocaleString()} –ª–≤</strong>
</div>`:''}

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –∑–∞–ø–ª–∞—Ç–∞..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='pending'?'active':''}" 
onclick="App.filterStatus='pending';App.render()">–ù–µ–ø–ª–∞—Ç–µ–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='paid'?'active':''}" 
onclick="App.filterStatus='paid';App.render()">–ü–ª–∞—Ç–µ–Ω–∏</button>
</div>

<div class="section">
${payrolls.length===0?UI.empty('üíµ','–ù—è–º–∞ –∑–∞–ø–ª–∞—Ç–∏','–ì–µ–Ω–µ—Ä–∏—Ä–∞–π—Ç–µ –∑–∞–ø–ª–∞—Ç–∏'):payrolls.sort((a,b)=>b.month.localeCompare(a.month)).map(p=>`
<div class="card" onclick="App.viewPayroll('${p.id}')">
<div class="card-header">
<div class="card-title">${p.staffName}</div>
<span class="badge badge-${p.status==='paid'?'delivered':'pending'}">${p.status}</span>
</div>
<div class="card-body">
üìÖ ${p.month}<br>
üí∞ –ë–∞–∑–æ–≤–∞: ${p.baseSalary} –ª–≤ ¬∑ –ò–∑–≤—ä–Ω—Ä–µ–¥–µ–Ω: ${p.overtime} –ª–≤ ¬∑ –ë–æ–Ω—É—Å: ${p.bonus} –ª–≤<br>
<strong>–û–±—â–æ: ${p.total} –ª–≤</strong>
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addPayrollMultiple(){
const currentMonth=new Date().toISOString().slice(0,7);
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –∑–∞–ø–ª–∞—Ç–∏</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddPayrollMultiple(event)">
<div class="form-group">
<label>–ú–µ—Å–µ—Ü *</label>
<input type="month" id="month" required value="${currentMonth}">
</div>
<div class="alert alert-info">
‚ÑπÔ∏è –©–µ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç –∑–∞–ø–ª–∞—Ç–∏ –∑–∞ –≤—Å–∏—á–∫–∏ –∞–∫—Ç–∏–≤–Ω–∏ —Å–ª—É–∂–∏—Ç–µ–ª–∏ —Å –±–∞–∑–æ–≤–∏—Ç–µ –∏–º –∑–∞–ø–ª–∞—Ç–∏.
</div>
<button type="submit" class="btn">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –∑–∞–ø–ª–∞—Ç–∏</button>
</form>
</div>
</div>`;
UI.modal(html);
},

handleAddPayrollMultiple(e){
e.preventDefault();
const month=document.getElementById('month').value;
const activeStaff=DS.d.staff.filter(s=>s.status==='active');

let count=0;
activeStaff.forEach(s=>{
const existing=DS.d.payrolls.find(p=>p.staffId===s.id&&p.month===month);
if(!existing){
const payroll={
staffId:s.id,
staffName:s.name,
month,
baseSalary:s.salary||0,
overtime:0,
bonus:0,
total:s.salary||0,
status:'pending'
};
DS.add('payrolls',payroll);
count++;
}
});

UI.closeModal();
UI.toast(`‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ ${count} –∑–∞–ø–ª–∞—Ç–∏!`);
this.render();
},

viewPayroll(id){
const p=DS.find('payrolls',id);
if(!p)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üíµ –ó–∞–ø–ª–∞—Ç–∞: ${p.staffName}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-title">–î–µ—Ç–∞–π–ª–∏ –∑–∞ –∑–∞–ø–ª–∞—Ç–∞</div>
<div class="detail-row">
<div class="detail-label">–°–ª—É–∂–∏—Ç–µ–ª</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewStaff('${p.staffId}')">${p.staffName}</a></div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–µ—Å–µ—Ü</div>
<div class="detail-value">${p.month}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ë–∞–∑–æ–≤–∞ –∑–∞–ø–ª–∞—Ç–∞</div>
<div class="detail-value">${p.baseSalary} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ò–∑–≤—ä–Ω—Ä–µ–¥–µ–Ω —Ç—Ä—É–¥</div>
<div class="detail-value">${p.overtime} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ë–æ–Ω—É—Å–∏</div>
<div class="detail-value">${p.bonus} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–û–±—â–æ</div>
<div class="detail-value" style="font-size:20px;font-weight:800;color:var(--green)">${p.total} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${p.status==='paid'?'delivered':'pending'}">${p.status}</span></div>
</div>
</div>

<button class="btn" onclick="App.editPayroll('${p.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
${p.status==='pending'?`<button class="btn btn-success" onclick="App.markPayrollPaid('${p.id}')">‚úÖ –ú–∞—Ä–∫–∏—Ä–∞–π –ø–ª–∞—Ç–µ–Ω–∞</button>`:''}
<button class="btn btn-danger" onclick="App.deletePayroll('${p.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

editPayroll(id){
const p=DS.find('payrolls',id);
if(!p)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –∑–∞–ø–ª–∞—Ç–∞</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditPayroll(event,'${id}')">
<div class="form-group">
<label>–ë–∞–∑–æ–≤–∞ –∑–∞–ø–ª–∞—Ç–∞ (–ª–≤)</label>
<input type="number" id="baseSalary" value="${p.baseSalary}" required oninput="App.calculatePayrollTotal()">
</div>
<div class="form-group">
<label>–ò–∑–≤—ä–Ω—Ä–µ–¥–µ–Ω —Ç—Ä—É–¥ (–ª–≤)</label>
<input type="number" id="overtime" value="${p.overtime}" oninput="App.calculatePayrollTotal()">
</div>
<div class="form-group">
<label>–ë–æ–Ω—É—Å–∏ (–ª–≤)</label>
<input type="number" id="bonus" value="${p.bonus}" oninput="App.calculatePayrollTotal()">
</div>
<div class="form-group">
<label>–û–±—â–æ (–ª–≤)</label>
<input type="number" id="total" value="${p.total}" readonly style="background:var(--green);color:white;font-weight:700">
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

calculatePayrollTotal(){
const base=Number(document.getElementById('baseSalary').value)||0;
const overtime=Number(document.getElementById('overtime').value)||0;
const bonus=Number(document.getElementById('bonus').value)||0;
document.getElementById('total').value=base+overtime+bonus;
},

handleEditPayroll(e,id){
e.preventDefault();
const updates={
baseSalary:Number(document.getElementById('baseSalary').value),
overtime:Number(document.getElementById('overtime').value),
bonus:Number(document.getElementById('bonus').value),
total:Number(document.getElementById('total').value)
};

DS.update('payrolls',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.viewPayroll(id);
},

markPayrollPaid(id){
const p=DS.find('payrolls',id);
UI.confirm(`–ú–∞—Ä–∫–∏—Ä–∞–π –∫–∞—Ç–æ –ø–ª–∞—Ç–µ–Ω–∞: ${p.staffName} - ${p.total} –ª–≤?`,()=>{
DS.update('payrolls',id,{status:'paid'});
const expense={
category:'–ó–∞–ø–ª–∞—Ç–∏',
description:`–ó–∞–ø–ª–∞—Ç–∞ ${p.staffName} - ${p.month}`,
amount:p.total,
method:'bank',
date:new Date().toISOString().split('T')[0],
approvedBy:Auth.user?.name||'Admin',
staffId:p.staffId,
payrollId:id
};
DS.add('expenses',expense);
UI.closeModal();
UI.toast('‚úÖ –ó–∞–ø–ª–∞—Ç–∞ –º–∞—Ä–∫–∏—Ä–∞–Ω–∞ –∫–∞—Ç–æ –ø–ª–∞—Ç–µ–Ω–∞!');
this.render();
});
},

deletePayroll(id){
const p=DS.find('payrolls',id);
const linkedExpense=DS.d.expenses.find(e=>e.payrollId===id);


let warningMsg=`–ò–∑—Ç—Ä–∏–π –∑–∞–ø–ª–∞—Ç–∞: ${p.staffName} - ${p.total} –ª–≤?`;
if(linkedExpense){
warningMsg+=`\n\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –©–µ —Å–µ –∏–∑—Ç—Ä–∏–µ –∏ —Å–≤—ä—Ä–∑–∞–Ω–∏—è—Ç —Ä–∞–∑—Ö–æ–¥ –æ—Ç ${linkedExpense.amount} –ª–≤!\n–¢–æ–≤–∞ —â–µ –ø—Ä–æ–º–µ–Ω–∏ –æ–±—â–∏—Ç–µ —Ä–∞–∑—Ö–æ–¥–∏.`;
}

UI.confirm(warningMsg,()=>{

const deletedPayroll=DS.delete('payrolls',id);

if(linkedExpense){
const deletedExpense=DS.delete('expenses',linkedExpense.id);
UI.toast('‚úÖ –ó–∞–ø–ª–∞—Ç–∞ –∏ —Å–≤—ä—Ä–∑–∞–Ω–∏—è—Ç —Ä–∞–∑—Ö–æ–¥ –∏–∑—Ç—Ä–∏—Ç–∏!');
}else{
UI.toast('‚úÖ –ó–∞–ø–ª–∞—Ç–∞ –∏–∑—Ç—Ä–∏—Ç–∞!');
}


UI.closeModal();
App.render();
});
},
renderLeaves(){
let leaves=DS.d.leaves;
if(this.searchQuery){
leaves=leaves.filter(l=>
l.staffName.toLowerCase().includes(this.searchQuery.toLowerCase())||
l.type.toLowerCase().includes(this.searchQuery.toLowerCase())
);
}
if(this.filterStatus!=='all'){
leaves=leaves.filter(l=>l.status===this.filterStatus);
}

const pending=leaves.filter(l=>l.status==='pending').length;

return `<div class="header">
<div>
<div class="header-title">üèñÔ∏è –û—Ç–ø—É—Å–∫–∏</div>
<div class="header-subtitle">${leaves.length} –∑–∞–ø–∏—Å–∞</div>
</div>
<button class="header-btn" onclick="App.addLeaveRequest()">+ –ù–æ–≤–∞</button>
</div>

<div class="container">
${pending>0?`<div class="alert alert-warning">
‚ö†Ô∏è ${pending} –∑–∞—è–≤–∫–∏ –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ
</div>`:''}

<div class="search-box">
<input type="text" class="search-input" placeholder="–¢—ä—Ä—Å–∏ –æ—Ç–ø—É—Å–∫..." 
value="${this.searchQuery}" 
oninput="App.searchQuery=this.value;App.render()">
</div>

<div class="filters">
<button class="filter-btn ${this.filterStatus==='all'?'active':''}" 
onclick="App.filterStatus='all';App.render()">–í—Å–∏—á–∫–∏</button>
<button class="filter-btn ${this.filterStatus==='pending'?'active':''}" 
onclick="App.filterStatus='pending';App.render()">–ß–∞–∫–∞—â–∏ (${pending})</button>
<button class="filter-btn ${this.filterStatus==='approved'?'active':''}" 
onclick="App.filterStatus='approved';App.render()">–û–¥–æ–±—Ä–µ–Ω–∏</button>
<button class="filter-btn ${this.filterStatus==='rejected'?'active':''}" 
onclick="App.filterStatus='rejected';App.render()">–û—Ç–∫–∞–∑–∞–Ω–∏</button>
</div>

<div class="section">
${leaves.length===0?UI.empty('üèñÔ∏è','–ù—è–º–∞ –æ—Ç–ø—É—Å–∫–∏','–î–æ–±–∞–≤–µ—Ç–µ –ø—ä—Ä–≤–∞—Ç–∞ –∑–∞—è–≤–∫–∞'):leaves.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate)).map(l=>`
<div class="card" onclick="App.viewLeave('${l.id}')">
<div class="card-header">
<div class="card-title">${l.staffName}</div>
<span class="badge badge-${l.status==='approved'?'delivered':l.status==='pending'?'pending':'cancelled'}">${l.status}</span>
</div>
<div class="card-body">
<strong>${l.type}</strong><br>
üìÖ ${l.startDate} ‚Üí ${l.endDate} (${l.days} –¥–Ω–∏)
${l.notes?'<br><em style="font-size:11px">'+l.notes+'</em>':''}
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

addLeaveRequest(){
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–ù–æ–≤–∞ –∑–∞—è–≤–∫–∞ –∑–∞ –æ—Ç–ø—É—Å–∫</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleAddLeaveRequest(event)">
<div class="form-group">
<label>–°–ª—É–∂–∏—Ç–µ–ª *</label>
<select id="staffId" required>
<option value="">–ò–∑–±–µ—Ä–∏ —Å–ª—É–∂–∏—Ç–µ–ª</option>
${DS.d.staff.filter(s=>s.status==='active').map(s=>`<option value="${s.id}">${s.name} - ${s.position}</option>`).join('')}
</select>
</div>
<div class="form-group">
<label>–¢–∏–ø –æ—Ç–ø—É—Å–∫ *</label>
<select id="type" required>
<option value="–ü–ª–∞—Ç–µ–Ω –æ—Ç–ø—É—Å–∫">–ü–ª–∞—Ç–µ–Ω –æ—Ç–ø—É—Å–∫</option>
<option value="–ë–æ–ª–Ω–∏—á–µ–Ω">–ë–æ–ª–Ω–∏—á–µ–Ω</option>
<option value="–ù–µ–ø–ª–∞—Ç–µ–Ω –æ—Ç–ø—É—Å–∫">–ù–µ–ø–ª–∞—Ç–µ–Ω –æ—Ç–ø—É—Å–∫</option>
<option value="–°–ª—É–∂–µ–±–Ω–∞ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞">–°–ª—É–∂–µ–±–Ω–∞ –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞</option>
</select>
</div>
<div class="form-group">
<label>–û—Ç –¥–∞—Ç–∞ *</label>
<input type="date" id="startDate" required onchange="App.calculateLeaveDays()">
</div>
<div class="form-group">
<label>–î–æ –¥–∞—Ç–∞ *</label>
<input type="date" id="endDate" required onchange="App.calculateLeaveDays()">
</div>
<div class="form-group">
<label>–ë—Ä–æ–π –¥–Ω–∏</label>
<input type="number" id="days" readonly style="background:var(--gray1)">
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes" placeholder="–ü—Ä–∏—á–∏–Ω–∞, –∫–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
</div>
<button type="submit" class="btn">–ü–æ–¥–∞–π –∑–∞—è–≤–∫–∞</button>
</form>
</div>
</div>`;
UI.modal(html);
},

calculateLeaveDays(){
const start=document.getElementById('startDate').value;
const end=document.getElementById('endDate').value;
if(start&&end){
const startDate=new Date(start);
const endDate=new Date(end);
const days=Math.ceil((endDate-startDate)/(24*60*60*1000))+1;
document.getElementById('days').value=Math.max(0,days);
}
},

handleAddLeaveRequest(e){
e.preventDefault();
const staffId=document.getElementById('staffId').value;
const staff=DS.find('staff',staffId);

const leave={
staffId,
staffName:staff.name,
type:document.getElementById('type').value,
startDate:document.getElementById('startDate').value,
endDate:document.getElementById('endDate').value,
days:Number(document.getElementById('days').value),
status:'pending',
notes:document.getElementById('notes').value
};

DS.add('leaves',leave);
UI.closeModal();
UI.toast('‚úÖ –ó–∞—è–≤–∫–∞ –ø–æ–¥–∞–¥–µ–Ω–∞!');
this.render();
},

viewLeave(id){
const l=DS.find('leaves',id);
if(!l)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">üèñÔ∏è –û—Ç–ø—É—Å–∫: ${l.staffName}</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<div class="detail-section">
<div class="detail-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –æ—Ç–ø—É—Å–∫–∞</div>
<div class="detail-row">
<div class="detail-label">–°–ª—É–∂–∏—Ç–µ–ª</div>
<div class="detail-value"><a href="#" onclick="event.preventDefault();App.viewStaff('${l.staffId}')">${l.staffName}</a></div>
</div>
<div class="detail-row">
<div class="detail-label">–¢–∏–ø</div>
<div class="detail-value">${l.type}</div>
</div>
<div class="detail-row">
<div class="detail-label">–û—Ç</div>
<div class="detail-value">${l.startDate}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–æ</div>
<div class="detail-value">${l.endDate}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ë—Ä–æ–π –¥–Ω–∏</div>
<div class="detail-value" style="font-size:18px;font-weight:700">${l.days}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-${l.status==='approved'?'delivered':l.status==='pending'?'pending':'cancelled'}">${l.status}</span></div>
</div>
${l.notes?`<div class="detail-row">
<div class="detail-label">–ó–∞–±–µ–ª–µ–∂–∫–∏</div>
<div class="detail-value">${l.notes}</div>
</div>`:''}
</div>

${l.status==='pending'?`
<button class="btn btn-success" onclick="App.approveLeave('${l.id}')">‚úÖ –û–¥–æ–±—Ä–∏</button>
<button class="btn btn-danger" onclick="App.rejectLeave('${l.id}')">‚ùå –û—Ç–∫–∞–∂–∏</button>
`:''}
<button class="btn" onclick="App.editLeave('${l.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<button class="btn btn-danger" onclick="App.deleteLeave('${l.id}')">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
</div>
</div>`;

UI.modal(html);
},

approveLeave(id){
const l=DS.find('leaves',id);
if(confirm(`–û–¥–æ–±—Ä–∏ –æ—Ç–ø—É—Å–∫ –∑–∞ ${l.staffName} (${l.days} –¥–Ω–∏)?`)){
DS.update('leaves',id,{status:'approved'});
UI.closeModal();
UI.toast('‚úÖ –û—Ç–ø—É—Å–∫ –æ–¥–æ–±—Ä–µ–Ω!');
this.render();
}
},

rejectLeave(id){
const l=DS.find('leaves',id);
if(confirm(`–û—Ç–∫–∞–∂–∏ –æ—Ç–ø—É—Å–∫ –∑–∞ ${l.staffName}?`)){
DS.update('leaves',id,{status:'rejected'});
UI.closeModal();
UI.toast('‚ùå –û—Ç–ø—É—Å–∫ –æ—Ç–∫–∞–∑–∞–Ω!');
this.render();
}
},

editLeave(id){
const l=DS.find('leaves',id);
if(!l)return;

const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –æ—Ç–ø—É—Å–∫</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditLeave(event,'${id}')">
<div class="form-group">
<label>–û—Ç –¥–∞—Ç–∞</label>
<input type="date" id="startDate" value="${l.startDate}" required onchange="App.calculateLeaveDays()">
</div>
<div class="form-group">
<label>–î–æ –¥–∞—Ç–∞</label>
<input type="date" id="endDate" value="${l.endDate}" required onchange="App.calculateLeaveDays()">
</div>
<div class="form-group">
<label>–ë—Ä–æ–π –¥–Ω–∏</label>
<input type="number" id="days" value="${l.days}" readonly style="background:var(--gray1)">
</div>
<div class="form-group">
<label>–ó–∞–±–µ–ª–µ–∂–∫–∏</label>
<textarea id="notes">${l.notes||''}</textarea>
</div>
<button type="submit" class="btn">–ó–∞–ø–∞–∑–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

handleEditLeave(e,id){
e.preventDefault();
const updates={
startDate:document.getElementById('startDate').value,
endDate:document.getElementById('endDate').value,
days:Number(document.getElementById('days').value),
notes:document.getElementById('notes').value
};

DS.update('leaves',id,updates);
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!');
this.viewLeave(id);
},

deleteLeave(id){
UI.confirm('–ò–∑—Ç—Ä–∏–π –æ—Ç–ø—É—Å–∫?',()=>{
DS.delete('leaves',id);
UI.closeModal();
UI.toast('‚úÖ –û—Ç–ø—É—Å–∫ –∏–∑—Ç—Ä–∏—Ç!');
App.render();
});
},
renderReports(){
const orders=DS.d.orders;
const revenue=DS.d.revenues.reduce((s,r)=>s+r.amount,0);
const expenses=DS.d.expenses.reduce((s,e)=>s+e.amount,0);
const profit=revenue-expenses;

return `<div class="header">
<div>
<div class="header-title">üìä –û—Ç—á–µ—Ç–∏</div>
<div class="header-subtitle">–ê–Ω–∞–ª–∏–∑ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>
</div>
</div>

<div class="container">
<div class="section">
<div class="section-title">üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤ –ø—Ä–µ–≥–ª–µ–¥</div>
<div class="detail-row">
<div class="detail-label">–ü—Ä–∏—Ö–æ–¥–∏</div>
<div class="detail-value" style="color:var(--green)">${revenue.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–†–∞–∑—Ö–æ–¥–∏</div>
<div class="detail-value" style="color:var(--red)">${expenses.toLocaleString()} –ª–≤</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü–µ—á–∞–ª–±–∞</div>
<div class="detail-value" style="color:${profit>=0?'var(--green)':'var(--red)'};font-size:18px;font-weight:800">${profit.toLocaleString()} –ª–≤</div>
</div>
</div>

<div class="section">
<div class="section-title">üì¶ –û–ø–µ—Ä–∞—Ü–∏–∏</div>
<div class="detail-row">
<div class="detail-label">–ü–æ—Ä—ä—á–∫–∏</div>
<div class="detail-value">${orders.length}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ö–ª–∏–µ–Ω—Ç–∏</div>
<div class="detail-value">${DS.d.clients.length}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–æ—Å—Ç–∞–≤—á–∏—Ü–∏</div>
<div class="detail-value">${DS.d.suppliers.length}</div>
</div>
</div>

<div class="section">
<div class="section-title">üöõ –†–µ—Å—É—Ä—Å–∏</div>
<div class="detail-row">
<div class="detail-label">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>
<div class="detail-value">${DS.d.vehicles.length}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü–µ—Ä—Å–æ–Ω–∞–ª</div>
<div class="detail-value">${DS.d.staff.length}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°–∫–ª–∞–¥–æ–≤–µ</div>
<div class="detail-value">${DS.d.warehouses.length}</div>
</div>
</div>
</div>

${this.renderNav()}`;
},

renderNotifications(){
const notifications=DS.d.notifications;
return `<div class="header">
<div>
<div class="header-title">üîî –ù–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
<div class="header-subtitle">${notifications.filter(n=>!n.read).length} –Ω–µ–ø—Ä–æ—á–µ—Ç–µ–Ω–∏</div>
</div>
${notifications.filter(n=>!n.read).length>0?`<button class="header-btn" onclick="App.markAllRead()">–ü—Ä–æ—á–µ—Ç–∏</button>`:''}
</div>

<div class="container">
<div class="section">
${notifications.length===0?UI.empty('üîî','–ù—è–º–∞ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏','–í—Å–∏—á–∫–æ –µ –Ω–∞—Ä–µ–¥'):notifications.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(n=>`
<div class="card" style="${!n.read?'border-left:4px solid var(--blue)':''}" onclick="App.markRead('${n.id}')">
<div class="card-header">
<div class="card-title">${n.type==='warning'?'‚ö†Ô∏è':n.type==='danger'?'üö®':n.type==='success'?'‚úÖ':'‚ÑπÔ∏è'} ${n.title}</div>
${!n.read?'<span class="badge badge-active">NEW</span>':''}
</div>
<div class="card-body">
${n.message}<br>
<small style="color:var(--gray6)">${new Date(n.date).toLocaleString('bg-BG')}</small>
</div>
</div>
`).join('')}
</div>
</div>

${this.renderNav()}`;
},

markRead(id){
DS.update('notifications',id,{read:true});
this.render();
},

markAllRead(){
DS.d.notifications.forEach(n=>n.read=true);
DS.save('notifications');
UI.toast('‚úÖ –í—Å–∏—á–∫–∏ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ—á–µ—Ç–µ–Ω–∏');
this.render();
},

renderCompany(){
const c=Auth.company||{};
return `<div class="header">
<div>
<div class="header-title">üè¢ –ú–æ—è—Ç–∞ –§–∏—Ä–º–∞</div>
<div class="header-subtitle">–ü—Ä–æ—Ñ–∏–ª –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</div>
</div>

<div class="container">
${c.logo?`<div class="section" style="text-align:center;">
<img src="${c.logo}" alt="Logo" style="max-width:200px;max-height:100px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
</div>`:''}

<div class="section">
<div class="section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ñ–∏—Ä–º–∞—Ç–∞</div>
<div class="detail-row">
<div class="detail-label">–ò–º–µ</div>
<div class="detail-value">${c.name||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ï–ò–ö</div>
<div class="detail-value">${c.eik||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–î–° ‚Ññ</div>
<div class="detail-value">${c.vat||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ú–û–õ</div>
<div class="detail-value">${c.mol||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ê–¥—Ä–µ—Å</div>
<div class="detail-value">${c.address||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
<div class="detail-value">${c.phone||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">Email</div>
<div class="detail-value">${c.email||'N/A'}</div>
</div>
</div>

<div class="section">
<div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div class="detail-row">
<div class="detail-label">–í–∞–ª—É—Ç–∞</div>
<div class="detail-value">${c.currency||'BGN'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ï–∑–∏–∫</div>
<div class="detail-value">${c.language||'bg'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–î–î–°</div>
<div class="detail-value">${c.vatEnabled?'–í–∫–ª—é—á–µ–Ω':'–ò–∑–∫–ª—é—á–µ–Ω'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–ü—Ä–µ—Ñ–∏–∫—Å —Ñ–∞–∫—Ç—É—Ä–∏</div>
<div class="detail-value">${c.invoicePrefix||'INV'}</div>
</div>
</div>

<button class="btn" onclick="App.editCompany()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–æ—Ñ–∏–ª</button>
</div>

${this.renderNav()}`;
},

editCompany(){
const c=Auth.company||{};
const html=`<div class="modal-content">
<div class="modal-header">
<div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–æ—Ñ–∏–ª –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞</div>
<button class="modal-close" onclick="UI.closeModal()">√ó</button>
</div>
<div class="modal-body">
<form onsubmit="App.handleEditCompany(event)">
<div class="form-group">
<label>–õ–æ–≥–æ –Ω–∞ —Ñ–∏—Ä–º–∞—Ç–∞</label>
<input type="file" id="logo" accept="image/*" onchange="App.previewCompanyLogo(event)">
<div id="logoPreview" style="margin-top:10px;text-align:center;">
${c.logo?`<img src="${c.logo}" style="max-width:200px;max-height:100px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">`:'<p style="color:var(--gray6);font-size:12px">–ù—è–º–∞ –∫–∞—á–µ–Ω–æ –ª–æ–≥–æ</p>'}
</div>
</div>

<div class="form-group">
<label>–ò–º–µ –Ω–∞ —Ñ–∏—Ä–º–∞ *</label>
<input type="text" id="name" required value="${c.name||''}" placeholder="–ú–æ—è—Ç–∞ –§–∏—Ä–º–∞ –û–û–î">
</div>

<div class="form-group">
<label>–ï–ò–ö *</label>
<input type="text" id="eik" required value="${c.eik||''}" placeholder="123456789">
</div>

<div class="form-group">
<label>–î–î–° ‚Ññ</label>
<input type="text" id="vat" value="${c.vat||''}" placeholder="BG123456789">
</div>

<div class="form-group">
<label>–ú–û–õ *</label>
<input type="text" id="mol" required value="${c.mol||''}" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
</div>

<div class="form-group">
<label>–ê–¥—Ä–µ—Å *</label>
<input type="text" id="address" required value="${c.address||''}" placeholder="–≥—Ä. –°–æ—Ñ–∏—è, —É–ª. –í–∏—Ç–æ—à–∞ 1">
</div>

<div class="form-group">
<label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
<input type="tel" id="phone" required value="${c.phone||''}" placeholder="+359 2 123 4567">
</div>

<div class="form-group">
<label>Email *</label>
<input type="email" id="email" required value="${c.email||''}" placeholder="office@company.bg">
</div>

<div class="form-group">
<label>–í–∞–ª—É—Ç–∞</label>
<select id="currency">
<option value="BGN" ${c.currency==='BGN'||!c.currency?'selected':''}>BGN (–ª–≤)</option>
<option value="EUR" ${c.currency==='EUR'?'selected':''}>EUR (‚Ç¨)</option>
<option value="USD" ${c.currency==='USD'?'selected':''}>USD ($)</option>
</select>
</div>

<div class="form-group">
<label>–ü—Ä–µ—Ñ–∏–∫—Å –∑–∞ —Ñ–∞–∫—Ç—É—Ä–∏</label>
<input type="text" id="invoicePrefix" value="${c.invoicePrefix||'INV'}" placeholder="INV">
</div>

<div class="form-group">
<label style="display:flex;align-items:center;gap:10px">
<input type="checkbox" id="vatEnabled" ${c.vatEnabled?'checked':''}>
–î–î–° —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (20%)
</label>
</div>

<button type="submit" class="btn">üíæ –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏</button>
</form>
</div>
</div>`;

UI.modal(html);
},

previewCompanyLogo(event){
const file=event.target.files[0];
if(!file)return;

if(file.size>2*1024*1024){
UI.toast('‚ö†Ô∏è –§–∞–π–ª—ä—Ç –µ —Ç–≤—ä—Ä–¥–µ –≥–æ–ª—è–º! –ú–∞–∫—Å–∏–º—É–º 2MB');
event.target.value='';
return;
}

const reader=new FileReader();
reader.onload=function(e){
const preview=document.getElementById('logoPreview');
preview.innerHTML=`<img src="${e.target.result}" style="max-width:200px;max-height:100px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)">`;
};
reader.readAsDataURL(file);
},

handleEditCompany(e){
e.preventDefault();

const fileInput=document.getElementById('logo');
const file=fileInput.files[0];

const saveCompanyData=(logoData)=>{
Auth.company={
name:document.getElementById('name').value,
eik:document.getElementById('eik').value,
vat:document.getElementById('vat').value,
mol:document.getElementById('mol').value,
address:document.getElementById('address').value,
phone:document.getElementById('phone').value,
email:document.getElementById('email').value,
currency:document.getElementById('currency').value,
invoicePrefix:document.getElementById('invoicePrefix').value,
vatEnabled:document.getElementById('vatEnabled').checked,
logo:logoData||Auth.company?.logo||null
};

localStorage.setItem('bfv4_company',JSON.stringify(Auth.company));
UI.closeModal();
UI.toast('‚úÖ –ü—Ä–æ—Ñ–∏–ª—ä—Ç –µ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω!');
this.render();
};

if(file){
const reader=new FileReader();
reader.onload=function(e){
saveCompanyData(e.target.result);
};
reader.readAsDataURL(file);
}else{
saveCompanyData();
}
},

renderSettings(){
return `<div class="header">
<div>
<div class="header-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div class="header-subtitle">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
</div>
</div>

<div class="container">
<div class="section">
<div class="section-title">–ü—Ä–æ—Ñ–∏–ª</div>
<div class="detail-row">
<div class="detail-label">Email</div>
<div class="detail-value">${Auth.user?.email||'N/A'}</div>
</div>
<div class="detail-row">
<div class="detail-label">–†–æ–ª—è</div>
<div class="detail-value">üëë ${Auth.user?.role||'N/A'}</div>
</div>
</div>

<div class="section">
<div class="section-title">Trial</div>
<div class="detail-row">
<div class="detail-label">–î–Ω–∏</div>
<div class="detail-value" style="font-size:24px;color:var(--green)">${Auth.trialDays()}</div>
</div>
</div>

<div class="section">
<div class="section-title">–í–µ—Ä—Å–∏—è</div>
<div class="detail-row">
<div class="detail-label">BuildFlow Pro</div>
<div class="detail-value" style="font-weight:700;color:var(--blue)">${Auth.version}</div>
</div>
<div class="detail-row">
<div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
<div class="detail-value"><span class="badge badge-delivered">Production Ready</span></div>
</div>
</div>

<div class="section">
<div class="section-title">üíæ –ë–µ–∫—ä–ø –∏ –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ</div>
<div style="padding:12px;background:rgba(0,122,255,0.1);border-radius:8px;margin-bottom:12px">
<div style="font-size:13px;color:var(--blue);margin-bottom:8px">
<strong>üì¶ –ü—ä–ª–µ–Ω –±–µ–∫—ä–ø</strong> - –∑–∞–ø–∞–∑–≤–∞ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ –≤ JSON —Ñ–∞–π–ª
</div>
<button class="btn" style="background:var(--blue);width:100%" onclick="App.createBackup()">
üíæ –°—ä–∑–¥–∞–π –±–µ–∫—ä–ø
</button>
</div>

<div style="padding:12px;background:rgba(52,199,89,0.1);border-radius:8px;margin-bottom:12px">
<div style="font-size:13px;color:var(--green);margin-bottom:8px">
<strong>üì• –í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ –æ—Ç –±–µ–∫—ä–ø</strong> - –∑–∞—Ä–µ–∂–¥–∞ –¥–∞–Ω–Ω–∏ –æ—Ç —Ñ–∞–π–ª
</div>
<input type="file" id="backupFile" accept=".json" style="display:none" onchange="App.restoreBackup(event)">
<button class="btn" style="background:var(--green);width:100%" onclick="document.getElementById('backupFile').click()">
üì• –í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ –±–µ–∫—ä–ø
</button>
</div>

<div style="padding:12px;background:rgba(255,149,0,0.1);border-radius:8px;margin-bottom:12px">
<div style="font-size:13px;color:var(--orange);margin-bottom:8px">
<strong>üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ</strong> - –ø—Ä–µ–º–µ—Å—Ç–∏ —Å—Ç–∞—Ä–∏—Ç–µ –¥–∞–Ω–Ω–∏ –≤ –∞—Ä—Ö–∏–≤
</div>
<button class="btn" style="background:var(--orange);width:100%" onclick="App.archiveOldData()">
üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–∞–π —Å—Ç–∞—Ä–∏ –¥–∞–Ω–Ω–∏
</button>
</div>
</div>

<div class="section">
<div class="section-title">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞ –∑–æ–Ω–∞</div>
<button class="btn btn-danger" onclick="App.clearData()">üóëÔ∏è –ò–∑—Ç—Ä–∏–π –í–°–ò–ß–ö–ò –¥–∞–Ω–Ω–∏</button>
</div>
</div>

${this.renderNav()}`;
},

exportData(){
const data={
version:Auth.version,
exportDate:new Date().toISOString(),
user:Auth.user,
company:Auth.company,
trial:Auth.trial,
...DS.d
};
const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download='buildflow-v4-backup-'+new Date().toISOString().split('T')[0]+'.json';
a.click();
UI.toast('‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –µ–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏!');
},

createBackup(){
// Count all records
const totalRecords=Object.keys(DS.d).reduce((sum,key)=>sum+(DS.d[key]?.length||0),0);

const data={
version:Auth.version,
backupDate:new Date().toISOString(),
user:Auth.user,
company:Auth.company,
trial:Auth.trial,
data:DS.d,
stats:{
totalRecords,
orders:DS.d.orders?.length||0,
clients:DS.d.clients?.length||0,
suppliers:DS.d.suppliers?.length||0,
staff:DS.d.staff?.length||0,
vehicles:DS.d.vehicles?.length||0
}
};

const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
const filename=`BuildFlow-Backup-${Auth.company?.name||'Company'}-${new Date().toISOString().split('T')[0]}.json`;
a.download=filename;
a.click();

UI.toast(`‚úÖ –ë–µ–∫—ä–ø —Å—ä–∑–¥–∞–¥–µ–Ω!\nüì¶ ${totalRecords} –∑–∞–ø–∏—Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏`);
},

restoreBackup(event){
const file=event.target.files[0];
if(!file)return;

UI.confirm(
`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ—Ç–æ —â–µ –∑–∞–º–µ–Ω–∏ –í–°–ò–ß–ö–ò —Ç–µ–∫—É—â–∏ –¥–∞–Ω–Ω–∏ —Å –¥–∞–Ω–Ω–∏—Ç–µ –æ—Ç –±–µ–∫—ä–ø–∞!\n\n–§–∞–π–ª: ${file.name}\n\n–ü—Ä–µ–ø–æ—Ä—ä—á–≤–∞–º–µ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—Ç–µ –±–µ–∫—ä–ø –Ω–∞ —Ç–µ–∫—É—â–∏—Ç–µ –¥–∞–Ω–Ω–∏ –ø—Ä–µ–¥–∏ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ.\n\n–ü—Ä–æ–¥—ä–ª–∂–∏?`,
()=>{
const reader=new FileReader();
reader.onload=(e)=>{
try{
const backup=JSON.parse(e.target.result);

// Validate backup structure
if(!backup.version||!backup.data){
UI.toast('‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω –±–µ–∫—ä–ø —Ñ–∞–π–ª!');
return;
}

// Restore data
if(backup.user)Auth.user=backup.user;
if(backup.company)Auth.company=backup.company;
if(backup.trial)Auth.trial=backup.trial;

// Restore all data modules
Object.keys(backup.data).forEach(key=>{
DS.d[key]=backup.data[key]||[];
});

DS.save();

UI.toast(`‚úÖ –ë–µ–∫—ä–ø –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–µ–Ω!\nüì¶ ${backup.stats?.totalRecords||'–ú–Ω–æ–≥–æ'} –∑–∞–ø–∏—Å–∞ –∑–∞—Ä–µ–¥–µ–Ω–∏`);

setTimeout(()=>{
location.reload();
},1500);

}catch(err){
UI.toast('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞!\n'+err.message);
console.error('Restore error:',err);
}
};
reader.readAsText(file);
}
);

// Reset file input
event.target.value='';
},

archiveOldData(){
const sixMonthsAgo=new Date();
sixMonthsAgo.setMonth(sixMonthsAgo.getMonth()-6);

// Find old orders
const oldOrders=DS.d.orders.filter(o=>{
const orderDate=new Date(o.date);
return orderDate<sixMonthsAgo&&o.status==='delivered';
});

// Find old deliveries
const oldDeliveries=DS.d.deliveries.filter(d=>{
const deliveryDate=new Date(d.date);
return deliveryDate<sixMonthsAgo&&d.status==='completed';
});

// Find old invoices
const oldInvoices=DS.d.invoices.filter(inv=>{
const invDate=new Date(inv.issueDate);
return invDate<sixMonthsAgo&&inv.status==='paid';
});

const totalArchivable=oldOrders.length+oldDeliveries.length+oldInvoices.length;

if(totalArchivable===0){
UI.toast('‚ÑπÔ∏è –ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –∞—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ!\n\n–í—Å–∏—á–∫–∏ –∑–∞–ø–∏—Å–∏ —Å–∞ –ø–æ-–Ω–æ–≤–∏ –æ—Ç 6 –º–µ—Å–µ—Ü–∞.');
return;
}

UI.confirm(
`üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä–∏ –¥–∞–Ω–Ω–∏\n\n–û—Ç–∫—Ä–∏—Ç–∏ ${totalArchivable} –∑–∞–ø–∏—Å–∞ —Å—Ç–∞—Ä—à–∏ –æ—Ç 6 –º–µ—Å–µ—Ü–∞:\n‚Ä¢ ${oldOrders.length} –¥–æ—Å—Ç–∞–≤–µ–Ω–∏ –ø–æ—Ä—ä—á–∫–∏\n‚Ä¢ ${oldDeliveries.length} –∑–∞–≤—ä—Ä—à–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏\n‚Ä¢ ${oldInvoices.length} –ø–ª–∞—Ç–µ–Ω–∏ —Ñ–∞–∫—Ç—É—Ä–∏\n\n–¢–µ–∑–∏ –∑–∞–ø–∏—Å–∏ —â–µ –±—ä–¥–∞—Ç –∑–∞–ø–∞–∑–µ–Ω–∏ –≤—ä–≤ —Ñ–∞–π–ª –∏ –∏–∑—Ç—Ä–∏—Ç–∏ –æ—Ç –±–∞–∑–∞—Ç–∞.\n\n–ü—Ä–æ–¥—ä–ª–∂–∏?`,
()=>{
// Create archive
const archive={
version:Auth.version,
archiveDate:new Date().toISOString(),
cutoffDate:sixMonthsAgo.toISOString(),
company:Auth.company?.name,
data:{
orders:oldOrders,
deliveries:oldDeliveries,
invoices:oldInvoices
},
stats:{
totalRecords:totalArchivable,
oldestRecord:Math.min(
...oldOrders.map(o=>new Date(o.date).getTime()),
...oldDeliveries.map(d=>new Date(d.date).getTime()),
...oldInvoices.map(i=>new Date(i.issueDate).getTime())
)
}
};

// Save archive file
const blob=new Blob([JSON.stringify(archive,null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`BuildFlow-Archive-${new Date().toISOString().split('T')[0]}.json`;
a.click();

// Remove archived records from database
oldOrders.forEach(o=>DS.delete('orders',o.id));
oldDeliveries.forEach(d=>DS.delete('deliveries',d.id));
oldInvoices.forEach(inv=>DS.delete('invoices',inv.id));

UI.toast(`‚úÖ –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ—Ç–æ –∑–∞–≤—ä—Ä—à–∏!\n\nüì¶ ${totalArchivable} –∑–∞–ø–∏—Å–∞ –∞—Ä—Ö–∏–≤–∏—Ä–∞–Ω–∏\nüóëÔ∏è –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∏–∑—Ç—Ä–∏—Ç–∏ –æ—Ç –±–∞–∑–∞—Ç–∞\nüíæ –ê—Ä—Ö–∏–≤ —Ñ–∞–π–ª –∑–∞–ø–∞–∑–µ–Ω`);

setTimeout(()=>{
this.render();
},2000);
}
);
},

clearData(){
UI.confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ —â–µ –±—ä–¥–∞—Ç –ü–ï–†–ú–ê–ù–ï–ù–¢–ù–û –∏–∑—Ç—Ä–∏—Ç–∏:\n‚Ä¢ –í—Å–∏—á–∫–∏ –ø–æ—Ä—ä—á–∫–∏\n‚Ä¢ –í—Å–∏—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–∏\n‚Ä¢ –í—Å–∏—á–∫–∏ –¥–æ—Å—Ç–∞–≤—á–∏—Ü–∏\n‚Ä¢ –í—Å–∏—á–∫–∏ —Å–ª—É–∂–∏—Ç–µ–ª–∏\n‚Ä¢ –í—Å–∏—á–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏\n‚Ä¢ –í–°–ò–ß–ö–ò –º–æ–¥—É–ª–∏\n\n–¢–∞–∑–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –µ –ù–ï–û–ë–†–ê–¢–ò–ú–ê!\n\n–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?',()=>{
UI.confirm('üî¥ –ü–û–°–õ–ï–î–ù–û –ü–û–¢–í–™–†–ñ–î–ï–ù–ò–ï!\n\n–ù–∞–∏—Å—Ç–∏–Ω–∞ –ª–∏ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à –í–°–ò–ß–ö–ò –¥–∞–Ω–Ω–∏?\n\n–°–ª–µ–¥ —Ç–æ–≤–∞ —â–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞—à –æ—Ç–Ω–æ–≤–æ.',()=>{
Auth.clearAllData();
UI.toast('üóëÔ∏è –í—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏ –∏–∑—Ç—Ä–∏—Ç–∏! –ü—Ä–µ–Ω–∞—Å–æ—á–≤–∞–Ω–µ...');
setTimeout(()=>{
location.reload();
},1500);
});
});
},

renderMore(){
return `<div class="header">
<div>
<div class="header-title">‚ãØ –û—â–µ</div>
<div class="header-subtitle">–î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ –º–æ–¥—É–ª–∏</div>
</div>
</div>

<div class="container">
<div class="section">
<div class="category-title">–°–∫–ª–∞–¥–æ–≤–µ</div>
<div class="menu" style="gap:8px">
<div class="menu-item" onclick="App.navigate('warehouses')">
<div class="menu-icon">üè≠</div>
<div class="menu-label">–°–∫–ª–∞–¥–æ–≤–µ</div>
</div>
<div class="menu-item" onclick="App.navigate('inventory')">
<div class="menu-icon">üì¶</div>
<div class="menu-label">–ò–Ω–≤–µ–Ω—Ç–∞—Ä</div>
</div>
<div class="menu-item" onclick="App.navigate('materials')">
<div class="menu-icon">üß±</div>
<div class="menu-label">–ú–∞—Ç–µ—Ä–∏–∞–ª–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('documents')">
<div class="menu-icon">üìÑ</div>
<div class="menu-label">–î–æ–∫—É–º–µ–Ω—Ç–∏</div>
</div>
</div>
</div>

<div class="section">
<div class="category-title">–°–∏—Å—Ç–µ–º–∞</div>
<div class="menu" style="gap:8px">
<div class="menu-item" onclick="App.navigate('company')">
<div class="menu-icon">üè¢</div>
<div class="menu-label">–ú–æ—è—Ç–∞ –§–∏—Ä–º–∞</div>
</div>
<div class="menu-item" onclick="App.navigate('reports')">
<div class="menu-icon">üìä</div>
<div class="menu-label">–û—Ç—á–µ—Ç–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('settings')">
<div class="menu-icon">‚öôÔ∏è</div>
<div class="menu-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
</div>
<div class="menu-item" onclick="App.navigate('notifications')">
<div class="menu-icon">üîî</div>
<div class="menu-label">–ù–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
</div>
</div>
</div>
</div>

${this.renderNav()}`;
},

renderNav(){
return `<div class="nav">
<div class="nav-item ${this.page==='dashboard'?'active':''}" onclick="App.navigate('dashboard')">
<div class="nav-icon">üè†</div>
<div class="nav-label">–ù–∞—á–∞–ª–æ</div>
</div>
<div class="nav-item ${this.page==='orders'?'active':''}" onclick="App.navigate('orders')">
<div class="nav-icon">üì¶</div>
<div class="nav-label">–ü–æ—Ä—ä—á–∫–∏</div>
</div>
<div class="nav-item ${['clients','suppliers'].includes(this.page)?'active':''}" onclick="App.navigate('clients')">
<div class="nav-icon">üë•</div>
<div class="nav-label">–ö–ª–∏–µ–Ω—Ç–∏</div>
</div>
<div class="nav-item ${['vehicles','staff'].includes(this.page)?'active':''}" onclick="App.navigate('vehicles')">
<div class="nav-icon">üöõ</div>
<div class="nav-label">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>
</div>
<div class="nav-item ${this.page==='more'?'active':''}" onclick="App.navigate('more')">
<div class="nav-icon">‚ãØ</div>
<div class="nav-label">–û—â–µ</div>
</div>
</div>`;
},

handleLogin(e){
e.preventDefault();
const email=document.getElementById('email').value;
const password=document.getElementById('password').value;

const result=Auth.login(email,password);
if(result.success){
Auth.init();
this.navigate(result.role==='DRIVER'?'driver-dashboard':'dashboard');
}else{
alert('‚ùå –ì—Ä–µ—à–µ–Ω email –∏–ª–∏ –ø–∞—Ä–æ–ª–∞');
}
},

handleRegister(e){
e.preventDefault();
const email=document.getElementById('email').value;
const password=document.getElementById('password').value;
const company=document.getElementById('company').value;

Auth.register(email,password,company);
UI.toast('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞ –µ —É—Å–ø–µ—à–Ω–∞!');
Auth.init();
this.navigate('dashboard');
}
};

document.addEventListener('DOMContentLoaded',()=>{
App.init();
GPSTracker.init();

// Auto-restore tracking if it was active
if(localStorage.getItem('gps_tracking_active')==='true'){
console.log('üîÑ Restoring GPS tracking...');
setTimeout(()=>GPSTracker.startTracking(),2000);
}
});
</script>
</body>
</html>
